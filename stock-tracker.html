<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>US Stock Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0b0f19; --surface: #131a2b; --surface2: #1b2540; --surface3: #243054;
  --border: #2d3a5c; --text: #e2e8f4; --text2: #7b8bb5; --text3: #4e5f8a;
  --accent: #4a8eff; --accent2: #3672d9; --accentBg: rgba(74,142,255,.08);
  --samsung: #2962ff; --samsungBg: rgba(41,98,255,.1);
  --kiwoom: #e63962; --kiwoomBg: rgba(230,57,98,.1);
  --buy: #00c853; --buyBg: rgba(0,200,83,.1);
  --sell: #ff5252; --sellBg: rgba(255,82,82,.1);
  --warn: #ffc107; --radius: 12px;
  --shadow: 0 2px 12px rgba(0,0,0,.3);
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Noto Sans KR',system-ui,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
.mono { font-family:'JetBrains Mono',monospace; }

/* Layout */
.app { max-width:960px; margin:0 auto; padding:12px; }
.header { display:flex; align-items:center; gap:12px; padding:16px 4px 12px; }
.logo { width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--samsung),var(--kiwoom));display:flex;align-items:center;justify-content:center;font-size:18px; }
.header h1 { font-size:18px; font-weight:700; letter-spacing:-.3px; }
.header .sub { font-size:11px; color:var(--text2); }

/* Nav */
nav { display:flex; gap:3px; background:var(--surface); border-radius:var(--radius); padding:3px; margin-bottom:16px; overflow-x:auto; }
nav button { flex:0 0 auto; padding:9px 16px; border:none; background:none; color:var(--text2); border-radius:9px; cursor:pointer; font:500 13px/1 'Noto Sans KR',sans-serif; white-space:nowrap; transition:all .15s; }
nav button.on { background:var(--accent); color:#fff; }
nav button:hover:not(.on) { background:var(--surface2); color:var(--text); }
nav .badge { display:inline-block; min-width:18px; height:18px; line-height:18px; text-align:center; border-radius:9px; background:var(--accent); color:#fff; font-size:10px; margin-left:4px; font-weight:700; }

/* Panels */
.panel { display:none; } .panel.on { display:block; }

/* Card */
.card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:16px; margin-bottom:14px; }
.card-hdr { font-size:13px; font-weight:600; margin-bottom:10px; display:flex; align-items:center; gap:7px; }
.card-hdr .ico { font-size:16px; }

/* Inputs */
input[type=text],input[type=password],input[type=number],select,textarea {
  width:100%; padding:9px 12px; background:var(--surface2); border:1px solid var(--border);
  border-radius:8px; color:var(--text); font:13px/1.4 'Noto Sans KR',sans-serif; transition:border .15s;
}
input:focus,select:focus,textarea:focus { outline:none; border-color:var(--accent); }
textarea { resize:vertical; min-height:80px; font-family:'JetBrains Mono',monospace; font-size:11px; }
label.f { display:block; margin-bottom:10px; }
label.f > span { display:block; font-size:11px; color:var(--text2); margin-bottom:3px; font-weight:500; }
.g2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.g3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
.g4 { display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:10px; }

/* Buttons */
.btn { display:inline-flex; align-items:center; gap:5px; padding:10px 18px; border-radius:8px; border:none; font:500 13px/1 'Noto Sans KR',sans-serif; cursor:pointer; transition:all .12s; }
.btn-p { background:var(--accent); color:#fff; } .btn-p:hover { background:var(--accent2); }
.btn-p:disabled { opacity:.35; cursor:not-allowed; }
.btn-s { background:var(--surface2); color:var(--text); border:1px solid var(--border); } .btn-s:hover { border-color:var(--accent); }
.btn-d { background:#c62828; color:#fff; } .btn-d:hover { background:#b71c1c; }
.btn-sm { padding:7px 12px; font-size:12px; }
.btn-full { width:100%; justify-content:center; }
.btn-row { display:flex; gap:8px; flex-wrap:wrap; }

/* Upload */
.drop { border:2px dashed var(--border); border-radius:var(--radius); padding:28px; text-align:center; cursor:pointer; transition:all .2s; }
.drop:hover,.drop.over { border-color:var(--accent); background:var(--accentBg); }
.drop input { display:none; }
.drop .ico { font-size:32px; margin-bottom:6px; }
.drop p { color:var(--text2); font-size:12px; }
.thumbs { display:flex; flex-wrap:wrap; gap:6px; margin-top:10px; }
.thumb { position:relative; width:64px; height:64px; border-radius:8px; overflow:hidden; border:2px solid var(--border); }
.thumb img { width:100%; height:100%; object-fit:cover; }
.thumb .x { position:absolute; top:1px; right:1px; width:18px; height:18px; border-radius:50%; background:rgba(0,0,0,.75); color:#fff; border:none; cursor:pointer; font-size:11px; line-height:18px; text-align:center; }
.thumb .tag { position:absolute; bottom:1px; left:1px; padding:1px 5px; border-radius:3px; font-size:8px; font-weight:700; color:#fff; }
.tag.ss { background:var(--samsung); } .tag.kw { background:var(--kiwoom); }

/* Table */
.tbl-wrap { overflow-x:auto; -webkit-overflow-scrolling:touch; }
table.t { width:100%; border-collapse:collapse; font:12px/1.3 'JetBrains Mono',monospace; }
table.t th { background:var(--surface2); padding:7px 8px; text-align:left; font-weight:500; color:var(--text2); border-bottom:1px solid var(--border); white-space:nowrap; position:sticky; top:0; z-index:1; }
table.t td { padding:6px 8px; border-bottom:1px solid var(--border); white-space:nowrap; }
table.t tr:hover td { background:var(--accentBg); }
.c-buy { color:var(--buy); } .c-sell { color:var(--sell); }
.c-ss { color:var(--samsung); } .c-kw { color:var(--kiwoom); }

/* Date group */
.dg { background:var(--surface2); padding:8px 12px; border-radius:8px; margin:12px 0 6px; display:flex; align-items:center; justify-content:space-between; }
.dg .l { font-weight:600; font-size:13px; } .dg .r { font-size:11px; color:var(--text2); }

/* Progress & Log */
.prog { height:3px; background:var(--surface2); border-radius:2px; overflow:hidden; margin:10px 0; }
.prog .bar { height:100%; background:var(--accent); border-radius:2px; transition:width .3s; width:0; }
.log { max-height:130px; overflow-y:auto; background:var(--surface2); border-radius:8px; padding:8px; margin-top:8px; font:11px/1.5 'JetBrains Mono',monospace; color:var(--text2); }
.log .ok { color:var(--buy); } .log .err { color:var(--sell); } .log .warn { color:var(--warn); }

/* Status */
.status { display:inline-flex; align-items:center; gap:5px; padding:4px 10px; border-radius:6px; font-size:11px; font-weight:500; }
.status.ok { background:rgba(0,200,83,.1); color:var(--buy); }
.status.no { background:rgba(255,82,82,.1); color:var(--sell); }
.status.wait { background:rgba(255,193,7,.1); color:var(--warn); }

/* Toast */
.toast { position:fixed; bottom:16px; left:50%; transform:translateX(-50%); padding:10px 18px; border-radius:8px; font-size:12px; font-weight:500; z-index:999; opacity:0; transition:opacity .25s; pointer-events:none; }
.toast.show { opacity:1; } .toast.ok { background:#1b5e20; color:#a5d6a7; } .toast.err { background:#b71c1c; color:#ef9a9a; }

/* Setup steps */
.step { counter-increment:step; padding-left:32px; position:relative; margin-bottom:16px; }
.step::before { content:counter(step); position:absolute; left:0; top:0; width:22px; height:22px; border-radius:50%; background:var(--accent); color:#fff; font-size:11px; font-weight:700; line-height:22px; text-align:center; }
.step h3 { font-size:13px; font-weight:600; margin-bottom:4px; }
.step p { font-size:12px; color:var(--text2); line-height:1.5; }
.step code { background:var(--surface2); padding:1px 5px; border-radius:3px; font-size:11px; font-family:'JetBrains Mono',monospace; }
.steps { counter-reset:step; }

/* Broker card */
.bk-card { border-left:3px solid; padding-left:12px; }
.bk-card.ss { border-color:var(--samsung); } .bk-card.kw { border-color:var(--kiwoom); }

@media(max-width:640px) {
  .g2,.g3,.g4 { grid-template-columns:1fr; }
  table.t { font-size:11px; }
  table.t th,table.t td { padding:5px 5px; }
  nav button { padding:8px 12px; font-size:12px; }
}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="logo">ğŸ“Š</div>
    <div><h1>US Stock Tracker</h1><div class="sub">ì‚¼ì„± / í‚¤ì›€ â†’ Google Sheets</div></div>
  </div>

  <nav id="nav">
    <button class="on" data-p="setup">âš™ï¸ ì„¤ì •</button>
    <button data-p="extract">ğŸ“¸ ì¶”ì¶œ</button>
    <button data-p="manual">âœï¸ ì…ë ¥</button>
    <button data-p="data">ğŸ“‹ ë°ì´í„° <span class="badge" id="badge" style="display:none">0</span></button>
  </nav>

  <!-- ==================== SETUP ==================== -->
  <div id="p-setup" class="panel on">
    <div class="card">
      <div class="card-hdr"><span class="ico">ğŸ“¡</span> ì—°ê²° ìƒíƒœ</div>
      <div class="g3" style="margin-bottom:12px">
        <div>Google Sheets: <span class="status no" id="st-gs">ë¯¸ì—°ê²°</span></div>
        <div>Claude API: <span class="status no" id="st-ai">ë¯¸ì—°ê²°</span></div>
        <div>Sheet ID: <span class="status no" id="st-sid">ì—†ìŒ</span></div>
      </div>
    </div>

    <div class="card">
      <div class="card-hdr"><span class="ico">ğŸ“˜</span> Google Sheets ì„¤ì • ê°€ì´ë“œ</div>
      <div class="steps">
        <div class="step">
          <h3>Google Cloud í”„ë¡œì íŠ¸ ìƒì„±</h3>
          <p><a href="https://console.cloud.google.com/projectcreate" target="_blank" style="color:var(--accent)">console.cloud.google.com</a> â†’ ìƒˆ í”„ë¡œì íŠ¸ ìƒì„± (ì´ë¦„: ì•„ë¬´ê±°ë‚˜)</p>
        </div>
        <div class="step">
          <h3>Google Sheets API í™œì„±í™”</h3>
          <p><a href="https://console.cloud.google.com/apis/library/sheets.googleapis.com" target="_blank" style="color:var(--accent)">Sheets API í˜ì´ì§€</a> â†’ "ì‚¬ìš©" í´ë¦­</p>
        </div>
        <div class="step">
          <h3>ì„œë¹„ìŠ¤ ê³„ì • ìƒì„±</h3>
          <p><a href="https://console.cloud.google.com/iam-admin/serviceaccounts/create" target="_blank" style="color:var(--accent)">ì„œë¹„ìŠ¤ ê³„ì • ìƒì„±</a> â†’ ì´ë¦„ ì…ë ¥ â†’ "ì™„ë£Œ".<br>
          ìƒì„±ëœ ê³„ì • í´ë¦­ â†’ "í‚¤" íƒ­ â†’ "í‚¤ ì¶”ê°€" â†’ "JSON" â†’ íŒŒì¼ ë‹¤ìš´ë¡œë“œ</p>
        </div>
        <div class="step">
          <h3>Google Sheet ì¤€ë¹„</h3>
          <p>ìƒˆ Google Sheet ìƒì„± â†’ ì‹œíŠ¸ ì´ë¦„ì„ <code>ì‚¼ì„±</code>, <code>í‚¤ì›€</code>ìœ¼ë¡œ ë³€ê²½.<br>
          ê° ì‹œíŠ¸ 1í–‰: (ë¹ˆì¹¸) | (ë¹ˆì¹¸) | (ë¹ˆì¹¸) | (ë¹ˆì¹¸) | tax | total | split | seq<br>
          Sheet URLì—ì„œ ID ë³µì‚¬ (docs.google.com/spreadsheets/d/<b style="color:var(--accent)">[ì´ ë¶€ë¶„]</b>/edit)</p>
        </div>
        <div class="step">
          <h3>ì‹œíŠ¸ ê³µìœ </h3>
          <p>ë‹¤ìš´ë°›ì€ JSONì—ì„œ <code>client_email</code> ê°’ ë³µì‚¬ â†’ Sheet "ê³µìœ " â†’ í•´ë‹¹ ì´ë©”ì¼ì— "í¸ì§‘ì" ê¶Œí•œ ë¶€ì—¬</p>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-hdr"><span class="ico">ğŸ”‘</span> ì„œë¹„ìŠ¤ ê³„ì • í‚¤ (JSON)</div>
      <textarea id="saKey" placeholder='ë‹¤ìš´ë¡œë“œí•œ JSON íŒŒì¼ì˜ ì „ì²´ ë‚´ìš©ì„ ë¶™ì—¬ë„£ê¸°...'></textarea>
      <div style="margin-top:8px">
        <button class="btn btn-p btn-sm" onclick="saveSA()">ì €ì¥</button>
        <span style="font-size:11px;color:var(--text2);margin-left:8px">ë¡œì»¬ ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤</span>
      </div>
    </div>

    <div class="card">
      <div class="card-hdr"><span class="ico">ğŸ“„</span> Google Sheet ID</div>
      <div class="g2">
        <label class="f"><span>Sheet ID</span>
          <input type="text" id="sheetId" placeholder="1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgVE2upms" />
        </label>
        <div style="display:flex;align-items:flex-end;gap:6px">
          <button class="btn btn-p btn-sm" onclick="saveSheetId()">ì €ì¥</button>
          <button class="btn btn-s btn-sm" onclick="testConnection()">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-hdr"><span class="ico">ğŸ¤–</span> Claude API Key</div>
      <div style="display:flex;gap:8px">
        <input type="password" id="claudeKey" placeholder="sk-ant-api03-..." />
        <button class="btn btn-s btn-sm" onclick="toggleVis('claudeKey')">í‘œì‹œ</button>
        <button class="btn btn-p btn-sm" onclick="saveClaudeKey()">ì €ì¥</button>
      </div>
      <p style="font-size:11px;color:var(--text2);margin-top:6px">PNG â†’ AI ì¶”ì¶œì— í•„ìš”. ìˆ˜ë™ ì…ë ¥ë§Œ í•  ê²½ìš° ë¶ˆí•„ìš”.</p>
    </div>
  </div>

  <!-- ==================== EXTRACT ==================== -->
  <div id="p-extract" class="panel">
    <div class="card">
      <div class="card-hdr"><span class="ico">ğŸ“¸</span> ìŠ¤í¬ë¦°ìƒ· ì—…ë¡œë“œ</div>
      <div class="drop" id="drop">
        <input type="file" id="fileIn" accept="image/*" multiple />
        <div class="ico">ğŸ“±</div>
        <p>í´ë¦­ ë˜ëŠ” ë“œë˜ê·¸í•˜ì—¬ ìŠ¤í¬ë¦°ìƒ· ì—…ë¡œë“œ</p>
        <p style="font-size:10px;margin-top:2px">ë‹¹ì¼ì²´ê²°/ì „ì²´ ë˜ëŠ” ì¼ë³„ì£¼ë¬¸ë‚´ì—­ ìº¡ì³</p>
      </div>
      <div class="thumbs" id="thumbs"></div>
    </div>
    <button class="btn btn-p btn-full" id="extBtn" onclick="doExtract()" disabled>ğŸš€ AI ì¶”ì¶œ â†’ Google Sheets ì €ì¥</button>
    <div id="extProg" style="display:none">
      <div class="prog"><div class="bar" id="extBar"></div></div>
      <div class="log" id="extLog"></div>
    </div>
  </div>

  <!-- ==================== MANUAL ==================== -->
  <div id="p-manual" class="panel">
    <div class="card">
      <div class="card-hdr"><span class="ico">âœï¸</span> ìˆ˜ë™ ê±°ë˜ ì…ë ¥</div>
      <div class="g2">
        <label class="f"><span>ì¦ê¶Œì‚¬</span><select id="mBk"><option value="ì‚¼ì„±">ì‚¼ì„± (0.03%)</option><option value="í‚¤ì›€">í‚¤ì›€ (0.07%)</option></select></label>
        <label class="f"><span>ë‚ ì§œ (YYMMDD)</span><input type="text" id="mDt" placeholder="260212" maxlength="6"/></label>
      </div>
      <div class="g4">
        <label class="f"><span>ì¢…ëª©</span><input type="text" id="mTk" placeholder="AAPL" style="text-transform:uppercase"/></label>
        <label class="f"><span>ë§¤ë§¤</span><select id="mSd"><option value="buy">ë§¤ìˆ˜</option><option value="sell">ë§¤ë„</option></select></label>
        <label class="f"><span>ìˆ˜ëŸ‰</span><input type="number" id="mQt" placeholder="1" min="1"/></label>
        <label class="f"><span>ì²´ê²°ë‹¨ê°€</span><input type="number" id="mPr" placeholder="150.00" step="0.0001"/></label>
      </div>
      <button class="btn btn-p btn-full" onclick="addManual()">â• ì¶”ê°€ â†’ Google Sheets ì €ì¥</button>
    </div>
  </div>

  <!-- ==================== DATA ==================== -->
  <div id="p-data" class="panel">
    <div class="btn-row" style="margin-bottom:12px">
      <button class="btn btn-s btn-sm" onclick="loadFromSheet()">ğŸ”„ ì‹œíŠ¸ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button class="btn btn-s btn-sm" onclick="downloadXlsx()">ğŸ“¥ xlsx ë‹¤ìš´ë¡œë“œ</button>
      <button class="btn btn-d btn-sm" onclick="clearLocal()">ğŸ—‘ ë¡œì»¬ ì´ˆê¸°í™”</button>
    </div>
    <div id="dataView"><p style="color:var(--text2);text-align:center;padding:32px">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ "ì‹œíŠ¸ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°"ë¥¼ í´ë¦­í•˜ì„¸ìš”</p></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Google Auth via jsrsasign for JWT signing -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/11.1.0/jsrsasign-all-min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// ================ CONFIG ================
const TAX = { 'ì‚¼ì„±': 0.0003, 'í‚¤ì›€': 0.0007 };
const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
let SA_KEY = null;   // service account JSON
let SHEET_ID = '';
let CLAUDE_KEY = '';
let gToken = null;
let gTokenExp = 0;
let files = [];
let localTx = { 'ì‚¼ì„±': [], 'í‚¤ì›€': [] };

// ================ INIT ================
document.addEventListener('DOMContentLoaded', () => {
  // Nav
  document.querySelectorAll('nav button').forEach(b => b.addEventListener('click', () => {
    document.querySelectorAll('nav button').forEach(x => x.classList.remove('on'));
    document.querySelectorAll('.panel').forEach(x => x.classList.remove('on'));
    b.classList.add('on');
    document.getElementById('p-' + b.dataset.p).classList.add('on');
  }));
  // Drop zone
  const drop = document.getElementById('drop');
  drop.addEventListener('click', () => document.getElementById('fileIn').click());
  drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('over'); });
  drop.addEventListener('dragleave', () => drop.classList.remove('over'));
  drop.addEventListener('drop', e => { e.preventDefault(); drop.classList.remove('over'); handleFiles(e.dataTransfer.files); });
  document.getElementById('fileIn').addEventListener('change', e => handleFiles(e.target.files));
  // Load saved config
  loadConfig();
});

// ================ CONFIG PERSISTENCE ================
function loadConfig() {
  try {
    const sa = localStorage.getItem('sa_key');
    if (sa) { SA_KEY = JSON.parse(sa); document.getElementById('saKey').value = sa; updateStatus('st-gs', 'ok', 'í‚¤ ì €ì¥ë¨'); }
    const sid = localStorage.getItem('sheet_id');
    if (sid) { SHEET_ID = sid; document.getElementById('sheetId').value = sid; updateStatus('st-sid', 'ok', sid.slice(0,8)+'...'); }
    const ck = localStorage.getItem('claude_key');
    if (ck) { CLAUDE_KEY = ck; document.getElementById('claudeKey').value = ck; updateStatus('st-ai', 'ok', 'ì €ì¥ë¨'); }
  } catch(e) {}
}
function saveSA() {
  try {
    const raw = document.getElementById('saKey').value.trim();
    SA_KEY = JSON.parse(raw);
    localStorage.setItem('sa_key', raw);
    updateStatus('st-gs', 'ok', 'í‚¤ ì €ì¥ë¨');
    toast('ì„œë¹„ìŠ¤ ê³„ì • í‚¤ ì €ì¥ ì™„ë£Œ', 'ok');
  } catch(e) { toast('JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤', 'err'); }
}
function saveSheetId() {
  SHEET_ID = document.getElementById('sheetId').value.trim();
  localStorage.setItem('sheet_id', SHEET_ID);
  updateStatus('st-sid', 'ok', SHEET_ID.slice(0,8)+'...');
  toast('Sheet ID ì €ì¥ ì™„ë£Œ', 'ok');
}
function saveClaudeKey() {
  CLAUDE_KEY = document.getElementById('claudeKey').value.trim();
  localStorage.setItem('claude_key', CLAUDE_KEY);
  updateStatus('st-ai', 'ok', 'ì €ì¥ë¨');
  toast('Claude API Key ì €ì¥ ì™„ë£Œ', 'ok');
}
function toggleVis(id) { const el = document.getElementById(id); el.type = el.type === 'password' ? 'text' : 'password'; }
function updateStatus(id, cls, txt) {
  const el = document.getElementById(id);
  el.className = 'status ' + cls;
  el.textContent = txt;
}

// ================ GOOGLE AUTH (JWT) ================
async function getAccessToken() {
  if (gToken && Date.now() / 1000 < gTokenExp - 60) return gToken;
  if (!SA_KEY) throw new Error('ì„œë¹„ìŠ¤ ê³„ì • í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤');

  const now = Math.floor(Date.now() / 1000);
  const exp = now + 3600;
  const header = { alg: 'RS256', typ: 'JWT' };
  const payload = {
    iss: SA_KEY.client_email,
    scope: SCOPES,
    aud: 'https://oauth2.googleapis.com/token',
    iat: now,
    exp: exp
  };

  const sHeader = JSON.stringify(header);
  const sPayload = JSON.stringify(payload);
  const sJWT = KJUR.jws.JWS.sign('RS256', sHeader, sPayload, SA_KEY.private_key);

  const resp = await fetch('https://oauth2.googleapis.com/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=${sJWT}`
  });

  if (!resp.ok) {
    const err = await resp.json().catch(() => ({}));
    throw new Error('Google Auth ì‹¤íŒ¨: ' + (err.error_description || resp.status));
  }

  const data = await resp.json();
  gToken = data.access_token;
  gTokenExp = exp;
  return gToken;
}

// ================ SHEETS API ================
async function sheetsGet(range) {
  const token = await getAccessToken();
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(range)}`;
  const resp = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
  if (!resp.ok) throw new Error('ì‹œíŠ¸ ì½ê¸° ì‹¤íŒ¨: ' + resp.status);
  return resp.json();
}

async function sheetsAppend(sheet, values) {
  const token = await getAccessToken();
  const range = `${sheet}!A:H`;
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(range)}:append?valueInputOption=USER_ENTERED&insertDataOption=INSERT_ROWS`;
  const resp = await fetch(url, {
    method: 'POST',
    headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
    body: JSON.stringify({ range, majorDimension: 'ROWS', values })
  });
  if (!resp.ok) throw new Error('ì‹œíŠ¸ ì“°ê¸° ì‹¤íŒ¨: ' + resp.status);
  return resp.json();
}

async function sheetsInsertAtTop(sheet, values) {
  // Strategy: read all, prepend, clear, write back
  const token = await getAccessToken();
  const range = `${sheet}!A:H`;

  // Read existing
  let existing = [];
  try {
    const data = await sheetsGet(`${sheet}!A:H`);
    existing = data.values || [];
  } catch(e) {}

  // Header is row 0, data starts row 1
  const header = existing.length > 0 ? existing[0] : ['', '', '', '', 'tax', 'total', 'split', 'seq'];
  const oldData = existing.slice(1);

  const newAll = [header, ...values, ...oldData];

  // Clear and write
  const clearUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(range)}:clear`;
  await fetch(clearUrl, { method: 'POST', headers: { Authorization: `Bearer ${token}` } });

  const writeUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(range)}?valueInputOption=USER_ENTERED`;
  const resp = await fetch(writeUrl, {
    method: 'PUT',
    headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
    body: JSON.stringify({ range, majorDimension: 'ROWS', values: newAll })
  });
  if (!resp.ok) throw new Error('ì‹œíŠ¸ ì“°ê¸° ì‹¤íŒ¨: ' + resp.status);
  return resp.json();
}

async function testConnection() {
  try {
    updateStatus('st-gs', 'wait', 'í…ŒìŠ¤íŠ¸ ì¤‘...');
    const data = await sheetsGet('ì‚¼ì„±!A1:H1');
    updateStatus('st-gs', 'ok', 'ì—°ê²° ì„±ê³µ âœ“');
    toast('Google Sheets ì—°ê²° ì„±ê³µ!', 'ok');
  } catch(e) {
    updateStatus('st-gs', 'no', 'ì‹¤íŒ¨');
    toast(e.message, 'err');
  }
}

// ================ FILE HANDLING ================
function handleFiles(fileList) {
  for (const f of fileList) {
    if (!f.type.startsWith('image/')) continue;
    const reader = new FileReader();
    reader.onload = ev => {
      files.push({ file: f, dataUrl: ev.target.result, broker: null });
      renderThumbs();
      document.getElementById('extBtn').disabled = false;
    };
    reader.readAsDataURL(f);
  }
}

function renderThumbs() {
  document.getElementById('thumbs').innerHTML = files.map((f, i) => `
    <div class="thumb">
      <img src="${f.dataUrl}"/>
      <button class="x" onclick="files.splice(${i},1);renderThumbs();document.getElementById('extBtn').disabled=!files.length">Ã—</button>
      ${f.broker ? `<span class="tag ${f.broker==='ì‚¼ì„±'?'ss':'kw'}">${f.broker}</span>` : ''}
    </div>`).join('');
}

// ================ AI EXTRACTION ================
async function doExtract() {
  if (!CLAUDE_KEY) { toast('Claude API Keyë¥¼ ì„¤ì •í•˜ì„¸ìš”', 'err'); return; }
  if (!SHEET_ID || !SA_KEY) { toast('Google Sheets ì„¤ì •ì„ ì™„ë£Œí•˜ì„¸ìš”', 'err'); return; }

  const btn = document.getElementById('extBtn');
  btn.disabled = true; btn.textContent = 'â³ ì¶”ì¶œ ì¤‘...';
  const prog = document.getElementById('extProg'); prog.style.display = 'block';
  const logEl = document.getElementById('extLog'); logEl.innerHTML = '';
  const bar = document.getElementById('extBar'); bar.style.width = '0';

  // Collect all extracted transactions grouped by broker+date
  const allTx = {};
  let done = 0;

  for (let i = 0; i < files.length; i++) {
    const f = files[i];
    addLog(logEl, `ì²˜ë¦¬ ì¤‘ (${i+1}/${files.length}): ${f.file.name}...`);

    try {
      const base64 = f.dataUrl.split(',')[1];
      const result = await callClaude(base64, f.file.type || 'image/png');
      f.broker = result.broker;

      const key = `${result.broker}_${result.date}`;
      if (!allTx[key]) allTx[key] = { broker: result.broker, date: result.date, items: [] };

      for (const tx of result.transactions) {
        // Dedup
        const isDup = allTx[key].items.some(e =>
          e.ticker === tx.ticker && e.qty === tx.qty && e.price === tx.price &&
          ((result.broker === 'ì‚¼ì„±' && e.time && tx.time && e.time === tx.time) ||
           (result.broker === 'í‚¤ì›€' && e.order_number && tx.order_number && e.order_number === tx.order_number))
        );
        if (!isDup) allTx[key].items.push(tx);
      }

      addLog(logEl, `âœ… ${result.broker} ${result.date}: ${result.transactions.length}ê±´ ê°ì§€`, 'ok');
    } catch(e) {
      addLog(logEl, `âŒ ${f.file.name}: ${e.message}`, 'err');
    }
    done++;
    bar.style.width = (done / files.length * 100) + '%';
  }

  // Write to sheets
  for (const [key, group] of Object.entries(allTx)) {
    const { broker, date, items } = group;
    const rate = TAX[broker];

    // Assign seq by display order
    const rows = items.map((tx, i) => {
      const qty = tx.side === 'sell' ? -Math.abs(tx.qty) : Math.abs(tx.qty);
      const tax = rd(Math.abs(qty) * tx.price * rate);
      const total = rd(Math.abs(qty) * tx.price + tax);
      return [i === 0 ? parseInt(date) : '', tx.ticker, qty, tx.price, tax, total, '', i + 1];
    });

    try {
      await sheetsInsertAtTop(broker, rows);
      addLog(logEl, `ğŸ“ ${broker} ${date}: ${rows.length}ê±´ ì €ì¥ ì™„ë£Œ`, 'ok');
    } catch(e) {
      addLog(logEl, `âŒ ${broker} ì €ì¥ ì‹¤íŒ¨: ${e.message}`, 'err');
    }
  }

  renderThumbs();
  btn.textContent = 'ğŸš€ AI ì¶”ì¶œ â†’ Google Sheets ì €ì¥';
  btn.disabled = !files.length;
  updateBadge();
  toast('ì¶”ì¶œ ì™„ë£Œ!', 'ok');
}

async function callClaude(base64, mediaType) {
  const resp = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': CLAUDE_KEY,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true'
    },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 2000,
      messages: [{ role: 'user', content: [
        { type: 'image', source: { type: 'base64', media_type: mediaType, data: base64 } },
        { type: 'text', text: `Korean stock brokerage screenshot. Extract ALL visible transactions.

Brokerage ID: Dark blue/navy top = "ì‚¼ì„±", White/light top = "í‚¤ì›€"
Date format: YYMMDD (e.g. 260212 for 2026-02-12)

For each transaction extract:
- ticker: stock symbol (e.g. AAPL, not AAPL.OQ)
- side: "buy" if ë§¤ìˆ˜/ì •ì •(ë§¤ìˆ˜), "sell" if ë§¤ë„/ì •ì •(ë§¤ë„)
- qty: executed quantity (ì²´ê²°ìˆ˜ëŸ‰)
- price: executed price (ì²´ê²°ë‹¨ê°€)
- time: order time if visible (ì£¼ë¬¸ì‹œê°„, format HH:MM:SS)
- order_number: ì£¼ë¬¸ë²ˆí˜¸ if visible

IMPORTANT: List transactions in EXACT order shown on screen (top to bottom). This order IS the sequence.

Respond ONLY with JSON, no other text:
{"broker":"ì‚¼ì„±","date":"260212","transactions":[{"ticker":"XXX","side":"buy","qty":1,"price":123.45,"time":"22:27:01","order_number":""}]}` }
      ]}]
    })
  });

  if (!resp.ok) {
    const err = await resp.json().catch(() => ({}));
    throw new Error(err.error?.message || `HTTP ${resp.status}`);
  }

  const data = await resp.json();
  const text = data.content.map(c => c.text || '').join('');
  const m = text.match(/\{[\s\S]*\}/);
  if (!m) throw new Error('JSON íŒŒì‹± ì‹¤íŒ¨');
  return JSON.parse(m[0]);
}

// ================ MANUAL ENTRY ================
async function addManual() {
  const broker = document.getElementById('mBk').value;
  const date = document.getElementById('mDt').value.trim();
  const ticker = document.getElementById('mTk').value.trim().toUpperCase();
  const side = document.getElementById('mSd').value;
  const qtyRaw = parseInt(document.getElementById('mQt').value);
  const price = parseFloat(document.getElementById('mPr').value);

  if (!date || !ticker || !qtyRaw || !price) { toast('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”', 'err'); return; }
  if (!SHEET_ID || !SA_KEY) { toast('Google Sheets ì„¤ì •ì„ ì™„ë£Œí•˜ì„¸ìš”', 'err'); return; }

  const qty = side === 'sell' ? -Math.abs(qtyRaw) : Math.abs(qtyRaw);
  const rate = TAX[broker];
  const tax = rd(Math.abs(qty) * price * rate);
  const total = rd(Math.abs(qty) * price + tax);

  // Read existing to determine seq
  try {
    const data = await sheetsGet(`${broker}!A:H`);
    const rows = data.values || [];
    let seq = 1;
    // Find if same date exists
    for (let i = 1; i < rows.length; i++) {
      if (String(rows[i][0]) === date || (rows[i][0] === '' && i > 0)) {
        // Same date group - find max seq
        const s = parseInt(rows[i][7]) || 0;
        if (s >= seq) seq = s + 1;
        if (rows[i][0] === date) continue;
        if (rows[i][0] !== '' && rows[i][0] !== date) break;
      }
    }

    const row = [parseInt(date), ticker, qty, price, tax, total, '', seq];

    // Check if this date already exists at top
    const firstDate = rows.length > 1 ? String(rows[1][0]) : '';
    if (firstDate === date || firstDate === '') {
      // Append to existing date group (need smarter insertion)
      // For simplicity, insert at top
      row[0] = ''; // not first of date
    }

    await sheetsInsertAtTop(broker, [row]);
    toast(`${ticker} ${side === 'buy' ? 'ë§¤ìˆ˜' : 'ë§¤ë„'} ì €ì¥ ì™„ë£Œ`, 'ok');

    document.getElementById('mTk').value = '';
    document.getElementById('mQt').value = '';
    document.getElementById('mPr').value = '';
  } catch(e) {
    toast('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'err');
  }
}

// ================ DATA VIEW ================
async function loadFromSheet() {
  if (!SHEET_ID || !SA_KEY) { toast('Google Sheets ì„¤ì •ì„ ì™„ë£Œí•˜ì„¸ìš”', 'err'); return; }

  try {
    const view = document.getElementById('dataView');
    view.innerHTML = '<p style="color:var(--text2);text-align:center;padding:16px">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';

    let html = '';
    for (const broker of ['ì‚¼ì„±', 'í‚¤ì›€']) {
      const data = await sheetsGet(`${broker}!A:H`);
      const rows = data.values || [];
      if (rows.length <= 1) continue;

      const bClass = broker === 'ì‚¼ì„±' ? 'ss' : 'kw';
      html += `<div class="card bk-card ${bClass}">`;
      html += `<div class="card-hdr"><span class="ico">${broker === 'ì‚¼ì„±' ? 'ğŸ”µ' : 'ğŸ”´'}</span>${broker} (${rows.length - 1}ê±´)</div>`;

      // Group by date
      let currentDate = '';
      let dateRows = [];

      for (let i = 1; i < rows.length; i++) {
        const r = rows[i];
        if (r[0] && r[0] !== '') currentDate = r[0];
        dateRows.push({ date: currentDate, row: r });
      }

      // Get unique dates
      const dates = [...new Set(dateRows.map(d => d.date))];

      for (const date of dates.slice(0, 20)) { // Show latest 20 dates
        const drs = dateRows.filter(d => d.date === date);
        const buys = drs.filter(d => parseFloat(d.row[2]) > 0).length;
        const sells = drs.filter(d => parseFloat(d.row[2]) < 0).length;

        html += `<div class="dg"><span class="l">${fmtDate(date)}</span><span class="r">ë§¤ìˆ˜ ${buys} / ë§¤ë„ ${sells} / ${drs.length}ê±´</span></div>`;
        html += `<div class="tbl-wrap"><table class="t"><tr><th>seq</th><th>ì¢…ëª©</th><th>ìˆ˜ëŸ‰</th><th>ë‹¨ê°€</th><th>tax</th><th>total</th></tr>`;

        for (const d of drs) {
          const r = d.row;
          const qty = parseFloat(r[2]) || 0;
          const cls = qty > 0 ? 'c-buy' : 'c-sell';
          html += `<tr><td>${r[7]||''}</td><td><b>${r[1]||''}</b></td><td class="${cls}">${qty > 0 ? '+' : ''}${qty}</td><td>${parseFloat(r[3])?.toFixed(4)||''}</td><td>${r[4]||''}</td><td>${r[5]||''}</td></tr>`;
        }
        html += '</table></div>';
      }

      if (dates.length > 20) html += `<p style="color:var(--text2);font-size:11px;margin-top:8px">... ì™¸ ${dates.length - 20}ì¼ ë”</p>`;
      html += '</div>';
    }

    view.innerHTML = html || '<p style="color:var(--text2);text-align:center;padding:32px">ì‹œíŠ¸ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
    updateBadge();
  } catch(e) {
    toast('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + e.message, 'err');
  }
}

async function downloadXlsx() {
  if (!SHEET_ID || !SA_KEY) { toast('Google Sheets ì„¤ì •ì„ ì™„ë£Œí•˜ì„¸ìš”', 'err'); return; }

  try {
    const wb = XLSX.utils.book_new();
    for (const broker of ['ì‚¼ì„±', 'í‚¤ì›€']) {
      const data = await sheetsGet(`${broker}!A:H`);
      const rows = data.values || [];
      const ws = XLSX.utils.aoa_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb, ws, broker);
    }
    const today = new Date().toISOString().slice(0,10).replace(/-/g,'');
    XLSX.writeFile(wb, `ë¯¸êµ­ì£¼ì‹ë‚´ì—­_${today}.xlsx`);
    toast('xlsx ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'ok');
  } catch(e) { toast('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ' + e.message, 'err'); }
}

function clearLocal() {
  if (!confirm('ë¡œì»¬ ì €ì¥ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(Google Sheet ë°ì´í„°ëŠ” ìœ ì§€ë©ë‹ˆë‹¤)')) return;
  localStorage.clear();
  SA_KEY = null; SHEET_ID = ''; CLAUDE_KEY = ''; gToken = null;
  document.getElementById('saKey').value = '';
  document.getElementById('sheetId').value = '';
  document.getElementById('claudeKey').value = '';
  updateStatus('st-gs', 'no', 'ë¯¸ì—°ê²°');
  updateStatus('st-ai', 'no', 'ë¯¸ì—°ê²°');
  updateStatus('st-sid', 'no', 'ì—†ìŒ');
  toast('ë¡œì»¬ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ', 'ok');
}

// ================ HELPERS ================
function rd(n) { return Math.round(n * 100) / 100; }
function fmtDate(d) {
  d = String(d);
  if (d.length === 6) return `20${d.slice(0,2)}-${d.slice(2,4)}-${d.slice(4,6)}`;
  return d;
}
function addLog(el, msg, cls='') {
  const d = document.createElement('div');
  d.className = cls;
  d.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  el.appendChild(d);
  el.scrollTop = el.scrollHeight;
}
function toast(msg, type='ok') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = `toast ${type} show`;
  setTimeout(() => el.classList.remove('show'), 2800);
}
async function updateBadge() {
  try {
    let total = 0;
    for (const b of ['ì‚¼ì„±', 'í‚¤ì›€']) {
      const d = await sheetsGet(`${b}!A:A`);
      total += (d.values?.length || 1) - 1;
    }
    const badge = document.getElementById('badge');
    if (total > 0) { badge.style.display = ''; badge.textContent = total; }
    else badge.style.display = 'none';
  } catch(e) {}
}
</script>
</body>
</html>
