<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Sunghoon's Portfolio Manager</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/11.1.0/jsrsasign-all-min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root {
  --bg:#0b0f19;--surface:#131a2b;--surface2:#1b2540;--surface3:#243054;
  --border:#2d3a5c;--text:#e2e8f4;--text2:#7b8bb5;--text3:#4e5f8a;
  --accent:#4a8eff;--accent2:#3672d9;--accentBg:rgba(74,142,255,.08);
  --samsung:#2962ff;--kiwoom:#e63962;
  --buy:#c62828;--buyBg:rgba(198,40,40,.1);
  --sell:#1565c0;--sellBg:rgba(21,101,192,.1);
  --warn:#ffc107;--radius:12px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Sans KR',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.app{max-width:960px;margin:0 auto;padding:12px}
.header{display:flex;align-items:center;gap:12px;padding:16px 4px 12px}
.logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--samsung),var(--kiwoom));display:flex;align-items:center;justify-content:center;font-size:18px}
.header h1{font-size:18px;font-weight:700;letter-spacing:-.3px}
.header .sub{font-size:11px;color:var(--text2)}
nav{display:flex;gap:3px;background:var(--surface);border-radius:var(--radius);padding:3px;margin-bottom:16px;overflow-x:auto}
nav button{flex:0 0 auto;padding:9px 16px;border:none;background:none;color:var(--text2);border-radius:9px;cursor:pointer;font:500 13px/1 'Noto Sans KR',sans-serif;white-space:nowrap;transition:all .15s}
nav button.on{background:var(--accent);color:#fff}
nav button:hover:not(.on){background:var(--surface2);color:var(--text)}
.panel{display:none}.panel.on{display:block}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:14px}
.card-hdr{font-size:13px;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:7px}
.card-hdr .ico{font-size:16px}
input[type=text],input[type=password],input[type=number],select,textarea{width:100%;padding:9px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font:13px/1.4 'Noto Sans KR',sans-serif;transition:border .15s}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent)}
textarea{resize:vertical;min-height:80px;font-family:'JetBrains Mono',monospace;font-size:11px}
label.f{display:block;margin-bottom:10px}
label.f>span{display:block;font-size:11px;color:var(--text2);margin-bottom:3px;font-weight:500}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.g4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px}
.btn{display:inline-flex;align-items:center;gap:5px;padding:10px 18px;border-radius:8px;border:none;font:500 13px/1 'Noto Sans KR',sans-serif;cursor:pointer;transition:all .12s}
.btn-p{background:var(--accent);color:#fff}.btn-p:hover{background:var(--accent2)}
.btn-p:disabled{opacity:.35;cursor:not-allowed}
.btn-s{background:var(--surface2);color:var(--text);border:1px solid var(--border)}.btn-s:hover{border-color:var(--accent)}
.btn-d{background:#c62828;color:#fff}
.btn-sm{padding:7px 12px;font-size:12px}
.btn-full{width:100%;justify-content:center}
.btn-row{display:flex;gap:8px;flex-wrap:wrap}
.drop{border:2px dashed var(--border);border-radius:var(--radius);padding:28px;text-align:center;cursor:pointer;transition:all .2s}
.drop:hover,.drop.over{border-color:var(--accent);background:var(--accentBg)}
.drop input{display:none}
.drop .ico{font-size:32px;margin-bottom:6px}
.drop p{color:var(--text2);font-size:12px}
.thumbs{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}
.thumb{position:relative;width:64px;height:64px;border-radius:8px;overflow:hidden;border:2px solid var(--border)}
.thumb img{width:100%;height:100%;object-fit:cover}
.thumb .x{position:absolute;top:1px;right:1px;width:18px;height:18px;border-radius:50%;background:rgba(0,0,0,.75);color:#fff;border:none;cursor:pointer;font-size:11px;line-height:18px;text-align:center}
.tbl-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
table.t{width:100%;border-collapse:collapse;font:12px/1.3 'JetBrains Mono',monospace}
table.t th{background:var(--surface2);padding:7px 8px;text-align:left;font-weight:500;color:var(--text2);border-bottom:1px solid var(--border);white-space:nowrap;position:sticky;top:0;z-index:1}
table.t td{padding:6px 8px;border-bottom:1px solid var(--border);white-space:nowrap}
table.t tr:hover td{background:var(--accentBg)}
.c-buy{color:var(--buy)}.c-sell{color:var(--sell)}
.c-up{color:var(--buy)}.c-dn{color:var(--sell)}.c-flat{color:var(--text2)}
.dg{background:var(--surface2);padding:8px 12px;border-radius:8px;margin:12px 0 6px;display:flex;align-items:center;justify-content:space-between}
.dg .l{font-weight:600;font-size:13px}.dg .r{font-size:11px;color:var(--text2)}
.prog{height:3px;background:var(--surface2);border-radius:2px;overflow:hidden;margin:10px 0}
.prog .bar{height:100%;background:var(--accent);border-radius:2px;transition:width .3s;width:0}
.log{max-height:130px;overflow-y:auto;background:var(--surface2);border-radius:8px;padding:8px;margin-top:8px;font:11px/1.5 'JetBrains Mono',monospace;color:var(--text2)}
.log .ok{color:var(--buy)}.log .err{color:var(--sell)}.log .warn{color:var(--warn)}
.status{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:500}
.status.ok{background:rgba(0,200,83,.1);color:var(--buy)}
.status.no{background:rgba(255,82,82,.1);color:var(--sell)}
.status.wait{background:rgba(255,193,7,.1);color:var(--warn)}
.toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);padding:10px 18px;border-radius:8px;font-size:12px;font-weight:500;z-index:999;opacity:0;transition:opacity .25s;pointer-events:none}
.toast.show{opacity:1}.toast.ok{background:#1b5e20;color:#a5d6a7}.toast.err{background:#b71c1c;color:#ef9a9a}
.steps{counter-reset:step}
.step{counter-increment:step;padding-left:32px;position:relative;margin-bottom:16px}
.step::before{content:counter(step);position:absolute;left:0;top:0;width:22px;height:22px;border-radius:50%;background:var(--accent);color:#fff;font-size:11px;font-weight:700;line-height:22px;text-align:center}
.step h3{font-size:13px;font-weight:600;margin-bottom:4px}
.step p{font-size:12px;color:var(--text2);line-height:1.5}
.step code{background:var(--surface2);padding:1px 5px;border-radius:3px;font-size:11px;font-family:'JetBrains Mono',monospace}
.bk-card{border-left:3px solid;padding-left:12px}
.bk-card.ss{border-color:var(--samsung)}.bk-card.kw{border-color:var(--kiwoom)}

/* Overview cards */
.summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
.sum-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px}
.sum-card .label{font-size:11px;color:var(--text2);margin-bottom:4px}
.sum-card .value{font-size:20px;font-weight:700;font-family:'JetBrains Mono',monospace}
.sum-card .sub{font-size:11px;color:var(--text2);margin-top:2px;font-family:'JetBrains Mono',monospace}
.sum-card .value.up{color:var(--buy)}.sum-card .value.dn{color:var(--sell)}

/* Filter buttons */
.filter-btns{display:flex;gap:4px}
.fbtn{padding:7px 14px;border:1px solid var(--border);background:none;color:var(--text2);border-radius:8px;cursor:pointer;font:500 12px/1 'Noto Sans KR',sans-serif;transition:all .15s}
.fbtn.on{background:var(--accent);color:#fff;border-color:var(--accent)}
.fbtn:hover:not(.on){background:var(--surface2);color:var(--text)}

/* Holdings header - sticky */
.hold-hdr{display:grid;grid-template-columns:2.5fr 1fr 1.2fr 1.2fr 1.2fr 0.8fr;gap:2px;font-size:10px;color:var(--text3);padding:6px 12px;background:var(--bg);position:sticky;top:0;z-index:2;border-bottom:1px solid var(--border);margin-bottom:4px}
.hold-hdr div{display:flex;flex-direction:column;gap:2px}
.hold-hdr div:last-child{margin-left:16px}

/* Holdings card v2 */
.hold-row{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px;margin-bottom:8px;cursor:pointer;transition:border-color .15s}
.hold-row:hover{border-color:var(--accent)}
.hold-top{display:grid;grid-template-columns:2.5fr 1fr 1.2fr 1.2fr 1.2fr 0.8fr;gap:2px;align-items:baseline;margin-bottom:6px}
.hold-ticker{font-size:15px;font-weight:700;color:var(--text3);font-family:'JetBrains Mono',monospace}
.hold-qty{font-size:12px;color:var(--text2);text-align:right;grid-column:4/7}
.hold-fiscal{font-size:11px;color:var(--text3);font-family:'JetBrains Mono',monospace}
.hold-grid{display:grid;grid-template-columns:2.5fr 1fr 1.2fr 1.2fr 1.2fr 0.8fr;gap:2px;font-size:11px}
.hold-grid .lbl{color:var(--text3);font-size:10px}
.hold-grid .val{font-family:'JetBrains Mono',monospace;font-size:12px}
.hold-grid>div:last-child{margin-left:16px}
/* Closed positions toggle */
.closed-open .closed-cards{display:block!important}
.closed-open .closed-arrow{transform:rotate(90deg)}
/* Chart controls */
.chart-grp{display:flex;gap:2px}
.cbtn{padding:4px 10px;border:1px solid var(--border);background:none;color:var(--text3);border-radius:5px;cursor:pointer;font:500 11px 'Noto Sans KR',sans-serif;transition:all .15s}
.cbtn.on{background:var(--accent);color:#fff;border-color:var(--accent)}
.cbtn:hover:not(.on){background:var(--surface2);color:var(--text)}

/* Back button */
.back-btn{display:inline-flex;align-items:center;gap:6px;padding:10px 18px;border:none;background:var(--surface2);color:var(--text2);border-radius:8px;cursor:pointer;font:600 14px 'Noto Sans KR',sans-serif;margin-bottom:12px}
.back-btn:hover{color:var(--text);background:var(--surface3)}

/* Loading spinner */
.spinner{display:inline-block;width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

@media(max-width:640px){
  .g2,.g3,.g4{grid-template-columns:1fr}
  .summary-grid{grid-template-columns:1fr}
  table.t{font-size:11px}
  table.t th,table.t td{padding:5px 5px}
  nav button{padding:8px 10px;font-size:11px}
  .hold-grid,.hold-hdr{grid-template-columns:repeat(3,1fr)}
}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="logo">ğŸ“Š</div>
    <div style="flex:1"><h1>Sunghoon's Portfolio Manager</h1><div class="sub"><span id="verInfo"></span> Â· <span id="dataInfo">data-ì—†ìŒ</span></div></div>
    <button class="btn btn-s btn-sm" onclick="refreshData()" title="Google Sheetì—ì„œ ê±°ë˜ ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°">ğŸ”„ Data</button>
  </div>

  <nav id="nav">
    <button class="on" data-p="overview">ğŸ“Š Overview</button>
    <button data-p="history" id="navHistory">ğŸ“œ History</button>
    <button data-p="import">ğŸ“¥ +File</button>
    <button data-p="manual">âœï¸ ì…ë ¥</button>
    <button data-p="data">ğŸ“‹ ë°ì´í„°</button>
    <button data-p="setup">âš™ï¸ ì„¤ì •</button>
  </nav>

  <!-- ==================== OVERVIEW ==================== -->
  <div id="p-overview" class="panel on">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div class="filter-btns">
        <button class="fbtn on" onclick="setFilter('ì‚¼ì„±',this)">ğŸ”µ ì‚¼ì„±</button>
        <button class="fbtn" onclick="setFilter('í‚¤ì›€',this)">ğŸ”´ í‚¤ì›€</button>
        <button class="fbtn" onclick="setFilter('all',this)">Total</button>
      </div>
      <div style="display:flex;gap:4px;align-items:center">
        <button class="btn btn-s btn-sm" onclick="refreshPrices()" title="í˜„ì¬ê°€ ì—…ë°ì´íŠ¸">ğŸ”„ Price</button>
        <button class="btn btn-s btn-sm" onclick="refreshFundamentals()" title="P/E, EPS ì—…ë°ì´íŠ¸">ğŸ”„ Fund.</button>
        <button class="btn btn-s btn-sm" onclick="debugEarnings('AMD')" title="AMD EPS ë””ë²„ê·¸" style="font-size:9px">ğŸ” EPS</button>
      </div>
    </div>
    <div style="text-align:right;font-size:10px;color:var(--text3);margin-bottom:8px;margin-top:-8px">
      price: <span id="priceInfo">ì—†ìŒ</span> Â· fund: <span id="fundInfo">ì—†ìŒ</span>
    </div>
    <div id="overviewContent"><p style="color:var(--text2);text-align:center;padding:32px">ğŸ”„ í´ë¦­í•˜ì—¬ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”</p></div>
  </div>

  <!-- ==================== TOTAL VALUE CHART ==================== -->
  <div id="p-chart" class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <span class="back-btn" onclick="switchTab('overview')">â† ëŒì•„ê°€ê¸°</span>
      <span style="font-size:14px;font-weight:600">ğŸ“ˆ Total Value</span>
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;align-items:center">
      <div class="chart-grp">
        <button class="cbtn on" onclick="setChartPeriod('total',this)">Total</button>
        <button class="cbtn" onclick="setChartPeriod('1y',this)">1Y</button>
        <button class="cbtn" onclick="setChartPeriod('6m',this)">6M</button>
        <button class="cbtn" onclick="setChartPeriod('3m',this)">3M</button>
        <span id="yearButtons"></span>
      </div>
      <div class="chart-grp" style="margin-left:8px">
        <button class="cbtn on" onclick="toggleBench('TQQQ',this)">TQQQ</button>
        <button class="cbtn" onclick="toggleBench('QQQ',this)">QQQ</button>
        <button class="cbtn on" onclick="toggleBench('%5ESOX',this)">SOX</button>
        <button class="cbtn on" onclick="toggleBench('IWM',this)">Russell</button>
      </div>
      <div class="chart-grp" style="margin-left:8px">
        <button class="cbtn on" onclick="setChartMode('norm',this)">Normalized</button>
        <button class="cbtn" onclick="setChartMode('chg',this)">Change%</button>
      </div>
      <div class="chart-grp" style="margin-left:8px">
        <button class="cbtn" onclick="setBottomMode('abs',this)">$</button>
        <button class="cbtn on" onclick="setBottomMode('pct',this)">%</button>
      </div>
    </div>
    <div id="chartContent" style="padding-bottom:40px"><p style="color:var(--text2);text-align:center;padding:32px">ë¡œë”© ì¤‘...</p></div>
  </div>

  <!-- ==================== TICKER HISTORY ==================== -->
  <div id="p-history" class="panel">
    <div id="historyHeader" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <span id="historyTitle" style="font-size:14px;font-weight:600">ì „ì²´ ê±°ë˜ ë‚´ì—­</span>
      <button class="btn btn-s btn-sm" onclick="showHistory(null)">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
    </div>
    <div id="historyContent"></div>
  </div>

  <!-- ==================== IMPORT ==================== -->
  <div id="p-import" class="panel">
    <div class="card">
      <div class="card-hdr"><span class="ico">ğŸ“¥</span> í…ìŠ¤íŠ¸ ë°ì´í„° ë¶™ì—¬ë„£ê¸°</div>
      <p style="font-size:12px;color:var(--text2);margin-bottom:10px">Claudeê°€ ìƒì„±í•œ í…ìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ê³  "ê°€ì ¸ì˜¤ê¸°"ë¥¼ í´ë¦­í•˜ì„¸ìš”.</p>
      <textarea id="impText" rows="12" placeholder="#ì‚¼ì„± 260212
CAT,1,773.3300,1
SOXL,7,70.3600,2
ASTS,-4,85.5650,3

#í‚¤ì›€ 260212
CLS,1,287.0000,1
CLS,1,282.5800,2"></textarea>
      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <button class="btn btn-p" onclick="doImport()">ğŸ“¥ ê°€ì ¸ì˜¤ê¸° â†’ Google Sheets</button>
        <button class="btn btn-s btn-sm" onclick="previewImport()">ğŸ‘ ë¯¸ë¦¬ë³´ê¸°</button>
        <button class="btn btn-s btn-sm" onclick="document.getElementById('impText').value='';document.getElementById('impPreview').innerHTML=''">ì§€ìš°ê¸°</button>
      </div>
      <div id="impPreview" style="margin-top:12px"></div>
      <div id="impLog" style="margin-top:8px"></div>
    </div>
    <div class="card">
      <div class="card-hdr"><span class="ico">ğŸ“–</span> í…ìŠ¤íŠ¸ í˜•ì‹</div>
      <div style="font-size:12px;color:var(--text2);line-height:1.7">
        <p><code style="background:var(--surface2);padding:2px 6px;border-radius:3px;font-size:11px">#ì¦ê¶Œì‚¬ ë‚ ì§œ(YYMMDD)</code> ë¡œ ê·¸ë£¹ ì‹œì‘</p>
        <p><code style="background:var(--surface2);padding:2px 6px;border-radius:3px;font-size:11px">ì¢…ëª©,ìˆ˜ëŸ‰(ë§¤ë„=-),ì²´ê²°ë‹¨ê°€,ìˆœì„œ</code> ë¡œ ê° ê±°ë˜</p>
        <p>ë¹ˆ ì¤„ë¡œ ê·¸ë£¹ êµ¬ë¶„. tax/total ìë™ ê³„ì‚° (ì‚¼ì„± 0.03%, í‚¤ì›€ 0.07%)</p>
      </div>
    </div>
  </div>

  <!-- ==================== MANUAL ==================== -->
  <div id="p-manual" class="panel">
    <div class="card">
      <div class="card-hdr"><span class="ico">âœï¸</span> ìˆ˜ë™ ê±°ë˜ ì…ë ¥</div>
      <div class="g2">
        <label class="f"><span>ì¦ê¶Œì‚¬</span><select id="mBk"><option value="ì‚¼ì„±">ì‚¼ì„± (0.03%)</option><option value="í‚¤ì›€">í‚¤ì›€ (0.07%)</option></select></label>
        <label class="f"><span>ë‚ ì§œ (YYMMDD)</span><input type="text" id="mDt" placeholder="260212" maxlength="6"/></label>
      </div>
      <div class="g4">
        <label class="f"><span>ì¢…ëª©</span><input type="text" id="mTk" placeholder="AAPL" style="text-transform:uppercase"/></label>
        <label class="f"><span>ë§¤ë§¤</span><select id="mSd"><option value="buy">ë§¤ìˆ˜</option><option value="sell">ë§¤ë„</option></select></label>
        <label class="f"><span>ìˆ˜ëŸ‰</span><input type="number" id="mQt" placeholder="1" min="1"/></label>
        <label class="f"><span>ì²´ê²°ë‹¨ê°€</span><input type="number" id="mPr" placeholder="150.00" step="0.0001"/></label>
      </div>
      <button class="btn btn-p btn-full" onclick="addManual()">â• ì¶”ê°€ â†’ Google Sheets ì €ì¥</button>
    </div>
  </div>

  <!-- ==================== DATA ==================== -->
  <div id="p-data" class="panel">
    <div class="btn-row" style="margin-bottom:12px">
      <button class="btn btn-s btn-sm" onclick="loadFromSheet()">ğŸ”„ ì‹œíŠ¸ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button class="btn btn-s btn-sm" onclick="downloadXlsx()">ğŸ“¥ xlsx ë‹¤ìš´ë¡œë“œ</button>
    </div>
    <div id="dataView"><p style="color:var(--text2);text-align:center;padding:32px">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ "ì‹œíŠ¸ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°"ë¥¼ í´ë¦­í•˜ì„¸ìš”</p></div>
  </div>

  <!-- ==================== SETUP ==================== -->
  <div id="p-setup" class="panel">
    <div class="card">
      <div class="card-hdr"><span class="ico">ğŸ“¡</span> ì—°ê²° ìƒíƒœ</div>
      <div class="g2" style="margin-bottom:12px">
        <div>Google Sheets: <span class="status no" id="st-gs">ë¯¸ì—°ê²°</span></div>
        <div>Sheet ID: <span class="status no" id="st-sid">ì—†ìŒ</span></div>
      </div>
    </div>
    <div class="card">
      <div class="card-hdr"><span class="ico">ğŸ“˜</span> Google Sheets ì„¤ì • ê°€ì´ë“œ</div>
      <div class="steps">
        <div class="step"><h3>Google Cloud í”„ë¡œì íŠ¸ ìƒì„±</h3><p><a href="https://console.cloud.google.com/projectcreate" target="_blank" style="color:var(--accent)">console.cloud.google.com</a> â†’ ìƒˆ í”„ë¡œì íŠ¸</p></div>
        <div class="step"><h3>Google Sheets API í™œì„±í™”</h3><p><a href="https://console.cloud.google.com/apis/library/sheets.googleapis.com" target="_blank" style="color:var(--accent)">Sheets API</a> â†’ "ì‚¬ìš©" í´ë¦­</p></div>
        <div class="step"><h3>ì„œë¹„ìŠ¤ ê³„ì • ìƒì„±</h3><p><a href="https://console.cloud.google.com/iam-admin/serviceaccounts/create" target="_blank" style="color:var(--accent)">ì„œë¹„ìŠ¤ ê³„ì •</a> â†’ ìƒì„± â†’ "í‚¤" íƒ­ â†’ JSON ë‹¤ìš´ë¡œë“œ</p></div>
        <div class="step"><h3>Google Sheet ì¤€ë¹„</h3><p>ìƒˆ Sheet â†’ íƒ­: <code>ì‚¼ì„±</code>, <code>í‚¤ì›€</code>, <code>config</code>. config íƒ­: A1=<code>initial_cash_ì‚¼ì„±</code> B1=ê¸ˆì•¡, A2=<code>initial_cash_í‚¤ì›€</code> B2=ê¸ˆì•¡</p></div>
        <div class="step"><h3>ì‹œíŠ¸ ê³µìœ </h3><p>JSONì˜ <code>client_email</code> â†’ Sheet "ê³µìœ " â†’ í¸ì§‘ì ê¶Œí•œ</p></div>
      </div>
    </div>
    <div class="card">
      <div class="card-hdr"><span class="ico">ğŸ”‘</span> ì„œë¹„ìŠ¤ ê³„ì • í‚¤ (JSON)</div>
      <p style="font-size:11px;color:var(--text2);margin-bottom:8px">Google Cloud Console â†’ IAM & Admin â†’ ì„œë¹„ìŠ¤ ê³„ì • â†’ í‚¤ íƒ­ â†’ JSON ë‹¤ìš´ë¡œë“œí•œ íŒŒì¼ì˜ ì „ì²´ ë‚´ìš©ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</p>
      <textarea id="saKey" placeholder='JSON ì „ì²´ ë¶™ì—¬ë„£ê¸°...'></textarea>
      <div style="margin-top:8px"><button class="btn btn-p btn-sm" onclick="saveSA()">ì €ì¥</button><span style="font-size:11px;color:var(--text2);margin-left:8px">ë¡œì»¬ ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥</span></div>
    </div>
    <div class="card">
      <div class="card-hdr"><span class="ico">ğŸ“„</span> Google Sheet ID</div>
      <p style="font-size:11px;color:var(--text2);margin-bottom:8px">Google Sheet URLì—ì„œ <code>/d/</code>ì™€ <code>/edit</code> ì‚¬ì´ì˜ ê¸´ ë¬¸ìì—´ì…ë‹ˆë‹¤. ì˜ˆ: https://docs.google.com/spreadsheets/d/<b style="color:var(--accent)">1aBcDeFgHiJkLmNoPqRsTuVwXyZ</b>/edit</p>
      <div style="display:flex;gap:8px">
        <input type="text" id="sheetId" placeholder="Sheet ID (URLì˜ /d/.../ ë¶€ë¶„)"/>
        <button class="btn btn-p btn-sm" onclick="saveSheetId()">ì €ì¥</button>
        <button class="btn btn-s btn-sm" onclick="testConnection()">í…ŒìŠ¤íŠ¸</button>
      </div>
    </div>
    <div class="card">
      <div class="card-hdr"><span class="ico">ğŸ’°</span> Initial Cash (ì´ˆê¸° íˆ¬ìê¸ˆ)</div>
      <div class="g2" style="margin-bottom:8px">
        <label class="f"><span>ğŸ”µ ì‚¼ì„±</span><input type="number" id="initCashSS" placeholder="30000" step="100"/></label>
        <label class="f"><span>ğŸ”´ í‚¤ì›€</span><input type="number" id="initCashKW" placeholder="20000" step="100"/></label>
      </div>
      <button class="btn btn-p btn-sm" onclick="saveInitCash()">ì €ì¥ â†’ Sheet</button>
      <p style="font-size:11px;color:var(--text2);margin-top:6px">config íƒ­ í˜•ì‹: A1=initial_cash_ì‚¼ì„±, B1=ê¸ˆì•¡, A2=initial_cash_í‚¤ì›€, B2=ê¸ˆì•¡</p>
    </div>
    <div class="card">
      <div class="card-hdr"><span class="ico">ğŸ“Š</span> FMP API Key (Financial Modeling Prep)</div>
      <p style="font-size:11px;color:var(--text2);margin-bottom:8px"><a href="https://site.financialmodelingprep.com/developer/docs" target="_blank" style="color:var(--accent)">financialmodelingprep.com</a> â†’ íšŒì›ê°€ì… â†’ Dashboard â†’ API Key ë³µì‚¬. P/E, EPS ë“± ì¬ë¬´ ë°ì´í„°ì— ì‚¬ìš©ë©ë‹ˆë‹¤.</p>
      <div style="display:flex;gap:8px">
        <input type="text" id="fmpKey" placeholder="FMP API Key"/>
        <button class="btn btn-p btn-sm" onclick="saveFmpKey()">ì €ì¥</button>
      </div>
      <p style="font-size:11px;color:var(--text2);margin-top:6px">ë¬´ë£Œ í”Œëœ: ì¼ 250íšŒ ìš”ì²­. ë¡œì»¬ ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.</p>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ================ CONFIG ================
const TAX={ì‚¼ì„±:0.0003,í‚¤ì›€:0.0007};
const SCOPES='https://www.googleapis.com/auth/spreadsheets';
let SA_KEY=null,SHEET_ID='',FMP_KEY='',gToken=null,gTokenExp=0;
let allTransactions=[];
let initialCashSS=0,initialCashKW=0;
let cachedPrices={};
let cachedFundamentals={};
let fundHistory={}; // {ticker: [{date, epsNorm, revNorm, targetPrice}]}
const CACHE_KEY_TX='cache_transactions';
const CACHE_KEY_PRICES='cache_prices';
const CACHE_KEY_FUND='cache_fundamentals';
const CACHE_KEY_CASH='cache_initialCash2';
const CACHE_KEY_DATA_TS='cache_dataTimestamp';

// ================ INIT ================
document.addEventListener('DOMContentLoaded',()=>{
  document.querySelectorAll('nav button').forEach(b=>b.addEventListener('click',()=>switchTab(b.dataset.p)));
  updateVerInfo();
  loadConfig();
  restoreCache();
  updateDataInfo();
  updatePriceInfo();
  updateFundInfo();
});

function updateVerInfo(){
  // Try to get last-modified from GitHub
  fetch(window.location.href,{method:'HEAD',cache:'no-cache'}).then(r=>{
    const lm=r.headers.get('last-modified');
    if(lm){
      const d=new Date(lm);
      const kst=new Date(d.getTime()+9*60*60*1000);
      const mm=String(kst.getUTCMonth()+1).padStart(2,'0');
      const dd=String(kst.getUTCDate()).padStart(2,'0');
      const hh=String(kst.getUTCHours()).padStart(2,'0');
      const mi=String(kst.getUTCMinutes()).padStart(2,'0');
      const ss=String(kst.getUTCSeconds()).padStart(2,'0');
      document.getElementById('verInfo').textContent=`html-${mm}-${dd}-${hh}:${mi}:${ss}`;
    }else{
      document.getElementById('verInfo').textContent='html-unknown';
    }
  }).catch(()=>{document.getElementById('verInfo').textContent='html-local'});
}

function updatePriceInfo(){
  const ts=localStorage.getItem('cache_priceTimestamp');
  document.getElementById('priceInfo').textContent=ts||'ì—†ìŒ';
}
function updateFundInfo(){
  const ts=localStorage.getItem('cache_fundTimestamp');
  document.getElementById('fundInfo').textContent=ts||'ì—†ìŒ';
}
function savePriceTimestamp(){
  const now=new Date();
  const kst=new Date(now.getTime()+9*60*60*1000);
  const mm=String(kst.getUTCMonth()+1).padStart(2,'0');
  const dd=String(kst.getUTCDate()).padStart(2,'0');
  const hh=String(kst.getUTCHours()).padStart(2,'0');
  const mi=String(kst.getUTCMinutes()).padStart(2,'0');
  localStorage.setItem('cache_priceTimestamp',`${mm}-${dd} ${hh}:${mi}`);
  updatePriceInfo();
}

function switchTab(p){
  document.querySelectorAll('nav button').forEach(x=>x.classList.toggle('on',x.dataset.p===p));
  document.querySelectorAll('.panel').forEach(x=>x.classList.remove('on'));
  document.getElementById('p-'+p).classList.add('on');
  if(p==='history')document.getElementById('navHistory').style.display='';
}

// ================ CONFIG ================
function loadConfig(){
  try{
    const sa=localStorage.getItem('sa_key');
    if(sa){SA_KEY=JSON.parse(sa);document.getElementById('saKey').value=sa;updateSt('st-gs','ok','í‚¤ ì €ì¥ë¨')}
    const sid=localStorage.getItem('sheet_id');
    if(sid){SHEET_ID=sid;document.getElementById('sheetId').value=sid;updateSt('st-sid','ok',sid.slice(0,8)+'...')}
    const fk=localStorage.getItem('fmp_key');
    if(fk){FMP_KEY=fk;document.getElementById('fmpKey').value=fk}
  }catch(e){}
}
function saveSA(){try{const r=document.getElementById('saKey').value.trim();SA_KEY=JSON.parse(r);localStorage.setItem('sa_key',r);updateSt('st-gs','ok','í‚¤ ì €ì¥ë¨');toast('ì €ì¥ ì™„ë£Œ','ok')}catch(e){toast('JSON í˜•ì‹ ì˜¤ë¥˜','err')}}
function saveSheetId(){SHEET_ID=document.getElementById('sheetId').value.trim();localStorage.setItem('sheet_id',SHEET_ID);updateSt('st-sid','ok',SHEET_ID.slice(0,8)+'...');toast('ì €ì¥ ì™„ë£Œ','ok')}
function saveFmpKey(){FMP_KEY=document.getElementById('fmpKey').value.trim();localStorage.setItem('fmp_key',FMP_KEY);toast('FMP API Key ì €ì¥ ì™„ë£Œ','ok')}
function updateSt(id,cls,txt){const el=document.getElementById(id);el.className='status '+cls;el.textContent=txt}
async function saveInitCash(){
  const ss=parseFloat(document.getElementById('initCashSS').value);
  const kw=parseFloat(document.getElementById('initCashKW').value);
  if((!ss&&!kw)||!SHEET_ID||!SA_KEY){toast('ê¸ˆì•¡ê³¼ Sheet ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”','err');return}
  try{
    const token=await getAccessToken();
    const url=`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/config!A1:B2?valueInputOption=USER_ENTERED`;
    await fetch(url,{method:'PUT',headers:{Authorization:`Bearer ${token}`,'Content-Type':'application/json'},
      body:JSON.stringify({range:'config!A1:B2',values:[['initial_cash_ì‚¼ì„±',ss||0],['initial_cash_í‚¤ì›€',kw||0]]})});
    initialCashSS=ss||0;initialCashKW=kw||0;
    toast('Initial cash ì €ì¥ ì™„ë£Œ','ok');
  }catch(e){toast('ì €ì¥ ì‹¤íŒ¨: '+e.message,'err')}
}

// ================ GOOGLE AUTH ================
async function getAccessToken(){
  if(gToken&&Date.now()/1000<gTokenExp-60)return gToken;
  if(!SA_KEY)throw new Error('ì„œë¹„ìŠ¤ ê³„ì • í‚¤ ì—†ìŒ');
  const now=Math.floor(Date.now()/1000),exp=now+3600;
  const sJWT=KJUR.jws.JWS.sign('RS256',JSON.stringify({alg:'RS256',typ:'JWT'}),
    JSON.stringify({iss:SA_KEY.client_email,scope:SCOPES,aud:'https://oauth2.googleapis.com/token',iat:now,exp}),SA_KEY.private_key);
  const resp=await fetch('https://oauth2.googleapis.com/token',{method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body:`grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=${sJWT}`});
  if(!resp.ok){const e=await resp.json().catch(()=>({}));throw new Error('Auth ì‹¤íŒ¨: '+(e.error_description||resp.status))}
  const d=await resp.json();gToken=d.access_token;gTokenExp=exp;return gToken;
}

// ================ SHEETS API ================
async function sheetsGet(range){
  const token=await getAccessToken();
  const r=await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(range)}`,{headers:{Authorization:`Bearer ${token}`}});
  if(!r.ok)throw new Error('ì‹œíŠ¸ ì½ê¸° ì‹¤íŒ¨: '+r.status);return r.json();
}
async function sheetsInsertAtTop(sheet,values){
  const token=await getAccessToken();const range=`${sheet}!A:H`;
  let existing=[];try{const d=await sheetsGet(`${sheet}!A:H`);existing=d.values||[]}catch(e){}
  const header=existing.length>0?existing[0]:['','','','','tax','total','split','seq'];
  const newAll=[header,...values,...existing.slice(1)];
  await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(range)}:clear`,{method:'POST',headers:{Authorization:`Bearer ${token}`}});
  const r=await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(range)}?valueInputOption=USER_ENTERED`,{
    method:'PUT',headers:{Authorization:`Bearer ${token}`,'Content-Type':'application/json'},
    body:JSON.stringify({range,majorDimension:'ROWS',values:newAll})});
  if(!r.ok)throw new Error('ì‹œíŠ¸ ì“°ê¸° ì‹¤íŒ¨: '+r.status);return r.json();
}
async function testConnection(){
  try{updateSt('st-gs','wait','í…ŒìŠ¤íŠ¸...');await sheetsGet('ì‚¼ì„±!A1:H1');updateSt('st-gs','ok','ì—°ê²° ì„±ê³µ âœ“');toast('ì—°ê²° ì„±ê³µ!','ok')}
  catch(e){updateSt('st-gs','no','ì‹¤íŒ¨');toast(e.message,'err')}
}

// ================ CACHE ================
function saveCache(){
  try{
    localStorage.setItem(CACHE_KEY_TX,JSON.stringify(allTransactions));
    localStorage.setItem(CACHE_KEY_PRICES,JSON.stringify(cachedPrices));
    localStorage.setItem(CACHE_KEY_FUND,JSON.stringify(cachedFundamentals));
    localStorage.setItem(CACHE_KEY_CASH,JSON.stringify({ss:initialCashSS,kw:initialCashKW}));
    localStorage.setItem('cache_fundHistory',JSON.stringify(fundHistory));
  }catch(e){}
}
function saveDataTimestamp(){
  let latest='';
  for(const tx of allTransactions){if(tx.date>latest)latest=tx.date}
  if(latest&&latest.length===6){
    const ts=`${latest.slice(2,4)}-${latest.slice(4,6)}`;
    localStorage.setItem(CACHE_KEY_DATA_TS,ts);
  }
  updateDataInfo();
}
function updateDataInfo(){
  const ts=localStorage.getItem(CACHE_KEY_DATA_TS);
  document.getElementById('dataInfo').textContent=ts?`data-${ts}`:'data-ì—†ìŒ';
}
function restoreCache(){
  try{
    const tx=localStorage.getItem(CACHE_KEY_TX);
    if(tx){allTransactions=JSON.parse(tx)}
    const pr=localStorage.getItem(CACHE_KEY_PRICES);
    if(pr){cachedPrices=JSON.parse(pr)}
    const fd=localStorage.getItem(CACHE_KEY_FUND);
    if(fd){cachedFundamentals=JSON.parse(fd)}
    const fh=localStorage.getItem('cache_fundHistory');
    if(fh){fundHistory=JSON.parse(fh)}
    const ic=localStorage.getItem(CACHE_KEY_CASH);
    if(ic){const c=JSON.parse(ic);initialCashSS=c.ss||0;initialCashKW=c.kw||0}
    populateInitCashFields();
    if(allTransactions.length>0){
      computeOverview();
      renderOverview();
    }
  }catch(e){}
  // Refresh version displays after restore
  updatePriceInfo();
  updateFundInfo();
}
function populateInitCashFields(){
  if(initialCashSS)document.getElementById('initCashSS').value=initialCashSS;
  if(initialCashKW)document.getElementById('initCashKW').value=initialCashKW;
}

// Three separate refresh functions
async function refreshData(){
  if(!SHEET_ID||!SA_KEY){toast('Google Sheets ì„¤ì •ì„ ì™„ë£Œí•˜ì„¸ìš”','err');return}
  toast('ğŸ“¡ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...','ok');
  await loadAllTransactions();
  saveCache();
  saveDataTimestamp();
  populateInitCashFields();
  computeOverview();
  renderOverview();
  toast('âœ… ë°ì´í„° ê°±ì‹  ì™„ë£Œ','ok');
}

async function refreshPrices(){
  const tickers=getHeldTickers();
  if(!tickers.length){toast('ë³´ìœ  ì¢…ëª© ì—†ìŒ','err');return}
  toast('ğŸ’² ê°€ê²© ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...','ok');
  cachedPrices=await fetchPrices(tickers);
  saveCache();
  savePriceTimestamp();
  computeOverview();
  renderOverview();
  toast('âœ… ê°€ê²© ê°±ì‹  ì™„ë£Œ','ok');
}

// Leveraged ETF â†’ underlying ticker mapping for fundamentals
// null = skip (no fundamentals available, e.g. index ETFs)
// Tickers not in this map: fetch their own fundamentals directly
const UNDERLYING_MAP={AMDL:'AMD',NVDL:'NVDA',TQQQ:null,SOXL:null,SQQQ:null,GGLL:'GOOGL',TSLL:'TSLA'};

function getFundTicker(ticker){
  if(ticker in UNDERLYING_MAP)return UNDERLYING_MAP[ticker];
  return ticker; // Individual stocks fetch their own fundamentals
}

async function fmpGet(endpoint){
  if(!FMP_KEY)throw new Error('FMP API Key ì—†ìŒ');
  const url=`https://financialmodelingprep.com/stable/${endpoint}${endpoint.includes('?')?'&':'?'}apikey=${FMP_KEY}`;
  try{
    const r=await fetch(url,{signal:AbortSignal.timeout(10000)});
    if(!r.ok){
      console.warn(`FMP ${r.status} for ${endpoint}`);
      return null;
    }
    const d=await r.json();
    return d;
  }catch(e){console.warn(`FMP fetch failed for ${endpoint}: ${e.message}`);return null}
}

async function debugEarnings(ticker){
  if(!FMP_KEY){toast('FMP Key ì—†ìŒ','err');return}
  toast(`ğŸ” ${ticker} earnings ì¡°íšŒ ì¤‘...`,'ok');
  console.log(`=== DEBUG EARNINGS for ${ticker} ===`);

  // Try /stable/earnings?symbol=AMD â€” per-ticker endpoint, may have more history
  console.log(`--- Trying /stable/earnings?symbol=${ticker} ---`);
  const earningsData=await fmpGet(`earnings?symbol=${ticker}`);
  console.log(`${ticker} /stable/earnings response:`,earningsData);
  if(Array.isArray(earningsData)){
    console.log(`${ticker} /stable/earnings: ${earningsData.length} entries`);
    for(const e of earningsData){
      console.log(`  ${e.date||e.fiscalDateEnding||'?'} | epsActual=${e.epsActual} epsEst=${e.epsEstimated} revActual=${e.revenueActual} revEst=${e.revenueEstimated} | period=${e.period||''} fiscalEnd=${e.fiscalDateEnding||''}`);
    }
  }else{
    console.log(`${ticker} /stable/earnings: not an array:`,earningsData);
  }

  toast(`âœ… ${ticker}: see console for results`,'ok');
}

// Fetch quarterly earnings actuals for a ticker using 15-day windows
async function refreshFundamentals(){
  if(!FMP_KEY){toast('âš™ï¸ ì„¤ì •ì—ì„œ FMP API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”','err');return}
  const toastEl=document.getElementById('toast');
  function showFetching(msg){
    toastEl.textContent=msg;toastEl.className='toast ok show';
    // Don't auto-hide
  }
  try{
    const held=getHeldTickers();
    const fundTickers=[...new Set(held.map(t=>getFundTicker(t)).filter(t=>t!==null))];
    console.log('Fund tickers to fetch:',fundTickers);
    showFetching(`ğŸ“Š Fetching: ${fundTickers.join(', ')} (${fundTickers.length*4} API calls)`);
    if(!fundTickers.length){toast('í€ë”ë©˜íƒˆ ë°ì´í„° ëŒ€ìƒ ì¢…ëª© ì—†ìŒ','err');return}

    const newFund={};

    // Load actual EPS/Rev from eps_actuals sheet tab
    // Format: ticker | date(YYYY-MM) | eps | rev
    // e.g.: AMD | 2024-12 | 3.31 | 25785000000
    let epsActualsMap={}; // {ticker: {dateKey: {eps, rev}}}
    if(SHEET_ID&&SA_KEY){
      try{
        showFetching('ğŸ“Š Loading eps_actuals from sheet...');
        const rows=await sheetsGet('eps_actuals!A2:E200');
        if(Array.isArray(rows)){
          for(const r of rows){
            if(!r[0]||!r[1])continue;
            const tk=String(r[0]).trim().toUpperCase();
            const dateKey=String(r[1]).trim();
            const source=r[4]||'manual';
            // Load all entries (manual override api if same key)
            if(!epsActualsMap[tk])epsActualsMap[tk]={};
            if(!epsActualsMap[tk][dateKey]||source==='manual'){
              epsActualsMap[tk][dateKey]={
                eps:r[2]!=null&&r[2]!==''?parseFloat(r[2]):null,
                rev:r[3]!=null&&r[3]!==''?parseFloat(r[3]):null
              };
            }
          }
        }
        console.log('eps_actuals loaded:',epsActualsMap);
      }catch(e){console.warn('eps_actuals tab not found or empty:',e)}
    }

    // Load fund_history for EPS change tracking (1w/1m)
    if(SHEET_ID&&SA_KEY){
      try{
        showFetching('ğŸ“Š Loading fund_history...');
        const histRows=await sheetsGet('fund_history!A2:E5000');
        fundHistory={};
        if(Array.isArray(histRows)){
          for(const r of histRows){
            if(!r[0]||!r[1])continue;
            const dt=String(r[0]).trim();
            const tk=String(r[1]).trim().toUpperCase();
            if(!fundHistory[tk])fundHistory[tk]=[];
            fundHistory[tk].push({
              date:dt,
              epsNorm:r[2]!=null&&r[2]!==''?parseFloat(r[2]):null,
              revNorm:r[3]!=null&&r[3]!==''?parseFloat(r[3]):null,
              targetPrice:r[4]!=null&&r[4]!==''?parseFloat(r[4]):null
            });
          }
          // Sort each ticker's history by date
          for(const tk of Object.keys(fundHistory)){
            fundHistory[tk].sort((a,b)=>a.date.localeCompare(b.date));
          }
        }
        console.log('fund_history loaded:',Object.keys(fundHistory).length,'tickers');
      }catch(e){console.warn('fund_history not found:',e)}
    }

    let idx=0;
    for(const tk of fundTickers){
      idx++;
      showFetching(`ğŸ“Š ${tk}... (${idx}/${fundTickers.length})`);
      console.log(`=== Fetching FMP data for ${tk} ===`);
      // 4 API calls: annual estimates, quarterly earnings, price target, grades
      const [annual, quarterlyEarnings, ptConsensus, gradesData]=await Promise.all([
        fmpGet(`analyst-estimates?symbol=${tk}&period=annual&limit=8`),
        fmpGet(`earnings?symbol=${tk}`),
        fmpGet(`price-target-consensus?symbol=${tk}`),
        fmpGet(`grades-consensus?symbol=${tk}`)
      ]);
      console.log(`${tk} annual estimates:`,annual);
      console.log(`${tk} quarterly earnings: ${Array.isArray(quarterlyEarnings)?quarterlyEarnings.length:0} entries`);
      console.log(`${tk} priceTarget:`,ptConsensus);
      console.log(`${tk} grades:`,gradesData);

      // Build quarterly EPS/Rev from /stable/earnings
      // Uses epsActual where available, falls back to epsEstimated for future quarters
      const qData=[];
      if(Array.isArray(quarterlyEarnings)){
        for(const q of quarterlyEarnings){
          if(!q.date)continue;
          const eps=q.epsActual!=null?q.epsActual:q.epsEstimated;
          const rev=q.revenueActual!=null?q.revenueActual:q.revenueEstimated;
          if(eps==null)continue;
          qData.push({reportDate:q.date, eps, rev:rev||0, isActual:q.epsActual!=null});
        }
        qData.sort((a,b)=>a.reportDate.localeCompare(b.reportDate));
      }

      // Detect fiscal year end month from analyst-estimates
      let fyEndMonth=12;
      if(Array.isArray(annual)&&annual.length>0){
        const months=annual.map(e=>parseInt(e.date.slice(5,7))||12);
        fyEndMonth=months[0]||12;
      }

      // Group quarters into fiscal years (use actuals + estimates)
      if(qData.length>0&&(!epsActualsMap[tk]||Object.keys(epsActualsMap[tk]).length===0)){
        const byFY={};
        for(const q of qData){
          const qy=parseInt(q.reportDate.slice(0,4));
          const qm=parseInt(q.reportDate.slice(5,7));
          let fy;
          if(fyEndMonth===12){
            fy=qm<=3?qy-1:qy;
          }else if(fyEndMonth<=3){
            fy=qm<=(fyEndMonth+3)?qy:qy+1;
          }else{
            fy=qm<=(fyEndMonth+3)?qy:qy+1;
          }
          const fyKey=`${fy}-${String(fyEndMonth).padStart(2,'0')}`;
          if(!byFY[fyKey])byFY[fyKey]={eps:0,rev:0,count:0,actuals:0,quarters:[]};
          byFY[fyKey].eps+=q.eps;
          byFY[fyKey].rev+=q.rev;
          byFY[fyKey].count++;
          if(q.isActual)byFY[fyKey].actuals++;
          byFY[fyKey].quarters.push(`${q.reportDate}:${q.eps}${q.isActual?'âœ“':'est'}`);
        }
        if(!epsActualsMap[tk])epsActualsMap[tk]={};
        for(const[fyKey,v] of Object.entries(byFY)){
          if(v.count>=4){
            epsActualsMap[tk][fyKey]={eps:v.eps, rev:v.rev>0?v.rev:null};
            console.log(`${tk} FY ${fyKey}: ${v.count}Q (${v.actuals} actual) eps=${v.eps.toFixed(3)} rev=${v.rev} [${v.quarters.join(', ')}]`);
          }
        }
      }else if(epsActualsMap[tk]){
        console.log(`${tk} using eps_actuals from sheet:`,epsActualsMap[tk]);
      }

      // Price: try cached price for this ticker, or find from Yahoo quote
      let price=0;
      if(cachedPrices[tk]&&cachedPrices[tk].current){
        price=cachedPrices[tk].current;
      }else{
        // For underlying tickers (e.g. NVDA from NVDL), fetch price
        // Try FMP quote first
        try{
          const q=await fmpGet(`profile?symbol=${tk}`);
          if(Array.isArray(q)&&q[0]&&q[0].price)price=q[0].price;
          else if(q&&q.price)price=q.price;
        }catch(e){}
        // Fallback to Yahoo
        if(price===0){
          try{
            const yUrl=`https://query1.finance.yahoo.com/v8/finance/chart/${tk}?interval=1d&range=1d`;
            const proxies=[u=>`https://corsproxy.io/?${encodeURIComponent(u)}`];
            for(const mkP of proxies){
              try{
                const r=await fetch(mkP(yUrl),{signal:AbortSignal.timeout(8000)});
                if(!r.ok)continue;
                const d=await r.json();
                price=d.chart?.result?.[0]?.meta?.regularMarketPrice||0;
                if(price>0)break;
              }catch(e){continue}
            }
          }catch(e){}
        }
        console.log(`${tk} price fetched: ${price}`);
      }

      // --- Normalize EPS & Revenue to Dec 2026 via linear interpolation ---
      let epsNorm=null,epsPrevNorm=null,revNorm=null,revPrevNorm=null;
      let numAnalystsEps=null,numAnalystsRev=null;
      let pe12m=null,epsYoy12m=null,revYoy12m=null;
      // Target normalization: Dec of current year (e.g. Dec 2026)
      const targetMonth=12, targetYear=new Date().getFullYear();
      // Target as fractional year: 2026 + 12/12 = 2027.0 (Dec 2026 end)
      const targetFrac=targetYear+(targetMonth/12);

      if(Array.isArray(annual)&&annual.length>=2){
        // Actuals from eps_actuals Google Sheet tab (user-maintained adjusted EPS & Rev)
        const tkActuals=epsActualsMap[tk]||{};

        // Parse estimate entries, replacing past values with actuals if available
        const entries=annual.map(e=>{
          const y=parseInt(e.date.slice(0,4));
          const m=parseInt(e.date.slice(5,7))||12;
          const frac=y+(m/12);
          const dateKey=e.date.slice(0,7); // "2024-12" or "2025-01"
          const actual=tkActuals[dateKey];
          const eps=(actual&&actual.eps!=null)?actual.eps:(e.epsAvg||0);
          const rev=(actual&&actual.rev!=null)?actual.rev:(e.revenueAvg||0);
          const src=actual?'actual':'est';
          console.log(`${tk} entry: ${e.date} frac=${frac.toFixed(3)} eps=${eps}(${src}) rev=${Math.round(rev)}(${src}) nEps=${e.numAnalystsEps||0}`);
          return{frac, eps, rev,
            nEps:e.numAnalystsEps||0, nRev:e.numAnalystsRevenue||0, date:e.date, src};
        }).sort((a,b)=>a.frac-b.frac);

        // Find two entries that bracket targetFrac for interpolation
        // e.g. NVDA: Jan 2026 (2026.083) and Jan 2027 (2027.083) bracket Dec 2026 (2027.0)
        // e.g. AMD: Dec 2026 (2027.0) exact match
        let lo=null,hi=null;
        for(let i=0;i<entries.length-1;i++){
          if(entries[i].frac<=targetFrac&&entries[i+1].frac>=targetFrac){
            lo=entries[i];hi=entries[i+1];break;
          }
        }
        // Also find the pair one year before for YoY
        const prevTargetFrac=targetFrac-1;
        let loP=null,hiP=null;
        for(let i=0;i<entries.length-1;i++){
          if(entries[i].frac<=prevTargetFrac&&entries[i+1].frac>=prevTargetFrac){
            loP=entries[i];hiP=entries[i+1];break;
          }
        }

        function lerp(lo,hi,target,field){
          if(!lo||!hi)return null;
          if(Math.abs(hi.frac-lo.frac)<0.01)return lo[field];
          const t=(target-lo.frac)/(hi.frac-lo.frac);
          return lo[field]+t*(hi[field]-lo[field]);
        }

        if(lo&&hi){
          epsNorm=lerp(lo,hi,targetFrac,'eps');
          revNorm=lerp(lo,hi,targetFrac,'rev');
          // Use analyst count from the nearer entry
          const closer=Math.abs(targetFrac-lo.frac)<Math.abs(targetFrac-hi.frac)?lo:hi;
          numAnalystsEps=closer.nEps||null;
          numAnalystsRev=closer.nRev||null;

          // EPS YoY: compare the two bracketing fiscal years directly
          // e.g. for AMD: Dec 2026 EPS vs Dec 2025 EPS
          // For non-Dec fiscal years: use the two entries directly
          epsYoy12m=(lo.eps&&hi.eps&&lo.eps!==0)?((hi.eps-lo.eps)/Math.abs(lo.eps)*100):null;
          revYoy12m=(lo.rev&&hi.rev&&lo.rev!==0)?((hi.rev-lo.rev)/Math.abs(lo.rev)*100):null;
        }
        if(loP&&hiP){
          epsPrevNorm=lerp(loP,hiP,prevTargetFrac,'eps');
          revPrevNorm=lerp(loP,hiP,prevTargetFrac,'rev');
        }

        // P/E = price / normalized EPS
        pe12m=(epsNorm&&epsNorm>0&&price)?price/epsNorm:null;

        console.log(`${tk} interpolation: targetFrac=${targetFrac}, lo=${lo?.date}(frac=${lo?.frac},eps=${lo?.eps?.toFixed(3)},rev=${Math.round(lo?.rev||0)}), hi=${hi?.date}(frac=${hi?.frac},eps=${hi?.eps?.toFixed(3)},rev=${Math.round(hi?.rev||0)}), epsNorm=${epsNorm?.toFixed(3)}, epsYoy=${epsYoy12m?.toFixed(1)}%`);
        console.log(`${tk} all entries:`,entries.map(e=>`${e.date}(frac=${e.frac.toFixed(3)},eps=${e.eps?.toFixed(3)},rev=${Math.round(e.rev||0)},nEps=${e.nEps})`).join(' | '));
      }

      // --- Price target ---
      const ptArr=Array.isArray(ptConsensus)?ptConsensus:[];
      const pt=ptArr[0]||{};
      const targetPrice=pt.targetConsensus||pt.targetMedian||null;
      const targetHigh=pt.targetHigh||null;
      const targetLow=pt.targetLow||null;

      // --- Grades ---
      const grArr=Array.isArray(gradesData)?gradesData:[];
      const gr=grArr[0]||{};
      const strongBuy=gr.strongBuy||0;
      const buy=gr.buy||0;
      const hold=gr.hold||0;
      const sell=gr.sell||0;
      const strongSell=gr.strongSell||0;
      const consensus=gr.consensus||null;

      newFund[tk]={
        price, targetYear:`${targetYear}`,
        epsNorm, epsPrevNorm, revNorm, revPrevNorm,
        pe12m, epsYoy12m, revYoy12m,
        numAnalystsEps, numAnalystsRev,
        targetPrice, targetHigh, targetLow,
        strongBuy, buy, hold, sell, strongSell, consensus,
        annual:annual||[],
        fetchDate:new Date().toISOString().slice(0,10)
      };
      console.log(`${tk} RESULT:`,newFund[tk]);
    }

    // Map to held tickers (including leveraged ETFs â†’ underlying)
    for(const tk of held){
      const fundTk=getFundTicker(tk);
      if(fundTk&&newFund[fundTk])cachedFundamentals[tk]=newFund[fundTk];
    }

    saveCache();
    const now=new Date();
    const kst=new Date(now.getTime()+9*60*60*1000);
    const mm=String(kst.getUTCMonth()+1).padStart(2,'0');
    const dd=String(kst.getUTCDate()).padStart(2,'0');
    const hh=String(kst.getUTCHours()).padStart(2,'0');
    const mi=String(kst.getUTCMinutes()).padStart(2,'0');
    localStorage.setItem('cache_fundTimestamp',`${mm}-${dd} ${hh}:${mi}`);
    updateFundInfo();

    await saveFundamentalsToSheet(newFund,epsActualsMap);
    computeOverview();
    renderOverview();
    const count=Object.keys(newFund).length;
    toast(`âœ… Fundamentals ê°±ì‹  ì™„ë£Œ (${count}ì¢…ëª©)`,'ok');
  }catch(e){toast('Fundamentals ì˜¤ë¥˜: '+e.message,'err');console.error(e)}
}

async function saveFundamentalsToSheet(fundData,epsActualsMap){
  if(!SHEET_ID||!SA_KEY)return;
  try{
    const token=await getAccessToken();
    const today=new Date().toISOString().slice(0,10);

    // Ensure eps_actuals tab has header
    try{
      const hdrUrl2=`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/eps_actuals!A1:D1?valueInputOption=USER_ENTERED`;
      await fetch(hdrUrl2,{method:'PUT',headers:{Authorization:`Bearer ${token}`,'Content-Type':'application/json'},
        body:JSON.stringify({values:[['ticker','date(YYYY-MM)','adj_eps','revenue','source']]})});
    }catch(e){console.warn('Could not write eps_actuals header:',e)}

    // Write header row for fundamentals
    try{
      const hdrUrl=`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/fundamentals!A1:L1?valueInputOption=USER_ENTERED`;
      await fetch(hdrUrl,{method:'PUT',headers:{Authorization:`Bearer ${token}`,'Content-Type':'application/json'},
        body:JSON.stringify({values:[['date','ticker','targetYear','epsNorm','numAnalysts','P/E 12m','EPS YoY%','revNorm','Rev YoY%','targetPrice','grades(SB/B/H/S/SS)','consensus']]})});
    }catch(e){console.warn('Could not write header:',e)}

    // Clear existing data below header
    try{
      const clearUrl=`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/fundamentals!A2:L1000:clear`;
      await fetch(clearUrl,{method:'POST',headers:{Authorization:`Bearer ${token}`,'Content-Type':'application/json'}});
    }catch(e){console.warn('Could not clear fundamentals tab:',e)}

    const rows=[];
    for(const[tk,d]of Object.entries(fundData)){
      rows.push([today,tk,
        d.targetYear||'',
        d.epsNorm?d.epsNorm.toFixed(3):'',
        d.numAnalystsEps||'',
        d.pe12m?d.pe12m.toFixed(2):'',
        d.epsYoy12m?d.epsYoy12m.toFixed(2)+'%':'',
        d.revNorm?Math.round(d.revNorm):'',
        d.revYoy12m?d.revYoy12m.toFixed(2)+'%':'',
        d.targetPrice||'',
        `${d.strongBuy||0}/${d.buy||0}/${d.hold||0}/${d.sell||0}/${d.strongSell||0}`,
        d.consensus||''
      ]);
    }
    if(rows.length>0){
      const url=`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/fundamentals!A2:L?valueInputOption=USER_ENTERED`;
      await fetch(url,{method:'PUT',headers:{Authorization:`Bearer ${token}`,'Content-Type':'application/json'},
        body:JSON.stringify({values:rows})});
    }

    // Append to fund_history tab (historical tracking for EPS change 1w/1m)
    try{
      const histRows=[];
      for(const[tk,d]of Object.entries(fundData)){
        if(d.epsNorm!=null)histRows.push([today,tk,d.epsNorm.toFixed(4),d.revNorm?Math.round(d.revNorm):'',d.targetPrice||'']);
      }
      if(histRows.length>0){
        // Ensure header exists
        try{
          const hdrUrl3=`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/fund_history!A1:E1?valueInputOption=USER_ENTERED`;
          await fetch(hdrUrl3,{method:'PUT',headers:{Authorization:`Bearer ${token}`,'Content-Type':'application/json'},
            body:JSON.stringify({values:[['date','ticker','epsNorm','revNorm','targetPrice']]})});
        }catch(e){}
        // Append rows
        const appendUrl=`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/fund_history!A:E:append?valueInputOption=USER_ENTERED&insertDataOption=INSERT_ROWS`;
        await fetch(appendUrl,{method:'POST',headers:{Authorization:`Bearer ${token}`,'Content-Type':'application/json'},
          body:JSON.stringify({values:histRows})});
        console.log(`Appended ${histRows.length} rows to fund_history`);
      }
    }catch(e){console.warn('Could not append to fund_history:',e)}

    // Save eps_actuals to sheet (API-fetched actuals, preserving manual entries)
    if(epsActualsMap&&Object.keys(epsActualsMap).length>0){
      try{
        // Read existing sheet to preserve manual entries
        let existingManual={};
        try{
          const existing=await sheetsGet('eps_actuals!A2:E200');
          if(Array.isArray(existing)){
            for(const r of existing){
              if(r[4]==='manual'){
                const tk=String(r[0]).trim().toUpperCase();
                const dk=String(r[1]).trim();
                if(!existingManual[tk])existingManual[tk]={};
                existingManual[tk][dk]={eps:parseFloat(r[2])||null,rev:parseFloat(r[3])||null};
              }
            }
          }
        }catch(e){}

        // Build rows: manual entries first, then API actuals
        const epsRows=[];
        // Manual entries (from sheet)
        for(const[tk,dates] of Object.entries(existingManual)){
          for(const[dk,v] of Object.entries(dates)){
            epsRows.push([tk,dk,v.eps!=null?v.eps:'',v.rev!=null?v.rev:'','manual']);
          }
        }
        // API-fetched actuals
        for(const[tk,dates] of Object.entries(epsActualsMap)){
          for(const[dk,v] of Object.entries(dates)){
            if(existingManual[tk]&&existingManual[tk][dk])continue; // don't overwrite manual
            epsRows.push([tk,dk,v.eps!=null?v.eps:'',v.rev!=null?v.rev:'','api']);
          }
        }
        if(epsRows.length>0){
          const clearUrl=`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/eps_actuals!A2:E1000:clear`;
          await fetch(clearUrl,{method:'POST',headers:{Authorization:`Bearer ${token}`,'Content-Type':'application/json'}});
          const url=`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/eps_actuals!A2:E?valueInputOption=USER_ENTERED`;
          await fetch(url,{method:'PUT',headers:{Authorization:`Bearer ${token}`,'Content-Type':'application/json'},
            body:JSON.stringify({values:epsRows})});
          console.log(`Saved ${epsRows.length} eps_actuals entries to sheet`);
        }
      }catch(e){console.warn('Could not save eps_actuals:',e)}
    }
  }catch(e){console.error('Failed to save fundamentals to sheet:',e)}
}

function getHeldTickers(){
  // Use computeOverview's holdMap if available
  if(cachedOverviewData){
    const tickers=new Set();
    for(const h of cachedOverviewData.allHoldings)tickers.add(h.ticker);
    return[...tickers];
  }
  const qtyMap={};
  for(const tx of allTransactions){
    if(!tx.ticker)continue;
    qtyMap[tx.ticker]=(qtyMap[tx.ticker]||0)+tx.qty;
  }
  return Object.entries(qtyMap).filter(([,q])=>q>0).map(([t])=>t);
}

// ================ LOAD ALL TRANSACTIONS ================
async function loadAllTransactions(){
  allTransactions=[];
  for(const broker of['ì‚¼ì„±','í‚¤ì›€']){
    try{
      const d=await sheetsGet(`${broker}!A:H`);
      const rows=d.values||[];let curDate='';
      for(let i=1;i<rows.length;i++){
        const r=rows[i];
        if(r[0]&&r[0]!=='')curDate=String(r[0]);
        allTransactions.push({
          broker,date:curDate,ticker:r[1]||'',qty:parseFloat(r[2])||0,
          price:parseFloat(r[3])||0,tax:parseFloat(r[4])||0,total:parseFloat(r[5])||0,
          split:r[6]||'',seq:r[7]||''
        });
      }
    }catch(e){}
  }
  // Load initial cash per broker from config tab
  try{
    const d=await sheetsGet('config!A1:B2');
    if(d.values){
      for(const row of d.values){
        if(row[0]==='initial_cash_ì‚¼ì„±')initialCashSS=parseFloat(row[1])||0;
        if(row[0]==='initial_cash_í‚¤ì›€')initialCashKW=parseFloat(row[1])||0;
        // Legacy: single initial_cash
        if(row[0]==='initial_cash'){initialCashSS=parseFloat(row[1])||0;initialCashKW=0}
      }
    }
  }catch(e){}

  // Normalize splits: only adjust rows that have a split marker
  // split=1/2 on a row means THAT row's qty and price are pre-split
  // -> qty *= 2, price /= 2 to convert to post-split terms
  for(const tx of allTransactions){
    // Store original qty/price for cash calculation before split adjustment
    tx.origQty=tx.qty;
    tx.origPrice=tx.price;
    if(tx.split&&tx.split!==''){
      const parts=tx.split.split('/');
      if(parts.length===2){
        const num=parseFloat(parts[0]),den=parseFloat(parts[1]);
        if(num&&den){
          const factor=den/num; // 1/2 -> 2
          tx.qty*=factor;
          tx.price/=factor;
        }
      }
    }
  }
}

// ================ PRICE FETCH ================
async function fetchPrices(tickers){
  const prices={};
  const proxies=[
    u=>`https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
    u=>`https://corsproxy.io/?${encodeURIComponent(u)}`,
  ];
  await Promise.all(tickers.map(async tk=>{
    const yahooUrl=`https://query1.finance.yahoo.com/v8/finance/chart/${tk}?interval=1d&range=10d`;
    for(const mkProxy of proxies){
      try{
        const r=await fetch(mkProxy(yahooUrl),{signal:AbortSignal.timeout(8000)});
        if(!r.ok)continue;
        const d=await r.json();
        const result=d.chart?.result?.[0];
        if(result){
          const meta=result.meta;
          const curPrice=meta.regularMarketPrice||0;
          const closes=result.indicators?.quote?.[0]?.close;
          const validCloses=closes?closes.filter(c=>c!=null):[];
          // Daily: previous trading day close
          const prevClose=validCloses.length>=2?validCloses[validCloses.length-2]:(meta.previousClose||0);
          // Weekly: close from ~5 trading days ago
          const weekClose=validCloses.length>=6?validCloses[validCloses.length-6]:(validCloses.length>0?validCloses[0]:0);
          const chgDay=prevClose?((curPrice-prevClose)/prevClose*100):0;
          const chgWeek=weekClose?((curPrice-weekClose)/weekClose*100):0;
          prices[tk]={current:curPrice,prevClose,chgDay,chgWeek};
          break;
        }
      }catch(e){continue}
    }
  }));
  return prices;
}

// ================ OVERVIEW ================
let cachedOverviewData=null; // {holdMap, allHoldings, cashByBroker}
let currentFilter='ì‚¼ì„±';

function setFilter(f,btn){
  currentFilter=f;
  document.querySelectorAll('.fbtn').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  if(cachedOverviewData)renderOverview();
}

function computeOverview(){
  // Sort chronologically: oldest date first, then by seq within same date
  const chronoTx=[...allTransactions].sort((a,b)=>{
    const dc=a.date.localeCompare(b.date);
    if(dc!==0)return dc;
    return (parseInt(a.seq)||0)-(parseInt(b.seq)||0);
  });

  const holdMap={};

  for(const tx of chronoTx){
    if(!tx.ticker)continue;
    const key=`${tx.broker}|${tx.ticker}`;
    if(!holdMap[key])holdMap[key]={broker:tx.broker,ticker:tx.ticker,totalQty:0,avgCost:0,realizedPL:0,realizedPLThisYear:0};
    const h=holdMap[key];

    if(tx.qty>0){
      // Buy: update moving average cost (no tax)
      const newCost=h.avgCost*h.totalQty+tx.qty*tx.price;
      h.totalQty+=tx.qty;
      h.avgCost=h.totalQty>0?newCost/h.totalQty:0;
    }else if(tx.qty<0){
      // Sell: realized P/L using moving avg cost basis
      const sellQty=Math.abs(tx.qty);
      const pl=sellQty*(tx.price-h.avgCost)-tx.tax;
      h.realizedPL+=pl;
      if(tx.date.startsWith('26'))h.realizedPLThisYear+=pl;
      h.totalQty-=sellQty;
      if(h.totalQty<=0){h.avgCost=0;h.totalQty=0}
    }
  }

  const allHoldings=Object.values(holdMap).filter(h=>h.totalQty>0).map(h=>({
    broker:h.broker,ticker:h.ticker,qty:h.totalQty,
    avgPrice:h.avgCost,
    purchasedAmt:h.avgCost*h.totalQty
  }));

  // Apply cached prices
  for(const h of allHoldings){
    const p=cachedPrices[h.ticker];
    h.currentPrice=p?p.current:0;
    h.chgDay=p?p.chgDay:0;
    h.chgWeek=p?p.chgWeek:0;
    h.marketValue=h.qty*h.currentPrice;
    h.unrealizedPL=h.marketValue-h.purchasedAmt;
  }

  const cashByBroker={ì‚¼ì„±:0,í‚¤ì›€:0};
  for(const tx of allTransactions){
    const q=tx.origQty!==undefined?tx.origQty:tx.qty;
    const p=tx.origPrice!==undefined?tx.origPrice:tx.price;
    if(q>0)cashByBroker[tx.broker]-=(Math.abs(q)*p+tx.tax);  // buy: cash out
    else if(q<0)cashByBroker[tx.broker]+=(Math.abs(q)*p-tx.tax); // sell: cash in
  }

  cachedOverviewData={holdMap,allHoldings,cashByBroker};
}

async function loadOverview(){
  // Legacy: full refresh (data + prices)
  if(!SHEET_ID||!SA_KEY){toast('Google Sheets ì„¤ì •ì„ ì™„ë£Œí•˜ì„¸ìš”','err');return}
  const el=document.getElementById('overviewContent');
  el.innerHTML='<p style="color:var(--text2);text-align:center;padding:32px"><span class="spinner"></span> ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
  await loadAllTransactions();
  const tickers=getHeldTickers();
  if(tickers.length)cachedPrices=await fetchPrices(tickers);
  saveCache();
  computeOverview();
  renderOverview();
}

function renderOverview(){
  if(!cachedOverviewData)return;
  const{holdMap,allHoldings,cashByBroker}=cachedOverviewData;
  const el=document.getElementById('overviewContent');
  const f=currentFilter;

  // Filter holdings
  const holdings=f==='all'?allHoldings:allHoldings.filter(h=>h.broker===f);
  holdings.sort((a,b)=>b.marketValue-a.marketValue);

  // Filter holdMap for realized P/L
  let totalRealizedPL=0,totalRealizedPLThisYear=0;
  for(const h of Object.values(holdMap)){
    if(f!=='all'&&h.broker!==f)continue;
    totalRealizedPL+=h.realizedPL;
    totalRealizedPLThisYear+=h.realizedPLThisYear;
  }

  let totalMarketValue=0,totalPurchased=0;
  for(const h of holdings){
    totalMarketValue+=h.marketValue;
    totalPurchased+=h.purchasedAmt;
  }

  // Cash
  let cash=0,initCash=0;
  if(f==='all'){
    initCash=initialCashSS+initialCashKW;
    cash=initCash+cashByBroker['ì‚¼ì„±']+cashByBroker['í‚¤ì›€'];
  }else if(f==='ì‚¼ì„±'){
    initCash=initialCashSS;
    cash=initialCashSS+cashByBroker['ì‚¼ì„±'];
  }else{
    initCash=initialCashKW;
    cash=initialCashKW+cashByBroker['í‚¤ì›€'];
  }
  const totalEarning=cash+totalMarketValue-initCash;

  let html='';

  // Summary cards
  const valueDiff=totalMarketValue-totalPurchased;
  const valueDiffPct=totalPurchased>0?((valueDiff/totalPurchased)*100):0;
  const vdCls=valueDiff>=0?'up':'dn';
  const totalAsset=cash+totalMarketValue;
  const cashPct=totalAsset>0?((cash/totalAsset)*100):0;
  const earnPct=initCash>0?((totalEarning/initCash)*100):0;
  const earnCls=totalEarning>=0?'up':'dn';
  const realCls=totalRealizedPL>=0?'up':'dn';
  const realYtdCls=totalRealizedPLThisYear>=0?'up':'dn';

  // Compute portfolio-level daily change (weighted by market value)
  let prevDayMktTotal=0, curDayMktTotal=0;
  for(const h of holdings){
    const p=cachedPrices[h.ticker];
    if(p&&p.prevClose&&p.current&&h.qty>0){
      prevDayMktTotal+=h.qty*p.prevClose;
      curDayMktTotal+=h.qty*p.current;
    }else{
      prevDayMktTotal+=h.marketValue;
      curDayMktTotal+=h.marketValue;
    }
  }
  const portfolioDayChgPct=prevDayMktTotal>0?((curDayMktTotal-prevDayMktTotal)/prevDayMktTotal*100):0;
  const portfolioDayChgAmt=curDayMktTotal-prevDayMktTotal;
  const dayChgCls=portfolioDayChgPct>=0?'c-up':'c-dn';
  const dayTriangle=portfolioDayChgPct>=0?'â–²':'â–¼';
  const totalDayChgAmt=portfolioDayChgAmt; // for total value card too

  html+=`<div class="summary-grid">`;

  // Top-left: í‰ê°€ì†ìµ
  const vdSign=valueDiff>=0?'+':'';
  html+=`<div class="sum-card">
    <div class="label">ğŸ“ˆ í‰ê°€ì†ìµ</div>
    <div style="display:flex;align-items:center;gap:20px">
      <div class="value ${vdCls}" style="white-space:nowrap">${vdSign}${fmtUSD(valueDiff)} <span style="font-size:13px">(${valueDiffPct>=0?'+':''}${valueDiffPct.toFixed(1)}%)</span> <span class="${dayChgCls}" style="font-size:11px">${dayTriangle}${Math.abs(portfolioDayChgPct).toFixed(1)}%</span></div>
      <div style="font-size:10px;color:var(--text2);line-height:1.6;font-family:'JetBrains Mono',monospace;white-space:nowrap;text-align:right">market <span style="display:inline-block;text-align:right">${fmtUSD(totalMarketValue)}</span><br>purcha <span style="display:inline-block;text-align:right">${fmtUSD(totalPurchased)}</span></div>
    </div>
  </div>`;

  // Top-right: Cash
  html+=`<div class="sum-card">
    <div class="label">ğŸ’µ Cash</div>
    <div style="display:flex;align-items:center;gap:20px">
      <div class="value" style="white-space:nowrap">${fmtUSD(cash)}</div>
      <div style="font-size:14px;color:var(--text2);font-family:'JetBrains Mono',monospace;white-space:nowrap;font-weight:600">(${cashPct.toFixed(0)}% of asset)</div>
    </div>
  </div>`;

  // Bottom-left: Total Value (clickable for chart)
  const earnSign=totalEarning>=0?'+':'';
  html+=`<div class="sum-card" onclick="showTotalValueChart()" style="cursor:pointer">
    <div class="label">ğŸ’° Total Value <span style="font-size:10px;color:var(--text3)">ğŸ“ˆ í´ë¦­</span></div>
    <div style="display:flex;align-items:center;gap:20px">
      <div class="value ${earnCls}" style="white-space:nowrap">${earnSign}${fmtUSD(totalEarning)} <span style="font-size:13px">(${earnPct>=0?'+':''}${earnPct.toFixed(1)}%)</span> <span class="${dayChgCls}" style="font-size:11px">${dayTriangle}${fmtUSD(Math.abs(totalDayChgAmt))}</span></div>
      <div style="font-size:10px;color:var(--text2);line-height:1.6;font-family:'JetBrains Mono',monospace;white-space:nowrap;text-align:right">asset&nbsp;&nbsp; <span style="display:inline-block;text-align:right">${fmtUSD(totalAsset)}</span><br>initial <span style="display:inline-block;text-align:right">${fmtUSD(initCash)}</span></div>
    </div>
  </div>`;

  // Bottom-right: Realized P/L (YTD first, then total)
  html+=`<div class="sum-card">
    <div class="label">ğŸ“Š Realized P/L</div>
    <div style="display:flex;align-items:baseline;gap:32px">
      <div><div class="sub">YTD</div><div class="value ${realYtdCls}">${fmtUSD(totalRealizedPLThisYear)}</div></div>
      <div><div class="sub">total</div><div class="value ${realCls}" style="font-size:16px">${fmtUSD(totalRealizedPL)}</div></div>
    </div>
  </div>`;

  html+=`</div>`;

  // Holdings
  if(f==='all'){
    // Merge same ticker across brokers
    const merged={};
    for(const h of allHoldings){
      if(!merged[h.ticker])merged[h.ticker]={ticker:h.ticker,qty:0,purchasedAmt:0,marketValue:0,unrealizedPL:0,currentPrice:h.currentPrice,chgDay:h.chgDay,chgWeek:h.chgWeek,parts:[]};
      const m=merged[h.ticker];
      m.qty+=h.qty;m.purchasedAmt+=h.purchasedAmt;m.marketValue+=h.marketValue;m.unrealizedPL+=h.unrealizedPL;
      m.parts.push({broker:h.broker,qty:h.qty});
    }
    const mergedList=Object.values(merged);mergedList.sort((a,b)=>b.marketValue-a.marketValue);

    if(mergedList.length===0){
      html+='<p style="color:var(--text2);text-align:center;padding:24px">ë³´ìœ  ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤</p>';
    }else{
      html+=`<div style="font-size:13px;font-weight:600;margin-bottom:8px">ë³´ìœ  ì¢…ëª© (${mergedList.length})</div>`;
      html+=holdingsHeader();
      for(const m of mergedList){
        const avgPrice=m.qty>0?m.purchasedAmt/m.qty:0;
        const plCls=m.unrealizedPL>=0?'c-up':'c-dn';
        let realPL=0,realPLYtd=0;
        for(const hv of Object.values(holdMap)){if(hv.ticker===m.ticker){realPL+=hv.realizedPL;realPLYtd+=hv.realizedPLThisYear}}
        const realCls=realPL>=0?'c-up':'c-dn';const realYtdCls=realPLYtd>=0?'c-up':'c-dn';
        let qtyStr;
        if(m.parts.length>1){
          const ps=m.parts.map(p=>`${p.qty}(${p.broker})`).join('+');
          qtyStr=`${m.qty}ì£¼ = ${ps}`;
        }else{
          qtyStr=`${m.qty}ì£¼ Â· ${m.parts[0].broker==='ì‚¼ì„±'?'ğŸ”µ':'ğŸ”´'} ${m.parts[0].broker}`;
        }
        html+=renderHoldCard(m.ticker,qtyStr,avgPrice,m.currentPrice,m.chgDay,m.chgWeek,m.unrealizedPL,plCls,m.marketValue,m.purchasedAmt,realPL,realCls,realPLYtd,realYtdCls);
      }
    }
    // Closed positions (all brokers: only show if closed in ALL brokers that traded it)
    // Group by ticker, collect per-broker info
    const tickerBrokers={};
    for(const hv of Object.values(holdMap)){
      if(hv.realizedPL===0&&hv.realizedPLThisYear===0&&hv.totalQty===0)continue;
      const tk=hv.ticker;
      if(!tickerBrokers[tk])tickerBrokers[tk]=[];
      tickerBrokers[tk].push(hv);
    }
    const closedList=[];
    for(const[tk,entries]of Object.entries(tickerBrokers)){
      // Only include if ALL broker entries have totalQty===0
      const allClosed=entries.every(e=>e.totalQty===0);
      if(!allClosed)continue;
      const realPL=entries.reduce((s,e)=>s+e.realizedPL,0);
      const realPLYtd=entries.reduce((s,e)=>s+e.realizedPLThisYear,0);
      if(realPL===0&&realPLYtd===0)continue;
      closedList.push({ticker:tk,realPL,realPLYtd,brokers:entries.map(e=>e.broker)});
    }
    closedList.sort((a,b)=>Math.abs(b.realPL)-Math.abs(a.realPL));
    if(closedList.length>0){
      html+=renderClosedSection(closedList);
    }
  }else{
    // Single broker view
    if(holdings.length===0){
      html+='<p style="color:var(--text2);text-align:center;padding:24px">ë³´ìœ  ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤</p>';
    }else{
      html+=`<div style="font-size:13px;font-weight:600;margin-bottom:8px">ë³´ìœ  ì¢…ëª© (${holdings.length})</div>`;
      html+=holdingsHeader();
      for(const h of holdings){
        const plCls=h.unrealizedPL>=0?'c-up':'c-dn';
        const key=`${h.broker}|${h.ticker}`;
        const hm=holdMap[key];
        const realPL=hm?hm.realizedPL:0;
        const realPLYtd=hm?hm.realizedPLThisYear:0;
        const realCls=realPL>=0?'c-up':'c-dn';
        const realYtdCls=realPLYtd>=0?'c-up':'c-dn';
        const qtyStr=`${h.qty}ì£¼ Â· ${h.broker==='ì‚¼ì„±'?'ğŸ”µ':'ğŸ”´'} ${h.broker}`;
        html+=renderHoldCard(h.ticker,qtyStr,h.avgPrice,h.currentPrice,h.chgDay,h.chgWeek,h.unrealizedPL,plCls,h.marketValue,h.purchasedAmt,realPL,realCls,realPLYtd,realYtdCls);
      }
    }
    // Closed positions (this broker only)
    const closedList=[];
    for(const hv of Object.values(holdMap)){
      if(hv.broker!==f)continue;
      if(hv.totalQty>0)continue;
      if(hv.realizedPL===0&&hv.realizedPLThisYear===0)continue;
      closedList.push({ticker:hv.ticker,realPL:hv.realizedPL,realPLYtd:hv.realizedPLThisYear,brokers:[hv.broker]});
    }
    closedList.sort((a,b)=>Math.abs(b.realPL)-Math.abs(a.realPL));
    if(closedList.length>0){
      html+=renderClosedSection(closedList);
    }
  }

  el.innerHTML=html;
}

function holdingsHeader(){
  return`<div class="hold-hdr">
    <div><span>í‰ê·  / í˜„ì¬ê°€ (ì „ì¼ëŒ€ë¹„; ì „ì£¼ëŒ€ë¹„)</span><span>í‰ê°€ì†ìµ</span></div>
    <div><span>í‰ê°€ê¸ˆì•¡</span><span>ë§¤ì…ê¸ˆì•¡</span></div>
    <div><span>P/E 12m (YOY%)</span><span>Rev 12m (YOY%)</span></div>
    <div><span>EPS est. chg 1w</span><span>EPS est. chg 1m</span></div>
    <div><span>Target (gap%)</span><span>Buy/H/S (1wk chg)</span></div>
    <div><span>ì‹¤í˜„ì†ìµ (YTD)</span><span>ì‹¤í˜„ì†ìµ (total)</span></div>
  </div>`;
}

function renderHoldCard(ticker,qtyStr,avgPrice,currentPrice,chgDay,chgWeek,unrealizedPL,plCls,marketValue,purchasedAmt,realPL,realCls,realPLYtd,realYtdCls){
  const plPct=purchasedAmt>0?((unrealizedPL/purchasedAmt)*100):0;
  const plPctStr=`(${plPct>=0?'+':''}${plPct.toFixed(1)}%)`;
  function fmtChg(v){
    v=v||0;
    const tri=v>0?'â–²':v<0?'â–¼':'';
    const cls=v>0?'c-up':v<0?'c-dn':'c-flat';
    return`<span class="${cls}">${tri}${v>=0?'+':''}${v.toFixed(2)}%</span>`;
  }
  const dash='<span style="color:var(--text3)">â€”</span>';

  const fund=cachedFundamentals[ticker];

  // Fiscal label for top row
  let fiscalLabel='';
  // Col3: P/E row + Revenue row
  let peRow=dash, revRow=dash;
  // Col4: EPS est change 1w / 1m
  let epsChg1w=dash, epsChg1m=dash;
  // Col5: Target + Rating (light gray)
  let targetStr=dash, ratingStr=dash;

  if(fund){
    // -- Fiscal label: "Dec 26 (16 anal)" --
    const analStr=fund.numAnalystsEps?` (${fund.numAnalystsEps} anal)`:'';
    fiscalLabel=`Dec ${(fund.targetYear||'26').slice(2)}${analStr}`;

    // -- Col3: P/E with YoY + Revenue with YoY --
    if(fund.pe12m!=null){
      const yoy=fund.epsYoy12m!=null?` <span style="color:var(--text3);font-size:9px">EPS</span>${fund.epsYoy12m>=0?'+':''}${fund.epsYoy12m.toFixed(0)}%`:'';
      peRow=`${fund.pe12m.toFixed(1)}${yoy}`;
    }
    if(fund.revNorm!=null){
      const revB=(fund.revNorm/1e9).toFixed(1);
      const yoy=fund.revYoy12m!=null?` (${fund.revYoy12m>=0?'+':''}${fund.revYoy12m.toFixed(0)}% YOY)`:'';
      revRow=`${revB}B${yoy}`;
    }

    // -- Col4: EPS estimate changes from fund_history --
    if(fund.epsNorm!=null){
      const ftk=getFundTicker(ticker);
      const hist=fundHistory[ftk]||[];
      if(hist.length>=2){
        const today=new Date().toISOString().slice(0,10);
        const d1w=new Date(Date.now()-7*86400000).toISOString().slice(0,10);
        const d1m=new Date(Date.now()-30*86400000).toISOString().slice(0,10);
        // Find closest entry on or before target date
        function findEps(targetDate){
          let best=null;
          for(const h of hist){
            if(h.date<=targetDate&&h.epsNorm!=null)best=h;
          }
          return best;
        }
        const eps1w=findEps(d1w);
        const eps1m=findEps(d1m);
        const currentEps=fund.epsNorm;
        if(eps1w&&eps1w.epsNorm>0){
          const chg=((currentEps-eps1w.epsNorm)/eps1w.epsNorm*100);
          const cls=chg>=0?'c-up':'c-dn';
          epsChg1w=`<span class="${cls}">${chg>=0?'+':''}${chg.toFixed(1)}%</span> <span style="color:var(--text3);font-size:9px">1w</span>`;
        }else{
          epsChg1w='<span style="color:var(--text3);font-size:10px">1w â€”</span>';
        }
        if(eps1m&&eps1m.epsNorm>0){
          const chg=((currentEps-eps1m.epsNorm)/eps1m.epsNorm*100);
          const cls=chg>=0?'c-up':'c-dn';
          epsChg1m=`<span class="${cls}">${chg>=0?'+':''}${chg.toFixed(1)}%</span> <span style="color:var(--text3);font-size:9px">1m</span>`;
        }else{
          epsChg1m='<span style="color:var(--text3);font-size:10px">1m â€”</span>';
        }
      }else{
        epsChg1w='<span style="color:var(--text3);font-size:10px">1w â€”</span>';
        epsChg1m='<span style="color:var(--text3);font-size:10px">1m â€”</span>';
      }
    }

    // -- Col5: Target price + Rating (light gray) --
    if(fund.targetPrice!=null&&fund.price>0){
      const gap=((fund.targetPrice-fund.price)/fund.price*100);
      targetStr=`<span style="color:var(--text3)">$${fund.targetPrice.toFixed(0)} (${gap>=0?'+':''}${gap.toFixed(0)}% gap)</span>`;
    }
    const buyN=(fund.strongBuy||0)+(fund.buy||0);
    const holdN=fund.hold||0;
    const sellN=(fund.sell||0)+(fund.strongSell||0);
    if(buyN+holdN+sellN>0){
      ratingStr=`<span style="color:var(--text3)">${buyN}(-)/${holdN}(-)/${sellN}(-)</span>`;
    }
  }

  return`<div class="hold-row" onclick="showHistory('${ticker}')">
    <div class="hold-top">
      <span class="hold-ticker">${ticker}</span>
      <span></span>
      <span class="hold-fiscal">${fiscalLabel}</span>
      <span class="hold-qty">${qtyStr}</span>
    </div>
    <div class="hold-grid">
      <div>
        <div class="val">${avgPrice.toFixed(2)} / ${currentPrice.toFixed(2)} (${fmtChg(chgDay)}; ${fmtChg(chgWeek)})</div>
        <div class="val ${plCls}" style="font-size:13px;font-weight:600">${fmtUSD(unrealizedPL)} <span style="font-size:11px;font-weight:400">${plPctStr}</span></div>
      </div>
      <div>
        <div class="val">${fmtUSD(marketValue)}</div>
        <div class="val">${fmtUSD(purchasedAmt)}</div>
      </div>
      <div>
        <div class="val">${peRow}</div>
        <div class="val">${revRow}</div>
      </div>
      <div>
        <div class="val">${epsChg1w}</div>
        <div class="val">${epsChg1m}</div>
      </div>
      <div>
        <div class="val">${targetStr}</div>
        <div class="val">${ratingStr}</div>
      </div>
      <div>
        <div class="val ${realYtdCls}">${fmtUSD(realPLYtd)}</div>
        <div class="val ${realCls}">${fmtUSD(realPL)}</div>
      </div>
    </div>
  </div>`;
}

function renderClosedSection(closedList){
  const totalReal=closedList.reduce((s,c)=>s+c.realPL,0);
  const totalYtd=closedList.reduce((s,c)=>s+c.realPLYtd,0);
  const tCls=totalReal>=0?'c-up':'c-dn';
  const yCls=totalYtd>=0?'c-up':'c-dn';
  let html=`<div style="margin-top:16px">
    <div class="closed-toggle" onclick="this.parentElement.classList.toggle('closed-open')" style="cursor:pointer;display:flex;align-items:center;gap:8px;padding:8px 0">
      <span style="font-size:13px;font-weight:600;color:var(--text3)">ë§¤ë„ ì™„ë£Œ (${closedList.length})</span>
      <span style="font-size:11px;color:var(--text3)">ì‹¤í˜„ <span class="${tCls}">${fmtUSD(totalReal)}</span> Â· YTD <span class="${yCls}">${fmtUSD(totalYtd)}</span></span>
      <span class="closed-arrow" style="font-size:10px;color:var(--text3);margin-left:auto;transition:transform .2s">â–¶</span>
    </div>
    <div class="closed-cards" style="display:none">`;
  for(const c of closedList){
    const rCls=c.realPL>=0?'c-up':'c-dn';
    const yC=c.realPLYtd>=0?'c-up':'c-dn';
    const brokerStr=c.brokers.map(b=>b==='ì‚¼ì„±'?'ğŸ”µ':'ğŸ”´').join('');
    html+=`<div class="hold-row" onclick="showHistory('${c.ticker}')" style="opacity:0.7">
      <div style="display:flex;align-items:baseline;gap:10px;padding:4px 0">
        <span class="hold-ticker">${c.ticker}</span>
        <span style="font-size:11px;color:var(--text3)">${brokerStr} 0ì£¼</span>
        <span style="margin-left:auto;font-size:12px;font-family:'JetBrains Mono',monospace">
          <span style="color:var(--text3);font-size:10px">YTD</span> <span class="${yC}">${fmtUSD(c.realPLYtd)}</span>
          <span style="color:var(--text3);font-size:10px;margin-left:8px">total</span> <span class="${rCls}">${fmtUSD(c.realPL)}</span>
        </span>
      </div>
    </div>`;
  }
  html+=`</div></div>`;
  return html;
}

function sumCard(label,value,sub,cls=''){
  return`<div class="sum-card"><div class="label">${label}</div><div class="value ${cls}">${value}</div>${sub?`<div class="sub">${sub}</div>`:''}</div>`;
}
function sumCard2(label,value,right,cls=''){
  return`<div class="sum-card"><div class="label">${label}</div><div style="display:flex;align-items:baseline;gap:6px"><div class="value ${cls}">${value}</div><div class="sub" style="margin-top:0">${right}</div></div></div>`;
}

// ================ TOTAL VALUE CHART ================
let chartTxStates={};    // date -> {cash, positions:{tk:{qty,avgCost}}, totalValue}
let chartTxDates=[];     // sorted tx dates
let chartBenchData={};   // {TQQQ:[{date,close}], ...}
let chartPeriod='total';
let chartMode='norm';    // 'norm' or 'chg'
let chartBenches=new Set(['TQQQ','%5ESOX','IWM']);

const BENCH_META={
  TQQQ:{color:'#888',label:'TQQQ'},
  QQQ:{color:'#ab47bc',label:'QQQ'},
  '%5ESOX':{color:'#66bb6a',label:'SOX'},
  IWM:{color:'#ffa726',label:'Russell'}
};
const HOLD_COLORS=['#4fc3f7','#ff7043','#ab47bc','#66bb6a','#ffa726','#ef5350','#78909c','#fff176'];
const HOLD_GROUPS=[
  {label:'tsla',tickers:['TSLL','TSLA','TER','XPEV']},
  {label:'nvd+amd',tickers:['AMDL','AMD','NVDL','NVDA']},
  {label:'tqqq',tickers:['TQQQ']},
  {label:'soxl+mu',tickers:['SOXL','MU','SNDK']},
  {label:'ggll+avgo',tickers:['GGLL','AVGO','AVL']},
  {label:'cls',tickers:['CLS','CRDO','CIEN']},
  {label:'fslr+gev',tickers:['FSLR','GEV','CAT','BE']},
];
let chartBottomMode='pct'; // 'abs' or 'pct'

function setChartPeriod(p,btn){
  chartPeriod=p;
  // Clear all period buttons (main + year)
  const grp=btn.closest('.chart-grp');
  if(grp)grp.querySelectorAll('.cbtn').forEach(b=>b.classList.remove('on'));
  const ybEl=document.getElementById('yearButtons');
  if(ybEl)ybEl.querySelectorAll('.cbtn').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  redrawChart();
}
function setChartMode(m,btn){
  chartMode=m;
  btn.parentElement.querySelectorAll('.cbtn').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  redrawChart();
}
function setBottomMode(m,btn){
  chartBottomMode=m;
  btn.parentElement.querySelectorAll('.cbtn').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  redrawChart();
}
function toggleBench(tk,btn){
  if(chartBenches.has(tk))chartBenches.delete(tk);else chartBenches.add(tk);
  btn.classList.toggle('on');
  if(chartBenches.has(tk)&&!chartBenchData[tk]){
    fetchBenchmark(tk).then(()=>redrawChart());
  }else{
    redrawChart();
  }
}

async function fetchBenchmark(ticker){
  const el=document.getElementById('chartContent');
  el.innerHTML=`<p style="color:var(--text2);text-align:center;padding:32px"><span class="spinner"></span> ${ticker} ê°€ê²© ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>`;
  try{
    const yUrl=`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=5y`;
    const proxies=[u=>`https://corsproxy.io/?${encodeURIComponent(u)}`];
    for(const mkP of proxies){
      try{
        const r=await fetch(mkP(yUrl),{signal:AbortSignal.timeout(15000)});
        if(!r.ok)continue;
        const d=await r.json();
        const ts=d.chart?.result?.[0]?.timestamp||[];
        const closes=d.chart?.result?.[0]?.indicators?.quote?.[0]?.close||[];
        const arr=[];
        for(let i=0;i<ts.length;i++){
          if(closes[i]==null)continue;
          const dt=new Date(ts[i]*1000);
          const yy=String(dt.getFullYear()).slice(2);
          const mm=String(dt.getMonth()+1).padStart(2,'0');
          const dd=String(dt.getDate()).padStart(2,'0');
          arr.push({date:`${yy}${mm}${dd}`,close:closes[i]});
        }
        if(arr.length>0){chartBenchData[ticker]=arr;break}
      }catch(e){continue}
    }
  }catch(e){console.error(`${ticker} fetch error:`,e)}
  if(!chartBenchData[ticker])chartBenchData[ticker]=[];
}

async function showTotalValueChart(){
  switchTab('chart');
  const el=document.getElementById('chartContent');
  el.innerHTML='<p style="color:var(--text2);text-align:center;padding:32px"><span class="spinner"></span> ì°¨íŠ¸ ë°ì´í„° ê³„ì‚° ì¤‘...</p>';

  const chronoTx=[...allTransactions].sort((a,b)=>a.date.localeCompare(b.date));
  if(chronoTx.length===0){el.innerHTML='<p style="color:var(--text2)">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>';return}

  // Build position state at each transaction date
  // posState[date] = {cash, positions:{ticker:{qty,avgCost}}, totalValue (approx)}
  const posMap={}; // ticker -> {qty, avgCost}
  let cashSS=initialCashSS, cashKW=initialCashKW;
  const txDateStates={}; // date -> state snapshot
  let lastDate=null;

  function captureState(date,txPrices){
    const positions={};
    let mktVal=0;
    for(const[tk,p] of Object.entries(posMap)){
      if(p.qty>0){
        positions[tk]={qty:p.qty,avgCost:p.avgCost};
        mktVal+=p.qty*(txPrices[tk]||p.avgCost);
      }
    }
    txDateStates[date]={cash:cashSS+cashKW,positions:{...positions},totalValue:cashSS+cashKW+mktVal};
  }

  const txPrices={}; // last known tx price per ticker
  for(const tx of chronoTx){
    if(!tx.ticker)continue;
    const tk=tx.ticker;
    if(!posMap[tk])posMap[tk]={qty:0,avgCost:0};
    const pos=posMap[tk];
    txPrices[tk]=tx.price;

    if(tx.qty>0){
      const newCost=pos.avgCost*pos.qty+tx.qty*tx.price;
      pos.qty+=tx.qty;
      pos.avgCost=pos.qty>0?newCost/pos.qty:0;
      if(tx.broker==='ì‚¼ì„±')cashSS-=(tx.qty*tx.price+tx.tax);
      else cashKW-=(tx.qty*tx.price+tx.tax);
    }else if(tx.qty<0){
      const sq=Math.abs(tx.qty);
      pos.qty-=sq;
      if(pos.qty<=0){pos.qty=0;pos.avgCost=0}
      if(tx.broker==='ì‚¼ì„±')cashSS+=(sq*tx.price-tx.tax);
      else cashKW+=(sq*tx.price-tx.tax);
    }

    if(tx.date!==lastDate){
      if(lastDate)captureState(lastDate,txPrices);
      lastDate=tx.date;
    }
  }
  if(lastDate)captureState(lastDate,txPrices);

  // Update latest state's totalValue using actual current market prices
  // This ensures chart matches overview's totalAsset calculation
  const latestDate=lastDate;
  if(latestDate&&txDateStates[latestDate]){
    const ls=txDateStates[latestDate];
    let mktVal=0;
    for(const[tk,p] of Object.entries(ls.positions)){
      const curPrice=cachedPrices[tk]&&cachedPrices[tk].current?cachedPrices[tk].current:(txPrices[tk]||p.avgCost);
      mktVal+=p.qty*curPrice;
    }
    ls.totalValue=ls.cash+mktVal;
  }

  // Store final state for today
  chartTxStates=txDateStates;
  chartTxDates=Object.keys(txDateStates).sort();

  // Fetch all enabled benchmarks (+ always fetch TQQQ for date axis)
  const toFetch=new Set([...chartBenches,'TQQQ']);
  for(const tk of toFetch){
    if(!chartBenchData[tk])await fetchBenchmark(tk);
  }

  redrawChart();
}

// Get position state at any date (carry forward from last tx date)
function getStateAtDate(date){
  let best=null;
  for(let i=chartTxDates.length-1;i>=0;i--){
    if(chartTxDates[i]<=date){best=chartTxStates[chartTxDates[i]];break}
  }
  return best;
}

function redrawChart(){
  const el=document.getElementById('chartContent');
  if(chartTxDates.length<1)return;

  // Use TQQQ daily dates as master x-axis (all market days)
  let masterDates=[];
  const tqqqArr=chartBenchData['TQQQ']||[];
  if(tqqqArr.length>0){
    masterDates=tqqqArr.map(d=>d.date).sort();
  }else{
    masterDates=[...chartTxDates];
  }

  // Filter to start from first transaction
  const firstTxDate=chartTxDates[0];
  masterDates=masterDates.filter(d=>d>=firstTxDate);

  // Populate year buttons
  const years=new Set();
  for(const d of masterDates)years.add('20'+d.slice(0,2));
  const ybEl=document.getElementById('yearButtons');
  if(ybEl){
    let yhtml='';
    for(const y of [...years].sort()){
      const on=chartPeriod===y?'on':'';
      yhtml+=`<button class="cbtn ${on}" onclick="setChartPeriod('${y}',this)" style="font-size:10px">${y}</button>`;
    }
    ybEl.innerHTML=yhtml;
  }

  const allMasterDates=[...masterDates]; // save before period filter

  // Period filter
  if(chartPeriod!=='total'){
    const now=new Date();
    let cutoff,cutEnd=null;
    if(chartPeriod==='1y')cutoff=new Date(now.getFullYear()-1,now.getMonth(),now.getDate());
    else if(chartPeriod==='6m')cutoff=new Date(now.getFullYear(),now.getMonth()-6,now.getDate());
    else if(chartPeriod==='3m')cutoff=new Date(now.getFullYear(),now.getMonth()-3,now.getDate());
    else if(/^\d{4}$/.test(chartPeriod)){
      // Year filter: e.g. "2025"
      const yr=parseInt(chartPeriod);
      cutoff=new Date(yr,0,1);
      cutEnd=new Date(yr,11,31);
    }
    if(cutoff){
      const cutStr=String(cutoff.getFullYear()).slice(2)+String(cutoff.getMonth()+1).padStart(2,'0')+String(cutoff.getDate()).padStart(2,'0');
      let filtered;
      if(cutEnd){
        const endStr=String(cutEnd.getFullYear()).slice(2)+String(cutEnd.getMonth()+1).padStart(2,'0')+String(cutEnd.getDate()).padStart(2,'0');
        filtered=masterDates.filter(d=>d>=cutStr&&d<=endStr);
        // For year filter: prepend last trading day of previous year as starting point
        const prevDay=masterDates.filter(d=>d<cutStr);
        if(prevDay.length>0){
          filtered=[prevDay[prevDay.length-1],...filtered];
        }
      }else{
        filtered=masterDates.filter(d=>d>=cutStr);
      }
      if(filtered.length>=2)masterDates=filtered;
    }
  }

  if(masterDates.length<2){el.innerHTML='<p style="color:var(--text2)">ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤</p>';return}

  // Benchmark lookups
  function makeLookup(arr){
    const map={};for(const t of arr)map[t.date]=t.close;
    const dates=arr.map(t=>t.date).sort();
    return{map,dates};
  }
  function findPrice(lookup,date){
    if(lookup.map[date])return lookup.map[date];
    for(let i=lookup.dates.length-1;i>=0;i--){
      if(lookup.dates[i]<=date)return lookup.map[lookup.dates[i]];
    }
    return null;
  }

  const lookups={};
  for(const tk of chartBenches){
    if(chartBenchData[tk])lookups[tk]=makeLookup(chartBenchData[tk]);
  }

  const baseBench={};
  for(const tk of chartBenches){
    if(lookups[tk])baseBench[tk]=findPrice(lookups[tk],masterDates[0]);
  }

  // For top chart: interpolate totalValue between tx dates using benchmark movement
  // Use TQQQ as proxy for portfolio price movement between transactions
  const tqqqLookup=chartBenchData['TQQQ']?makeLookup(chartBenchData['TQQQ']):null;

  // Build chart data for each market day
  const groupLabels=HOLD_GROUPS.map(g=>g.label);
  const chartData=[];
  let prevTotalValue=null;

  for(let di=0;di<masterDates.length;di++){
    const date=masterDates[di];
    const dateLabel='20'+date.slice(0,2)+'.'+date.slice(2,4)+'.'+date.slice(4,6);
    const state=getStateAtDate(date);
    if(!state)continue;

    // Bottom chart: cost basis per group (qty * avgCost) â€” stable between txs
    const entry={date:dateLabel,cash:state.cash};
    let totalCostBasis=0;
    for(const g of HOLD_GROUPS){
      let sum=0;
      for(const tk of g.tickers){
        if(state.positions[tk])sum+=state.positions[tk].qty*state.positions[tk].avgCost;
      }
      entry['g_'+g.label]=sum;
      totalCostBasis+=sum;
    }
    entry.purchasedAmt=totalCostBasis;

    // Top chart: totalValue
    // On tx dates, use the recorded totalValue
    // Between tx dates, estimate using TQQQ movement as proxy
    let totalValue=state.totalValue;
    // Find which tx date this state came from
    let stateDate=null;
    for(let i=chartTxDates.length-1;i>=0;i--){
      if(chartTxDates[i]<=date){stateDate=chartTxDates[i];break}
    }
    if(stateDate&&stateDate!==date&&tqqqLookup){
      // Interpolate: adjust holdings portion by TQQQ movement
      const tqAtState=findPrice(tqqqLookup,stateDate);
      const tqNow=findPrice(tqqqLookup,date);
      if(tqAtState&&tqNow&&tqAtState>0){
        const holdingsAtState=state.totalValue-state.cash;
        const ratio=tqNow/tqAtState;
        totalValue=state.cash+holdingsAtState*ratio;
      }
    }
    entry.totalValue=totalValue;

    // Market-value-based group values (for % mode)
    // On tx date: derive per-group market value proportional to cost basis share of holdings
    // Between tx dates: scale those by TQQQ movement
    const holdMktAtState=state.totalValue-state.cash;
    const holdCostAtState=totalCostBasis||1;
    // Per-group market value at state date = group_cost_basis * (total_holdings_mkt / total_cost_basis)
    const mktRatio=holdMktAtState/holdCostAtState;

    if(stateDate&&stateDate!==date&&tqqqLookup){
      const tqAtState=findPrice(tqqqLookup,stateDate);
      const tqNow=findPrice(tqqqLookup,date);
      if(tqAtState&&tqNow&&tqAtState>0){
        const priceRatio=tqNow/tqAtState;
        for(const g of HOLD_GROUPS){
          const groupMktAtState=entry['g_'+g.label]*mktRatio;
          entry['mv_'+g.label]=groupMktAtState*priceRatio;
        }
        // Cash for % mode: totalValue - sum(mv_)
        let sumMv=0;
        for(const g of HOLD_GROUPS)sumMv+=entry['mv_'+g.label];
        entry.mvCash=totalValue-sumMv;
      }else{
        for(const g of HOLD_GROUPS)entry['mv_'+g.label]=entry['g_'+g.label]*mktRatio;
        entry.mvCash=state.cash;
      }
    }else{
      for(const g of HOLD_GROUPS){
        entry['mv_'+g.label]=entry['g_'+g.label]*mktRatio;
      }
      entry.mvCash=state.cash;
    }

    if(chartMode==='norm'){
      if(di===0){entry._baseValue=totalValue}
      const baseVal=chartData.length>0?chartData[0]._baseValue:totalValue;
      entry.portfolio=(totalValue/baseVal)*100;
      for(const tk of chartBenches){
        if(!lookups[tk]||!baseBench[tk])continue;
        const p=findPrice(lookups[tk],date);
        entry[tk]=p?((p/baseBench[tk])*100):null;
      }
    }else{
      // Change% mode: daily
      if(prevTotalValue!=null&&totalCostBasis>0){
        entry.portfolio=((totalValue-prevTotalValue)/totalCostBasis*100);
      }else{
        entry.portfolio=null;
      }
      for(const tk of chartBenches){
        if(!lookups[tk])continue;
        const p=findPrice(lookups[tk],date);
        if(di>0){
          const pp=findPrice(lookups[tk],masterDates[di-1]);
          entry[tk]=(p&&pp&&pp>0)?((p-pp)/pp*100):null;
        }else{entry[tk]=null}
      }
    }
    prevTotalValue=totalValue;

    if(chartMode==='chg'&&entry.portfolio==null&&di>0)continue;
    if(di===0&&chartMode==='chg')continue;
    chartData.push(entry);
  }

  // Store baseValue for legend
  const baseValue=chartData.length>0&&chartData[0]._baseValue?chartData[0]._baseValue:1;

  // Fix last data point: use actual current prices instead of TQQQ interpolation
  // This ensures chart endpoint matches overview totalAsset exactly
  // Compute actualTotalAsset for the true latest date (using current market prices)
  let actualTotalAsset=null;
  const trueLastDate=allMasterDates[allMasterDates.length-1];
  const trueLastState=getStateAtDate(trueLastDate);
  if(trueLastState){
    let actualMktVal=0;
    for(const[tk,pos] of Object.entries(trueLastState.positions)){
      if(pos.qty>0){
        const cp=cachedPrices[tk];
        const price=cp&&cp.current?cp.current:pos.avgCost;
        actualMktVal+=pos.qty*price;
      }
    }
    actualTotalAsset=trueLastState.cash+actualMktVal;
  }

  // Also fix the last chart data entry if it's the true latest date
  if(chartData.length>0){
    const lastEntry=chartData[chartData.length-1];
    const lastChartDate=masterDates[masterDates.length-1];
    if(lastChartDate===trueLastDate&&actualTotalAsset!=null){
      const oldTotal=lastEntry.totalValue;
      lastEntry.totalValue=actualTotalAsset;
      if(chartMode==='norm'&&chartData[0]._baseValue){
        lastEntry.portfolio=(actualTotalAsset/chartData[0]._baseValue)*100;
      }
      if(chartMode==='chg'&&chartData[0]._baseValue){
        lastEntry.portfolio=((actualTotalAsset/chartData[0]._baseValue)-1)*100;
      }
      console.log(`Chart endpoint fix: ${oldTotal.toFixed(0)} â†’ ${actualTotalAsset.toFixed(0)} (actual prices)`);
    }
  }

  renderCharts(el,chartData,[...chartBenches],groupLabels,baseValue,allMasterDates,actualTotalAsset);
}

function renderCharts(container,data,benchKeys,groupLabels,baseValue,allMasterDates,actualTotalAsset){
  const W=Math.min(container.clientWidth||800,1200);
  const H1=350, H2=200, gap=30;
  const totalH=H1+gap+H2;
  const pad={t:30,r:50,b:20,l:55};
  const pad2={t:20,r:50,b:40,l:55};

  const canvas=document.createElement('canvas');
  canvas.width=W*2;canvas.height=totalH*2;
  canvas.style.width=W+'px';canvas.style.height=totalH+'px';
  const ctx=canvas.getContext('2d');
  ctx.scale(2,2);
  ctx.fillStyle='#1a1d23';ctx.fillRect(0,0,W,totalH);

  const cW=W-pad.l-pad.r;

  function xPos(i){return pad.l+(i/(data.length-1||1))*cW}

  // ===== TOP CHART: Performance =====
  const cH1=H1-pad.t-pad.b;
  let y1Min=Infinity,y1Max=-Infinity;
  for(const d of data){
    if(d.portfolio<y1Min)y1Min=d.portfolio;
    if(d.portfolio>y1Max)y1Max=d.portfolio;
    for(const tk of benchKeys){
      if(d[tk]!=null){if(d[tk]<y1Min)y1Min=d[tk];if(d[tk]>y1Max)y1Max=d[tk]}
    }
  }
  const yr1=y1Max-y1Min||1;
  y1Min=Math.floor(y1Min-yr1*0.05);y1Max=Math.ceil(y1Max+yr1*0.05);
  if(y1Min<=0)y1Min=1; // log safety

  const useLog=chartMode==='norm';
  const logMin=useLog?Math.log(y1Min):y1Min;
  const logMax=useLog?Math.log(y1Max):y1Max;

  function yPos1(v){
    if(useLog){
      const lv=Math.log(Math.max(v,0.1));
      return pad.t+(1-(lv-logMin)/(logMax-logMin))*cH1;
    }
    return pad.t+(1-(v-y1Min)/(y1Max-y1Min))*cH1;
  }

  // Grid
  ctx.strokeStyle='#2a2d33';ctx.lineWidth=0.5;
  if(useLog){
    // Log scale grid: evenly spaced in log space
    for(let i=0;i<=5;i++){
      const lv=logMin+(logMax-logMin)*i/5;
      const v=Math.exp(lv);
      const y=yPos1(v);
      ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(W-pad.r,y);ctx.stroke();
      ctx.fillStyle='#888';ctx.font='10px JetBrains Mono, monospace';ctx.textAlign='right';
      ctx.fillText(v.toFixed(0),pad.l-6,y+3);
    }
  }else{
    for(let i=0;i<=5;i++){
      const v=y1Min+(y1Max-y1Min)*i/5;
      const y=yPos1(v);
      ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(W-pad.r,y);ctx.stroke();
      ctx.fillStyle='#888';ctx.font='10px JetBrains Mono, monospace';ctx.textAlign='right';
      ctx.fillText(v.toFixed(0)+'%',pad.l-6,y+3);
    }
  }

  // Baseline
  const baseline=chartMode==='chg'?0:100;
  if(y1Min<=baseline&&y1Max>=baseline){
    ctx.strokeStyle='#555';ctx.lineWidth=1;ctx.setLineDash([4,4]);
    ctx.beginPath();ctx.moveTo(pad.l,yPos1(baseline));ctx.lineTo(W-pad.r,yPos1(baseline));ctx.stroke();
    ctx.setLineDash([]);
  }

  // Benchmark lines
  const endYPos=[];
  for(const tk of benchKeys){
    const meta=BENCH_META[tk]||{color:'#888',label:tk};
    ctx.strokeStyle=meta.color;ctx.lineWidth=1.5;ctx.beginPath();
    let started=false;
    for(let i=0;i<data.length;i++){
      if(data[i][tk]==null)continue;
      if(!started){ctx.moveTo(xPos(i),yPos1(data[i][tk]));started=true}
      else ctx.lineTo(xPos(i),yPos1(data[i][tk]));
    }
    ctx.stroke();
    const lv=data[data.length-1][tk];
    if(lv!=null)endYPos.push({y:yPos1(lv),val:lv,color:meta.color,label:meta.label});
  }

  // Portfolio line
  ctx.strokeStyle='#4fc3f7';ctx.lineWidth=2.5;ctx.beginPath();
  ctx.moveTo(xPos(0),yPos1(data[0].portfolio));
  for(let i=1;i<data.length;i++)ctx.lineTo(xPos(i),yPos1(data[i].portfolio));
  ctx.stroke();

  const lastP=data[data.length-1].portfolio;
  endYPos.push({y:yPos1(lastP),val:lastP,color:'#4fc3f7',label:'Port'});

  // Spread labels
  endYPos.sort((a,b)=>a.y-b.y);
  for(let i=1;i<endYPos.length;i++){
    if(endYPos[i].y-endYPos[i-1].y<13)endYPos[i].y=endYPos[i-1].y+13;
  }

  ctx.font='bold 11px JetBrains Mono, monospace';ctx.textAlign='left';
  for(const ep of endYPos){
    ctx.fillStyle=ep.color;
    const suffix=chartMode==='chg'?'%':'';
    ctx.fillText(`${ep.val.toFixed(1)}${suffix}`,W-pad.r+4,ep.y+4);
  }

  // Legend
  ctx.font='11px JetBrains Mono, monospace';
  let lx=pad.l;
  ctx.fillStyle='#4fc3f7';ctx.fillText('â”€â”€ Portfolio',lx,18);lx+=100;
  for(const tk of benchKeys){
    const meta=BENCH_META[tk]||{color:'#888',label:tk};
    ctx.fillStyle=meta.color;ctx.fillText(`â”€â”€ ${meta.label}`,lx,18);lx+=90;
  }
  if(chartMode==='norm'&&baseValue>1){
    ctx.fillStyle='#555';ctx.fillText(`(base=${fmtUSD(baseValue)})`,lx,18);lx+=140;
  }
  if(useLog){
    ctx.fillStyle='#555';ctx.font='9px JetBrains Mono, monospace';
    ctx.fillText('log scale',W-pad.r-45,18);
  }

  // ===== BOTTOM CHART: Holdings + Cash (individual lines or %) =====
  const y2Top=H1+gap;
  const cH2=H2-pad2.t-pad2.b;
  const isPct=chartBottomMode==='pct';

  // Compute values for bottom chart
  // allLabels = groups + cash
  const allLabels=[...groupLabels,'cash'];
  const allColors=[...HOLD_COLORS.slice(0,groupLabels.length),'#ccc'];

  // Y range
  let y2Min=0, y2Max=0;
  for(const d of data){
    const totalAsset=d.cash+groupLabels.reduce((s,gl)=>s+(d['g_'+gl]||0),0);
    if(isPct){
      y2Max=35;
    }else{
      for(const gl of groupLabels){const v=d['g_'+gl]||0;if(v>y2Max)y2Max=v}
      if(d.cash>y2Max)y2Max=d.cash;
      if(d.purchasedAmt>y2Max)y2Max=d.purchasedAmt;
    }
  }
  if(!isPct)y2Max=Math.ceil(y2Max*1.1);
  if(y2Max===0)y2Max=100;

  function yPos2(v){return y2Top+pad2.t+(1-v/y2Max)*cH2}

  // Grid
  ctx.strokeStyle='#2a2d33';ctx.lineWidth=0.5;
  for(let i=0;i<=4;i++){
    const v=y2Max*i/4;
    const y=yPos2(v);
    ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(W-pad.r,y);ctx.stroke();
    ctx.fillStyle='#888';ctx.font='10px JetBrains Mono, monospace';ctx.textAlign='right';
    if(isPct){
      ctx.fillText(v.toFixed(0)+'%',pad.l-6,y+3);
    }else{
      const label=v>=1e6?(v/1e6).toFixed(0)+'M':v>=1e3?(v/1e3).toFixed(0)+'K':v.toFixed(0);
      ctx.fillText('$'+label,pad.l-6,y+3);
    }
  }

  // Draw individual lines for each group + cash
  // Clip to chart area for % mode
  ctx.save();
  ctx.beginPath();
  ctx.rect(pad.l,y2Top+pad2.t,cW,cH2);
  ctx.clip();

  const endLabels2=[];
  for(let gi=0;gi<allLabels.length;gi++){
    const gl=allLabels[gi];
    const color=allColors[gi];
    ctx.strokeStyle=color;ctx.lineWidth=1.2;ctx.beginPath();
    let lastVal=0;
    for(let i=0;i<data.length;i++){
      let val;
      if(isPct){
        // Use market-value based: mv_ for groups, mvCash for cash, totalValue as denominator
        const tv=data[i].totalValue||1;
        const raw=gl==='cash'?(data[i].mvCash!=null?data[i].mvCash:data[i].cash):(data[i]['mv_'+gl]||0);
        val=tv>0?(raw/tv*100):0;
      }else{
        val=gl==='cash'?data[i].cash:(data[i]['g_'+gl]||0);
      }
      if(i===0)ctx.moveTo(xPos(i),yPos2(val));
      else ctx.lineTo(xPos(i),yPos2(val));
      lastVal=val;
    }
    ctx.stroke();
    if(lastVal>0||gl==='cash')endLabels2.push({y:yPos2(Math.min(lastVal,y2Max)),val:lastVal,color,label:gl});
  }

  // Purchase amount line (dashed white) â€” only in abs mode
  if(!isPct){
    ctx.strokeStyle='#fff';ctx.lineWidth=1.5;ctx.setLineDash([6,3]);ctx.beginPath();
    ctx.moveTo(xPos(0),yPos2(data[0].purchasedAmt));
    for(let i=1;i<data.length;i++)ctx.lineTo(xPos(i),yPos2(data[i].purchasedAmt));
    ctx.stroke();ctx.setLineDash([]);
    const lastPurch=data[data.length-1].purchasedAmt;
    endLabels2.push({y:yPos2(lastPurch),val:lastPurch,color:'#fff',label:'ì´ë§¤ìˆ˜'});
  }

  ctx.restore(); // remove clip

  // Spread end labels
  endLabels2.sort((a,b)=>a.y-b.y);
  for(let i=1;i<endLabels2.length;i++){
    if(endLabels2[i].y-endLabels2[i-1].y<11)endLabels2[i].y=endLabels2[i-1].y+11;
  }

  ctx.font='bold 9px JetBrains Mono, monospace';ctx.textAlign='left';
  for(const ep of endLabels2){
    ctx.fillStyle=ep.color;
    if(isPct){
      ctx.fillText(`${ep.val.toFixed(0)}%`,W-pad.r+4,ep.y+3);
    }else{
      const v=ep.val;
      ctx.fillText('$'+(v>=1e3?(v/1e3).toFixed(0)+'K':v.toFixed(0)),W-pad.r+4,ep.y+3);
    }
  }

  // Bottom chart legend
  ctx.font='10px JetBrains Mono, monospace';
  let lx2=pad.l;
  if(!isPct){ctx.fillStyle='#fff';ctx.fillText('--- ì´ë§¤ìˆ˜',lx2,y2Top+12);lx2+=72}
  for(let i=0;i<allLabels.length;i++){
    ctx.fillStyle=allColors[i];
    ctx.fillText(`â”€â”€ ${allLabels[i]}`,lx2,y2Top+12);lx2+=75;
  }

  // Shared X axis labels (below bottom chart)
  ctx.fillStyle='#888';ctx.font='10px JetBrains Mono, monospace';ctx.textAlign='center';
  const xLabelStep=Math.max(1,Math.floor(data.length/8));
  for(let i=0;i<data.length;i+=xLabelStep){
    ctx.fillText(data[i].date.slice(2),xPos(i),y2Top+H2-pad2.b+16);
  }
  ctx.fillText(data[data.length-1].date.slice(2),xPos(data.length-1),y2Top+H2-pad2.b+16);

  container.innerHTML='';
  // Wrapper for canvas + tooltip
  const wrap=document.createElement('div');
  wrap.style.cssText='position:relative;display:inline-block';
  wrap.appendChild(canvas);

  // Group descriptions below chart
  const groupDesc=document.createElement('div');
  groupDesc.style.cssText='font:9px/1.6 "JetBrains Mono",monospace;color:#666;padding:4px 0 0 '+pad.l+'px';
  const descParts=HOLD_GROUPS.map((g,i)=>`<span style="color:${HOLD_COLORS[i%HOLD_COLORS.length]}">${g.label}</span>=${g.tickers.join('+')}`);
  groupDesc.innerHTML=descParts.join(', ');
  wrap.appendChild(groupDesc);

  // Tooltip div
  const tip=document.createElement('div');
  tip.style.cssText='display:none;position:absolute;pointer-events:none;background:rgba(20,22,28,0.95);border:1px solid #444;border-radius:6px;padding:8px 10px;font:11px/1.6 "JetBrains Mono",monospace;color:#ddd;z-index:10;white-space:nowrap';
  wrap.appendChild(tip);

  // Vertical crosshair line
  const vline=document.createElement('div');
  vline.style.cssText=`display:none;position:absolute;top:${pad.t}px;width:1px;background:rgba(255,255,255,0.2);pointer-events:none;height:${totalH-pad.t-pad2.b}px`;
  wrap.appendChild(vline);

  // Store chart metadata for hover
  const chartMeta={data,W,totalH,pad,pad2,H1,H2,gap,cW,y1Min,y1Max,y2Max,y2Top,cH1,cH2,
    benchKeys,groupLabels,allLabels,allColors,isPct,mode:chartMode};

  canvas.addEventListener('mousemove',function(e){
    const rect=canvas.getBoundingClientRect();
    const mx=(e.clientX-rect.left);
    const my=(e.clientY-rect.top);
    const cm=chartMeta;

    // Find nearest data index
    if(mx<cm.pad.l||mx>cm.W-cm.pad.r){tip.style.display='none';vline.style.display='none';return}
    const frac=(mx-cm.pad.l)/cm.cW;
    const idx=Math.round(frac*(cm.data.length-1));
    if(idx<0||idx>=cm.data.length){tip.style.display='none';vline.style.display='none';return}

    const d=cm.data[idx];
    const xPx=cm.pad.l+(idx/(cm.data.length-1||1))*cm.cW;

    // Show crosshair
    vline.style.display='block';
    vline.style.left=xPx+'px';

    // Build tooltip content
    let html=`<div style="color:#888;margin-bottom:4px">${d.date}</div>`;

    // Top chart values
    const suffix=cm.mode==='chg'?'%':'';
    const tvRound=d.totalValue>=0?'$'+Math.round(d.totalValue).toLocaleString('en-US'):'-$'+Math.round(Math.abs(d.totalValue)).toLocaleString('en-US');
    html+=`<div style="color:#4fc3f7">${d.portfolio.toFixed(1)}${suffix} <span style="color:#888">(${tvRound})</span></div>`;
    for(const tk of cm.benchKeys){
      const meta=BENCH_META[tk]||{color:'#888',label:tk};
      if(d[tk]!=null)html+=`<div style="color:${meta.color}">${meta.label}: ${d[tk].toFixed(1)}${suffix}</div>`;
    }

    // Divider
    html+='<div style="border-top:1px solid #333;margin:4px 0"></div>';

    // Bottom chart values
    for(let i=0;i<cm.allLabels.length;i++){
      const gl=cm.allLabels[i];
      const color=cm.allColors[i];
      let val;
      if(cm.isPct){
        const tv=d.totalValue||1;
        const raw=gl==='cash'?(d.mvCash!=null?d.mvCash:d.cash):(d['mv_'+gl]||0);
        val=tv>0?(raw/tv*100):0;
        html+=`<div style="color:${color}">${gl}: ${val.toFixed(1)}%</div>`;
      }else{
        val=gl==='cash'?d.cash:(d['g_'+gl]||0);
        if(val>0)html+=`<div style="color:${color}">${gl}: $${(val/1e3).toFixed(1)}K</div>`;
      }
    }
    if(!cm.isPct&&d.purchasedAmt>0){
      html+=`<div style="color:#fff">ì´ë§¤ìˆ˜: $${(d.purchasedAmt/1e3).toFixed(1)}K</div>`;
    }

    tip.innerHTML=html;
    tip.style.display='block';
    // Position tooltip
    let tx=xPx+12;
    if(tx+tip.offsetWidth>cm.W-10)tx=xPx-tip.offsetWidth-12;
    let ty=Math.max(10,my-tip.offsetHeight/2);
    tip.style.left=tx+'px';
    tip.style.top=ty+'px';
  });

  canvas.addEventListener('mouseleave',function(){
    tip.style.display='none';
    vline.style.display='none';
  });

  container.appendChild(wrap);

  // Period summary line (for the chosen period / chart data)
  if(data.length>1){
    const startVal=data[0].totalValue;
    const endVal=data[data.length-1].totalValue;
    const chg=endVal-startVal;
    const pct=startVal>0?((endVal/startVal-1)*100):0;
    const cls=chg>=0?'c-up':'c-dn';
    const periodLabel=chartPeriod==='total'?'Total':(chartPeriod==='1y'?'1Y':chartPeriod==='6m'?'6M':chartPeriod==='3m'?'3M':chartPeriod);
    const periodDiv=document.createElement('div');
    periodDiv.style.cssText='font:12px/1.8 "JetBrains Mono",monospace;padding:8px 0 0 0;color:#aaa';
    periodDiv.innerHTML=`<span style="color:#666">${periodLabel} (${data[0].date} â†’ ${data[data.length-1].date})</span>  ${fmtUSD(startVal)} â†’ ${fmtUSD(endVal)}  <span class="${cls}" style="font-weight:600">${chg>=0?'+':''}${fmtUSD(chg)} (${pct>=0?'+':''}${pct.toFixed(1)}%)</span>`;
    container.appendChild(periodDiv);
  }

  // Annual summary table: use ALL dates (not filtered by period)
  // Build totalValue for each market day from allMasterDates
  if(allMasterDates&&allMasterDates.length>1){
    const tqqqLk=chartBenchData['TQQQ']?{}:null;
    if(tqqqLk){for(const d of (chartBenchData['TQQQ']||[]))tqqqLk[d.date]=d.close}
    const lastMasterDate=allMasterDates[allMasterDates.length-1];
    const yearMap={};
    for(const date of allMasterDates){
      const state=getStateAtDate(date);
      if(!state)continue;
      let totalValue;
      // For the last date, use actual current prices if available
      if(date===lastMasterDate&&actualTotalAsset!=null){
        totalValue=actualTotalAsset;
      }else{
        totalValue=state.totalValue;
        let stateDate=null;
        for(let i=chartTxDates.length-1;i>=0;i--){
          if(chartTxDates[i]<=date){stateDate=chartTxDates[i];break}
        }
        if(stateDate&&stateDate!==date&&tqqqLk){
          const tqAt=tqqqLk[stateDate];
          const tqNow=tqqqLk[date];
          if(tqAt&&tqNow&&tqAt>0){
            totalValue=state.cash+(state.totalValue-state.cash)*(tqNow/tqAt);
          }
        }
      }
      const yr='20'+date.slice(0,2);
      if(!yearMap[yr])yearMap[yr]={first:totalValue,last:totalValue};
      yearMap[yr].last=totalValue;
    }
    const sortedYears=Object.keys(yearMap).sort().reverse(); // newest first
    if(sortedYears.length>0){
      let thtml='<table style="width:auto;margin-top:6px;border-collapse:collapse;font:11px/1.6 \'JetBrains Mono\',monospace">';
      thtml+='<tr style="color:var(--text3);font-size:10px"><th style="padding:2px 10px;text-align:left">ì—°ë„</th><th style="padding:2px 10px;text-align:right">ì‹œì‘</th><th style="padding:2px 10px;text-align:right">ì¢…ë£Œ</th><th style="padding:2px 10px;text-align:right">ë³€ë™</th><th style="padding:2px 10px;text-align:right">ìˆ˜ìµë¥ </th></tr>';
      const yearsByAsc=Object.keys(yearMap).sort();
      for(const yr of sortedYears){
        const yd=yearMap[yr];
        const ascIdx=yearsByAsc.indexOf(yr);
        const startVal=ascIdx>0?yearMap[yearsByAsc[ascIdx-1]].last:yd.first;
        const endVal=yd.last;
        const chg=endVal-startVal;
        const pct=startVal>0?((endVal/startVal-1)*100):0;
        const cls=chg>=0?'c-up':'c-dn';
        thtml+=`<tr><td style="padding:2px 10px">${yr}</td><td style="padding:2px 10px;text-align:right">${fmtUSD(startVal)}</td><td style="padding:2px 10px;text-align:right">${fmtUSD(endVal)}</td><td style="padding:2px 10px;text-align:right" class="${cls}">${chg>=0?'+':''}${fmtUSD(chg)}</td><td style="padding:2px 10px;text-align:right" class="${cls}">${pct>=0?'+':''}${pct.toFixed(1)}%</td></tr>`;
      }
      thtml+='</table>';
      const tableDiv=document.createElement('div');
      tableDiv.innerHTML=thtml;
      container.appendChild(tableDiv);
    }
  }
}

// ================ TICKER HISTORY ================
function showHistory(ticker){
  const el=document.getElementById('historyContent');
  const titleEl=document.getElementById('historyTitle');

  if(allTransactions.length===0&&SHEET_ID&&SA_KEY){
    loadAllTransactions().then(()=>showHistory(ticker));
    el.innerHTML='<p style="color:var(--text2);text-align:center;padding:32px"><span class="spinner"></span> ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
    return;
  }

  const txs=ticker?allTransactions.filter(t=>t.ticker===ticker):[...allTransactions];

  if(ticker){
    let totalBought=0,totalSold=0;
    for(const tx of txs){if(tx.qty>0)totalBought+=tx.qty;else totalSold+=Math.abs(tx.qty)}
    titleEl.innerHTML=`<span class="back-btn" onclick="event.stopPropagation();switchTab('overview')">â† ëŒì•„ê°€ê¸°</span> <span style="font-family:'JetBrains Mono',monospace;color:var(--accent)">${ticker}</span> <span style="font-size:12px;color:var(--text2);font-weight:400">ë§¤ìˆ˜ ${totalBought} / ë§¤ë„ ${totalSold} / ë³´ìœ  ${totalBought-totalSold}ì£¼</span>`;
  }else{
    titleEl.textContent='ì „ì²´ ê±°ë˜ ë‚´ì—­';
  }

  // Compute running average and per-tx realized P/L for each ticker
  // Need to do this per-ticker even in all-transactions view
  let runningAvgs={};  // key -> avg at that point
  let txRealizedPL={}; // key -> realized P/L for that sell tx

  // Get unique tickers in txs
  const tickersInView=[...new Set(txs.map(t=>t.ticker).filter(Boolean))];
  for(const tk of tickersInView){
    const tkTxs=allTransactions.filter(t=>t.ticker===tk).sort((a,b)=>{
      const dc=a.date.localeCompare(b.date);if(dc!==0)return dc;
      return(parseInt(a.seq)||0)-(parseInt(b.seq)||0);
    });
    let qty=0,cost=0;
    for(const tx of tkTxs){
      const k=`${tx.date}|${tx.seq}|${tx.broker}`;
      if(tx.qty>0){
        cost+=tx.qty*tx.price;qty+=tx.qty;
      }else if(tx.qty<0){
        const sellQty=Math.abs(tx.qty);
        const avgAtSale=qty>0?cost/qty:0;
        const pl=sellQty*(tx.price-avgAtSale)-tx.tax;
        txRealizedPL[k]=pl;
        if(qty>0)cost-=cost/qty*sellQty;
        qty-=sellQty;
      }
      runningAvgs[k]=qty>0?cost/qty:0;
    }
  }

  // Group by date, sort dates newest first
  const dateGroups={};
  for(const tx of txs){
    if(!dateGroups[tx.date])dateGroups[tx.date]=[];
    dateGroups[tx.date].push(tx);
  }
  const dates=Object.keys(dateGroups).sort((a,b)=>b.localeCompare(a));

  // Sort within each date by seq
  for(const date of dates){
    dateGroups[date].sort((a,b)=>(parseInt(a.seq)||0)-(parseInt(b.seq)||0));
  }

  let html='';

  // Per-ticker purchase amount chart (only when viewing single ticker)
  if(ticker){
    html+=`<div style="margin-bottom:12px">
      <div class="chart-grp" style="margin-bottom:8px">
        <button class="cbtn on" onclick="drawHistoryChart('${ticker}','total',this)">Total</button>
        <button class="cbtn" onclick="drawHistoryChart('${ticker}','1y',this)">1Y</button>
        <button class="cbtn" onclick="drawHistoryChart('${ticker}','6m',this)">6M</button>
      </div>
      <div id="historyChartArea"></div>
    </div>`;
  }

  html+=`<div class="tbl-wrap"><table class="t"><tr><th>ë‚ ì§œ</th><th>ì¦ê¶Œì‚¬</th><th>ì¢…ëª©</th><th>ë§¤ë§¤</th><th>ìˆ˜ëŸ‰</th><th>ë‹¨ê°€</th><th>ê¸ˆì•¡</th><th>ì‹¤í˜„</th></tr>`;

  for(const date of dates){
    const dTxs=dateGroups[date];
    html+=`<tr style="background:var(--surface2)"><td colspan="8" style="padding:8px;font-weight:600;color:var(--text)">${fmtDate(date)} <span style="font-weight:400;color:var(--text2);font-size:11px">(${dTxs.length}ê±´)</span></td></tr>`;

    for(const tx of dTxs){
      const cls=tx.qty>0?'c-buy':'c-sell';
      const side=tx.qty>0?'ë§¤ìˆ˜':'ë§¤ë„';
      const bk=tx.broker==='ì‚¼ì„±'?'ğŸ”µì‚¼ì„±':'ğŸ”´í‚¤ì›€';
      const amt=Math.abs(tx.qty)*tx.price;

      // Price with % from avg
      let priceStr=tx.price.toFixed(2);
      const k=`${tx.date}|${tx.seq}|${tx.broker}`;
      const avg=runningAvgs[k];
      if(ticker&&avg&&avg>0){
        const pctFromAvg=((tx.price-avg)/avg*100);
        const pctCls=pctFromAvg>=0?'c-buy':'c-sell';
        priceStr+=` <span class="${pctCls}" style="font-size:10px">(${pctFromAvg>=0?'+':''}${pctFromAvg.toFixed(1)}%)</span>`;
      }

      // Per-tx realized P/L (sells only)
      let plStr='';
      if(tx.qty<0&&txRealizedPL[k]!==undefined){
        const pl=txRealizedPL[k];
        const plC=pl>=0?'c-buy':'c-sell';
        plStr=`<span class="${plC}">${fmtUSD(pl)}</span>`;
      }

      html+=`<tr><td></td><td>${bk}</td><td><b style="cursor:pointer;color:#d0d4dc" onclick="event.stopPropagation();showHistory('${tx.ticker}')">${tx.ticker}</b></td><td class="${cls}">${side}</td><td class="${cls}">${tx.qty>0?'+':''}${tx.qty}</td><td>${priceStr}</td><td>${fmtUSD(amt)}</td><td>${plStr}</td></tr>`;
    }

    // Daily summary - indented to align with ë§¤ë§¤ column
    const buys=dTxs.filter(t=>t.qty>0);
    const sells=dTxs.filter(t=>t.qty<0);
    const buyQty=buys.reduce((s,t)=>s+t.qty,0);
    const sellQty=sells.reduce((s,t)=>s+Math.abs(t.qty),0);
    const buyAmt=buys.reduce((s,t)=>s+t.qty*t.price,0);
    const sellAmt=sells.reduce((s,t)=>s+Math.abs(t.qty)*t.price,0);
    const buyAvg=buyQty>0?(buyAmt/buyQty):0;
    const sellAvg=sellQty>0?(sellAmt/sellQty):0;
    // Sum realized P/L for the day
    let dayPL=0;
    for(const tx of dTxs){if(tx.qty<0){const k=`${tx.date}|${tx.seq}|${tx.broker}`;if(txRealizedPL[k]!==undefined)dayPL+=txRealizedPL[k]}}
    const dayPLStr=sells.length>0?`<span class="${dayPL>=0?'c-buy':'c-sell'}">${fmtUSD(dayPL)}</span>`:'';

    let sumParts=[];
    if(buyQty>0)sumParts.push(`<span class="c-buy">ë§¤ìˆ˜ ${buyQty}ì£¼ avg ${buyAvg.toFixed(2)} = ${fmtUSD(buyAmt)}</span>`);
    if(sellQty>0)sumParts.push(`<span class="c-sell">ë§¤ë„ ${sellQty}ì£¼ avg ${sellAvg.toFixed(2)} = ${fmtUSD(sellAmt)}</span>`);
    html+=`<tr style="background:var(--surface)"><td></td><td></td><td></td><td colspan="4" style="padding:6px 8px;font-size:11px;color:var(--text2)">${sumParts.join(' Â· ')}</td><td style="font-size:11px">${dayPLStr}</td></tr>`;
  }

  html+=`</table></div>`;
  el.innerHTML=html;
  switchTab('history');

  // Draw chart after DOM is ready
  if(ticker)setTimeout(()=>drawHistoryChart(ticker,'total'),50);
}

function drawHistoryChart(ticker,period,btn){
  if(btn){btn.parentElement.querySelectorAll('.cbtn').forEach(b=>b.classList.remove('on'));btn.classList.add('on')}
  const container=document.getElementById('historyChartArea');
  if(!container)return;

  // Build purchase amount over time for this ticker (sum across brokers)
  const tkTxs=allTransactions.filter(t=>t.ticker===ticker).sort((a,b)=>a.date.localeCompare(b.date)||(parseInt(a.seq)||0)-(parseInt(b.seq)||0));
  if(tkTxs.length===0){container.innerHTML='';return}

  let qty=0,cost=0;
  const snapshots=[]; // [{date, purchAmt}]
  let lastDate=null;
  for(const tx of tkTxs){
    if(tx.qty>0){cost+=tx.qty*tx.price;qty+=tx.qty}
    else if(tx.qty<0){
      const sq=Math.abs(tx.qty);
      if(qty>0)cost-=cost/qty*sq;
      qty-=sq;if(qty<=0){qty=0;cost=0}
    }
    if(tx.date!==lastDate){
      if(lastDate)snapshots.push({date:lastDate,purchAmt:cost});
      lastDate=tx.date;
    }
  }
  if(lastDate)snapshots.push({date:lastDate,purchAmt:cost});
  // Add today
  const now=new Date();
  const todayDate=String(now.getFullYear()).slice(2)+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0');
  if(snapshots.length>0&&snapshots[snapshots.length-1].date!==todayDate){
    snapshots.push({date:todayDate,purchAmt:snapshots[snapshots.length-1].purchAmt});
  }

  // Period filter
  let data=[...snapshots];
  if(period!=='total'){
    let cutoff;
    if(period==='1y')cutoff=new Date(now.getFullYear()-1,now.getMonth(),now.getDate());
    else if(period==='6m')cutoff=new Date(now.getFullYear(),now.getMonth()-6,now.getDate());
    const cutStr=String(cutoff.getFullYear()).slice(2)+String(cutoff.getMonth()+1).padStart(2,'0')+String(cutoff.getDate()).padStart(2,'0');
    // Find last snapshot before cutoff for starting value
    let startVal=0;
    for(let i=data.length-1;i>=0;i--){if(data[i].date<=cutStr){startVal=data[i].purchAmt;break}}
    data=data.filter(d=>d.date>=cutStr);
    if(data.length===0||data[0].date>cutStr){data.unshift({date:cutStr,purchAmt:startVal})}
  }
  if(data.length<1){container.innerHTML='';return}

  const W=Math.min(container.clientWidth||600,800);
  const H=150;
  const pad={t:20,r:45,b:30,l:50};
  const cW=W-pad.l-pad.r, cH=H-pad.t-pad.b;

  const canvas=document.createElement('canvas');
  canvas.width=W*2;canvas.height=H*2;
  canvas.style.width=W+'px';canvas.style.height=H+'px';
  const ctx=canvas.getContext('2d');
  ctx.scale(2,2);
  ctx.fillStyle='#1a1d23';ctx.fillRect(0,0,W,H);

  let yMax=0;
  for(const d of data)if(d.purchAmt>yMax)yMax=d.purchAmt;
  yMax=Math.ceil(yMax*1.15)||100;

  function xPos(i){return pad.l+(i/(data.length-1||1))*cW}
  function yPos(v){return pad.t+(1-v/yMax)*cH}

  // Grid
  ctx.strokeStyle='#2a2d33';ctx.lineWidth=0.5;
  for(let i=0;i<=3;i++){
    const v=yMax*i/3;
    const y=yPos(v);
    ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(W-pad.r,y);ctx.stroke();
    ctx.fillStyle='#888';ctx.font='9px JetBrains Mono, monospace';ctx.textAlign='right';
    const label=v>=1e3?'$'+(v/1e3).toFixed(0)+'K':'$'+v.toFixed(0);
    ctx.fillText(label,pad.l-4,y+3);
  }

  // Step line (purchase amount is step function)
  ctx.strokeStyle='#4fc3f7';ctx.lineWidth=2;ctx.beginPath();
  for(let i=0;i<data.length;i++){
    if(i===0){ctx.moveTo(xPos(i),yPos(data[i].purchAmt))}
    else{
      // Horizontal then vertical (step)
      ctx.lineTo(xPos(i),yPos(data[i-1].purchAmt));
      ctx.lineTo(xPos(i),yPos(data[i].purchAmt));
    }
  }
  ctx.stroke();

  // Fill area
  ctx.fillStyle='rgba(79,195,247,0.1)';ctx.beginPath();
  ctx.moveTo(xPos(0),yPos(0));
  for(let i=0;i<data.length;i++){
    if(i>0){ctx.lineTo(xPos(i),yPos(data[i-1].purchAmt))}
    ctx.lineTo(xPos(i),yPos(data[i].purchAmt));
  }
  ctx.lineTo(xPos(data.length-1),yPos(0));ctx.closePath();ctx.fill();

  // X labels
  ctx.fillStyle='#888';ctx.font='9px JetBrains Mono, monospace';ctx.textAlign='center';
  const xStep=Math.max(1,Math.floor(data.length/6));
  for(let i=0;i<data.length;i+=xStep){
    const d=data[i].date;
    ctx.fillText(d.slice(0,2)+'.'+d.slice(2,4)+'.'+d.slice(4,6),xPos(i),H-pad.b+14);
  }
  const lastD=data[data.length-1].date;
  ctx.fillText(lastD.slice(0,2)+'.'+lastD.slice(2,4)+'.'+lastD.slice(4,6),xPos(data.length-1),H-pad.b+14);

  // End value label
  const lastVal=data[data.length-1].purchAmt;
  ctx.font='bold 10px JetBrains Mono, monospace';ctx.textAlign='left';ctx.fillStyle='#4fc3f7';
  ctx.fillText('$'+(lastVal/1e3).toFixed(1)+'K',W-pad.r+4,yPos(lastVal)+4);

  // Title
  ctx.font='10px JetBrains Mono, monospace';ctx.fillStyle='#888';ctx.textAlign='left';
  ctx.fillText(`${ticker} ë§¤ì…ê¸ˆì•¡`,pad.l,14);

  container.innerHTML='';
  container.appendChild(canvas);
}

// ================ IMPORT ================
function parseImportText(text){
  const lines=text.trim().split('\n');const groups=[];let cur=null;
  for(let line of lines){
    line=line.trim();if(!line)continue;
    if(line.startsWith('#')){const m=line.match(/^#\s*(ì‚¼ì„±|í‚¤ì›€)\s+(\d{6})/);if(m){cur={broker:m[1],date:m[2],rows:[]};groups.push(cur)}continue}
    if(!cur)continue;
    const p=line.split(',').map(s=>s.trim());
    if(p.length>=3){const tk=p[0].toUpperCase(),qty=parseInt(p[1]),pr=parseFloat(p[2]),seq=p[3]?parseInt(p[3]):cur.rows.length+1;
      if(tk&&!isNaN(qty)&&!isNaN(pr))cur.rows.push({ticker:tk,qty,price:pr,seq})}
  }
  return groups;
}
function previewImport(){
  const groups=parseImportText(document.getElementById('impText').value);
  const el=document.getElementById('impPreview');
  if(!groups.length){el.innerHTML='<p style="color:var(--sell);font-size:12px">íŒŒì‹± ì‹¤íŒ¨. í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.</p>';return}
  let html='';
  for(const g of groups){
    const rate=TAX[g.broker];
    html+=`<div class="dg"><span class="l" style="color:var(--${g.broker==='ì‚¼ì„±'?'samsung':'kiwoom'})">${g.broker} ${fmtDate(g.date)}</span><span class="r">${g.rows.length}ê±´</span></div>`;
    html+=`<div class="tbl-wrap"><table class="t"><tr><th>seq</th><th>ì¢…ëª©</th><th>ìˆ˜ëŸ‰</th><th>ë‹¨ê°€</th><th>tax</th><th>total</th></tr>`;
    for(const r of g.rows){
      const tax=rd(Math.abs(r.qty)*r.price*rate),total=rd(Math.abs(r.qty)*r.price+tax),cls=r.qty>0?'c-buy':'c-sell';
      html+=`<tr><td>${r.seq}</td><td><b>${r.ticker}</b></td><td class="${cls}">${r.qty>0?'+':''}${r.qty}</td><td>${r.price.toFixed(4)}</td><td>${tax.toFixed(2)}</td><td>${total.toFixed(2)}</td></tr>`;
    }
    html+='</table></div>';
  }
  el.innerHTML=html;
}
async function doImport(){
  const groups=parseImportText(document.getElementById('impText').value);
  if(!groups.length){toast('íŒŒì‹±ëœ ë°ì´í„° ì—†ìŒ','err');return}
  if(!SHEET_ID||!SA_KEY){toast('Sheets ì„¤ì • í•„ìš”','err');return}
  const logEl=document.getElementById('impLog');logEl.innerHTML='';
  for(const g of groups){
    const rate=TAX[g.broker];
    const rows=g.rows.map((r,i)=>{const tax=rd(Math.abs(r.qty)*r.price*rate),total=rd(Math.abs(r.qty)*r.price+tax);
      return[i===0?parseInt(g.date):'',r.ticker,r.qty,r.price,tax,total,'',r.seq]});
    try{await sheetsInsertAtTop(g.broker,rows);addLog(logEl,`âœ… ${g.broker} ${fmtDate(g.date)}: ${rows.length}ê±´ ì €ì¥`,'ok')}
    catch(e){addLog(logEl,`âŒ ${g.broker} ì‹¤íŒ¨: ${e.message}`,'err')}
  }
  toast('ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ! Dataë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.','ok');
}

// ================ MANUAL ================
async function addManual(){
  const broker=document.getElementById('mBk').value,date=document.getElementById('mDt').value.trim(),
    ticker=document.getElementById('mTk').value.trim().toUpperCase(),side=document.getElementById('mSd').value,
    qtyRaw=parseInt(document.getElementById('mQt').value),price=parseFloat(document.getElementById('mPr').value);
  if(!date||!ticker||!qtyRaw||!price){toast('ëª¨ë“  í•­ëª© ì…ë ¥ í•„ìš”','err');return}
  if(!SHEET_ID||!SA_KEY){toast('Sheets ì„¤ì • í•„ìš”','err');return}
  const qty=side==='sell'?-Math.abs(qtyRaw):Math.abs(qtyRaw);
  const rate=TAX[broker],tax=rd(Math.abs(qty)*price*rate),total=rd(Math.abs(qty)*price+tax);
  try{
    await sheetsInsertAtTop(broker,[[parseInt(date),ticker,qty,price,tax,total,'',1]]);
    toast(`${ticker} ${side==='buy'?'ë§¤ìˆ˜':'ë§¤ë„'} ì €ì¥ ì™„ë£Œ`,'ok');
    document.getElementById('mTk').value='';document.getElementById('mQt').value='';document.getElementById('mPr').value='';
  }catch(e){toast('ì €ì¥ ì‹¤íŒ¨: '+e.message,'err')}
}

// ================ DATA VIEW ================
async function loadFromSheet(){
  if(!SHEET_ID||!SA_KEY){toast('Sheets ì„¤ì • í•„ìš”','err');return}
  const view=document.getElementById('dataView');
  view.innerHTML='<p style="color:var(--text2);text-align:center;padding:16px"><span class="spinner"></span> ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
  await loadAllTransactions();
  let html='';
  for(const broker of['ì‚¼ì„±','í‚¤ì›€']){
    const txs=allTransactions.filter(t=>t.broker===broker);
    if(!txs.length)continue;
    html+=`<div class="card bk-card ${broker==='ì‚¼ì„±'?'ss':'kw'}">`;
    html+=`<div class="card-hdr"><span class="ico">${broker==='ì‚¼ì„±'?'ğŸ”µ':'ğŸ”´'}</span>${broker} (${txs.length}ê±´)</div>`;
    const dates=[...new Set(txs.map(t=>t.date))];
    for(const date of dates.slice(0,20)){
      const dTxs=txs.filter(t=>t.date===date);
      const buys=dTxs.filter(t=>t.qty>0).length,sells=dTxs.filter(t=>t.qty<0).length;
      html+=`<div class="dg"><span class="l">${fmtDate(date)}</span><span class="r">ë§¤ìˆ˜${buys}/ë§¤ë„${sells}/${dTxs.length}ê±´</span></div>`;
      html+=`<div class="tbl-wrap"><table class="t"><tr><th>seq</th><th>ì¢…ëª©</th><th>ìˆ˜ëŸ‰</th><th>ë‹¨ê°€</th><th>tax</th><th>total</th></tr>`;
      for(const t of dTxs){const cls=t.qty>0?'c-buy':'c-sell';
        html+=`<tr><td>${t.seq}</td><td><b>${t.ticker}</b></td><td class="${cls}">${t.qty>0?'+':''}${t.qty}</td><td>${t.price.toFixed(4)}</td><td>${t.tax.toFixed(2)}</td><td>${t.total.toFixed(2)}</td></tr>`}
      html+='</table></div>';
    }
    if(dates.length>20)html+=`<p style="color:var(--text2);font-size:11px;margin-top:8px">...ì™¸ ${dates.length-20}ì¼</p>`;
    html+='</div>';
  }
  view.innerHTML=html||'<p style="color:var(--text2);text-align:center;padding:32px">ë°ì´í„° ì—†ìŒ</p>';
}
async function downloadXlsx(){
  if(!SHEET_ID||!SA_KEY){toast('Sheets ì„¤ì • í•„ìš”','err');return}
  try{const wb=XLSX.utils.book_new();
    for(const b of['ì‚¼ì„±','í‚¤ì›€']){const d=await sheetsGet(`${b}!A:H`);const ws=XLSX.utils.aoa_to_sheet(d.values||[]);XLSX.utils.book_append_sheet(wb,ws,b)}
    XLSX.writeFile(wb,`ë¯¸êµ­ì£¼ì‹ë‚´ì—­_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.xlsx`);toast('ë‹¤ìš´ë¡œë“œ ì™„ë£Œ','ok');
  }catch(e){toast('ì‹¤íŒ¨: '+e.message,'err')}
}

// ================ HELPERS ================
function rd(n){return Math.round(n*100)/100}
function fmtDate(d){d=String(d);return d.length===6?`20${d.slice(0,2)}-${d.slice(2,4)}-${d.slice(4,6)}`:d}
function fmtUSD(n){return(n>=0?'':'-')+'$'+Math.abs(n).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}
function addLog(el,msg,cls=''){const d=document.createElement('div');d.className=cls;d.textContent=`[${new Date().toLocaleTimeString()}] ${msg}`;el.appendChild(d);el.scrollTop=el.scrollHeight}
function toast(msg,type='ok'){const el=document.getElementById('toast');el.textContent=msg;el.className=`toast ${type} show`;setTimeout(()=>el.classList.remove('show'),2800)}
</script>
</body>
</html>
