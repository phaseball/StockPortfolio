<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Sunghoon's Portfolio Manager</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/11.1.0/jsrsasign-all-min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root {
  --bg:#0b0f19;--surface:#131a2b;--surface2:#1b2540;--surface3:#243054;
  --border:#2d3a5c;--text:#e2e8f4;--text2:#7b8bb5;--text3:#4e5f8a;
  --accent:#4a8eff;--accent2:#3672d9;--accentBg:rgba(74,142,255,.08);
  --samsung:#2962ff;--kiwoom:#e63962;
  --buy:#c62828;--buyBg:rgba(198,40,40,.1);
  --sell:#1565c0;--sellBg:rgba(21,101,192,.1);
  --warn:#ffc107;--radius:12px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Sans KR',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.app{max-width:960px;margin:0 auto;padding:12px}
.header{display:flex;align-items:center;gap:12px;padding:16px 4px 12px}
.logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--samsung),var(--kiwoom));display:flex;align-items:center;justify-content:center;font-size:18px}
.header h1{font-size:18px;font-weight:700;letter-spacing:-.3px}
.header .sub{font-size:11px;color:var(--text2)}
nav{display:flex;gap:3px;background:var(--surface);border-radius:var(--radius);padding:3px;margin-bottom:16px;overflow-x:auto}
nav button{flex:0 0 auto;padding:9px 16px;border:none;background:none;color:var(--text2);border-radius:9px;cursor:pointer;font:500 13px/1 'Noto Sans KR',sans-serif;white-space:nowrap;transition:all .15s}
nav button.on{background:var(--accent);color:#fff}
nav button:hover:not(.on){background:var(--surface2);color:var(--text)}
.panel{display:none}.panel.on{display:block}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:14px}
.card-hdr{font-size:13px;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:7px}
.card-hdr .ico{font-size:16px}
input[type=text],input[type=password],input[type=number],select,textarea{width:100%;padding:9px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font:13px/1.4 'Noto Sans KR',sans-serif;transition:border .15s}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent)}
textarea{resize:vertical;min-height:80px;font-family:'JetBrains Mono',monospace;font-size:11px}
label.f{display:block;margin-bottom:10px}
label.f>span{display:block;font-size:11px;color:var(--text2);margin-bottom:3px;font-weight:500}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.g4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px}
.btn{display:inline-flex;align-items:center;gap:5px;padding:10px 18px;border-radius:8px;border:none;font:500 13px/1 'Noto Sans KR',sans-serif;cursor:pointer;transition:all .12s}
.btn-p{background:var(--accent);color:#fff}.btn-p:hover{background:var(--accent2)}
.btn-p:disabled{opacity:.35;cursor:not-allowed}
.btn-s{background:var(--surface2);color:var(--text);border:1px solid var(--border)}.btn-s:hover{border-color:var(--accent)}
.btn-d{background:#c62828;color:#fff}
.btn-sm{padding:7px 12px;font-size:12px}
.btn-full{width:100%;justify-content:center}
.btn-row{display:flex;gap:8px;flex-wrap:wrap}
.drop{border:2px dashed var(--border);border-radius:var(--radius);padding:28px;text-align:center;cursor:pointer;transition:all .2s}
.drop:hover,.drop.over{border-color:var(--accent);background:var(--accentBg)}
.drop input{display:none}
.drop .ico{font-size:32px;margin-bottom:6px}
.drop p{color:var(--text2);font-size:12px}
.thumbs{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}
.thumb{position:relative;width:64px;height:64px;border-radius:8px;overflow:hidden;border:2px solid var(--border)}
.thumb img{width:100%;height:100%;object-fit:cover}
.thumb .x{position:absolute;top:1px;right:1px;width:18px;height:18px;border-radius:50%;background:rgba(0,0,0,.75);color:#fff;border:none;cursor:pointer;font-size:11px;line-height:18px;text-align:center}
.tbl-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
table.t{width:100%;border-collapse:collapse;font:12px/1.3 'JetBrains Mono',monospace}
table.t th{background:var(--surface2);padding:7px 8px;text-align:left;font-weight:500;color:var(--text2);border-bottom:1px solid var(--border);white-space:nowrap;position:sticky;top:0;z-index:1}
table.t td{padding:6px 8px;border-bottom:1px solid var(--border);white-space:nowrap}
table.t tr:hover td{background:var(--accentBg)}
.c-buy{color:var(--buy)}.c-sell{color:var(--sell)}
.c-up{color:var(--buy)}.c-dn{color:var(--sell)}.c-flat{color:var(--text2)}
.dg{background:var(--surface2);padding:8px 12px;border-radius:8px;margin:12px 0 6px;display:flex;align-items:center;justify-content:space-between}
.dg .l{font-weight:600;font-size:13px}.dg .r{font-size:11px;color:var(--text2)}
.prog{height:3px;background:var(--surface2);border-radius:2px;overflow:hidden;margin:10px 0}
.prog .bar{height:100%;background:var(--accent);border-radius:2px;transition:width .3s;width:0}
.log{max-height:130px;overflow-y:auto;background:var(--surface2);border-radius:8px;padding:8px;margin-top:8px;font:11px/1.5 'JetBrains Mono',monospace;color:var(--text2)}
.log .ok{color:var(--buy)}.log .err{color:var(--sell)}.log .warn{color:var(--warn)}
.status{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:500}
.status.ok{background:rgba(0,200,83,.1);color:var(--buy)}
.status.no{background:rgba(255,82,82,.1);color:var(--sell)}
.status.wait{background:rgba(255,193,7,.1);color:var(--warn)}
.toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);padding:10px 18px;border-radius:8px;font-size:12px;font-weight:500;z-index:999;opacity:0;transition:opacity .25s;pointer-events:none}
.toast.show{opacity:1}.toast.ok{background:#1b5e20;color:#a5d6a7}.toast.err{background:#b71c1c;color:#ef9a9a}
.steps{counter-reset:step}
.step{counter-increment:step;padding-left:32px;position:relative;margin-bottom:16px}
.step::before{content:counter(step);position:absolute;left:0;top:0;width:22px;height:22px;border-radius:50%;background:var(--accent);color:#fff;font-size:11px;font-weight:700;line-height:22px;text-align:center}
.step h3{font-size:13px;font-weight:600;margin-bottom:4px}
.step p{font-size:12px;color:var(--text2);line-height:1.5}
.step code{background:var(--surface2);padding:1px 5px;border-radius:3px;font-size:11px;font-family:'JetBrains Mono',monospace}
.bk-card{border-left:3px solid;padding-left:12px}
.bk-card.ss{border-color:var(--samsung)}.bk-card.kw{border-color:var(--kiwoom)}

/* Overview cards */
.summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
.sum-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px}
.sum-card .label{font-size:11px;color:var(--text2);margin-bottom:4px}
.sum-card .value{font-size:20px;font-weight:700;font-family:'JetBrains Mono',monospace}
.sum-card .sub{font-size:11px;color:var(--text2);margin-top:2px;font-family:'JetBrains Mono',monospace}
.sum-card .value.up{color:var(--buy)}.sum-card .value.dn{color:var(--sell)}

/* Filter buttons */
.filter-btns{display:flex;gap:4px}
.fbtn{padding:7px 14px;border:1px solid var(--border);background:none;color:var(--text2);border-radius:8px;cursor:pointer;font:500 12px/1 'Noto Sans KR',sans-serif;transition:all .15s}
.fbtn.on{background:var(--accent);color:#fff;border-color:var(--accent)}
.fbtn:hover:not(.on){background:var(--surface2);color:var(--text)}

/* Holdings header - sticky */
.hold-hdr{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;font-size:10px;color:var(--text3);padding:6px 12px;background:var(--bg);position:sticky;top:0;z-index:2;border-bottom:1px solid var(--border);margin-bottom:4px}
.hold-hdr div{display:flex;flex-direction:column;gap:2px}

/* Holdings card v2 */
.hold-row{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px;margin-bottom:8px;cursor:pointer;transition:border-color .15s}
.hold-row:hover{border-color:var(--accent)}
.hold-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.hold-ticker{font-size:15px;font-weight:700;color:var(--accent);font-family:'JetBrains Mono',monospace}
.hold-qty{font-size:12px;color:var(--text2)}
.hold-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;font-size:11px}
.hold-grid .lbl{color:var(--text3);font-size:10px}
.hold-grid .val{font-family:'JetBrains Mono',monospace;font-size:12px}

/* Back button */
.back-btn{display:inline-flex;align-items:center;gap:4px;padding:6px 12px;border:none;background:var(--surface2);color:var(--text2);border-radius:6px;cursor:pointer;font:12px 'Noto Sans KR',sans-serif;margin-bottom:12px}
.back-btn:hover{color:var(--text);background:var(--surface3)}

/* Loading spinner */
.spinner{display:inline-block;width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

@media(max-width:640px){
  .g2,.g3,.g4{grid-template-columns:1fr}
  .summary-grid{grid-template-columns:1fr}
  table.t{font-size:11px}
  table.t th,table.t td{padding:5px 5px}
  nav button{padding:8px 10px;font-size:11px}
  .hold-grid{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="logo">ğŸ“Š</div>
    <div style="flex:1"><h1>Sunghoon's Portfolio Manager</h1><div class="sub"><span id="verInfo"></span> Â· <span id="dataInfo">data-ì—†ìŒ</span></div></div>
    <button class="btn btn-s btn-sm" onclick="refreshData()" title="Google Sheetì—ì„œ ê±°ë˜ ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°">ğŸ”„ Data</button>
  </div>

  <nav id="nav">
    <button class="on" data-p="overview">ğŸ“Š Overview</button>
    <button data-p="history" id="navHistory">ğŸ“œ History</button>
    <button data-p="import">ğŸ“¥ +File</button>
    <button data-p="manual">âœï¸ ì…ë ¥</button>
    <button data-p="data">ğŸ“‹ ë°ì´í„°</button>
    <button data-p="setup">âš™ï¸ ì„¤ì •</button>
  </nav>

  <!-- ==================== OVERVIEW ==================== -->
  <div id="p-overview" class="panel on">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div class="filter-btns">
        <button class="fbtn on" onclick="setFilter('ì‚¼ì„±',this)">ğŸ”µ ì‚¼ì„±</button>
        <button class="fbtn" onclick="setFilter('í‚¤ì›€',this)">ğŸ”´ í‚¤ì›€</button>
        <button class="fbtn" onclick="setFilter('all',this)">Total</button>
      </div>
      <div style="display:flex;gap:4px;align-items:center">
        <button class="btn btn-s btn-sm" onclick="refreshPrices()" title="í˜„ì¬ê°€ ì—…ë°ì´íŠ¸">ğŸ”„ Price</button>
        <button class="btn btn-s btn-sm" onclick="refreshFundamentals()" title="P/E, EPS ì—…ë°ì´íŠ¸">ğŸ”„ Fund.</button>
      </div>
    </div>
    <div style="text-align:right;font-size:10px;color:var(--text3);margin-bottom:8px;margin-top:-8px">
      price: <span id="priceInfo">ì—†ìŒ</span> Â· fund: <span id="fundInfo">ì—†ìŒ</span>
    </div>
    <div id="overviewContent"><p style="color:var(--text2);text-align:center;padding:32px">ğŸ”„ í´ë¦­í•˜ì—¬ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”</p></div>
  </div>

  <!-- ==================== TICKER HISTORY ==================== -->
  <div id="p-history" class="panel">
    <div id="historyHeader" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <span id="historyTitle" style="font-size:14px;font-weight:600">ì „ì²´ ê±°ë˜ ë‚´ì—­</span>
      <button class="btn btn-s btn-sm" onclick="showHistory(null)">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
    </div>
    <div id="historyContent"></div>
  </div>

  <!-- ==================== IMPORT ==================== -->
  <div id="p-import" class="panel">
    <div class="card">
      <div class="card-hdr"><span class="ico">ğŸ“¥</span> í…ìŠ¤íŠ¸ ë°ì´í„° ë¶™ì—¬ë„£ê¸°</div>
      <p style="font-size:12px;color:var(--text2);margin-bottom:10px">Claudeê°€ ìƒì„±í•œ í…ìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ê³  "ê°€ì ¸ì˜¤ê¸°"ë¥¼ í´ë¦­í•˜ì„¸ìš”.</p>
      <textarea id="impText" rows="12" placeholder="#ì‚¼ì„± 260212
CAT,1,773.3300,1
SOXL,7,70.3600,2
ASTS,-4,85.5650,3

#í‚¤ì›€ 260212
CLS,1,287.0000,1
CLS,1,282.5800,2"></textarea>
      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <button class="btn btn-p" onclick="doImport()">ğŸ“¥ ê°€ì ¸ì˜¤ê¸° â†’ Google Sheets</button>
        <button class="btn btn-s btn-sm" onclick="previewImport()">ğŸ‘ ë¯¸ë¦¬ë³´ê¸°</button>
        <button class="btn btn-s btn-sm" onclick="document.getElementById('impText').value='';document.getElementById('impPreview').innerHTML=''">ì§€ìš°ê¸°</button>
      </div>
      <div id="impPreview" style="margin-top:12px"></div>
      <div id="impLog" style="margin-top:8px"></div>
    </div>
    <div class="card">
      <div class="card-hdr"><span class="ico">ğŸ“–</span> í…ìŠ¤íŠ¸ í˜•ì‹</div>
      <div style="font-size:12px;color:var(--text2);line-height:1.7">
        <p><code style="background:var(--surface2);padding:2px 6px;border-radius:3px;font-size:11px">#ì¦ê¶Œì‚¬ ë‚ ì§œ(YYMMDD)</code> ë¡œ ê·¸ë£¹ ì‹œì‘</p>
        <p><code style="background:var(--surface2);padding:2px 6px;border-radius:3px;font-size:11px">ì¢…ëª©,ìˆ˜ëŸ‰(ë§¤ë„=-),ì²´ê²°ë‹¨ê°€,ìˆœì„œ</code> ë¡œ ê° ê±°ë˜</p>
        <p>ë¹ˆ ì¤„ë¡œ ê·¸ë£¹ êµ¬ë¶„. tax/total ìë™ ê³„ì‚° (ì‚¼ì„± 0.03%, í‚¤ì›€ 0.07%)</p>
      </div>
    </div>
  </div>

  <!-- ==================== MANUAL ==================== -->
  <div id="p-manual" class="panel">
    <div class="card">
      <div class="card-hdr"><span class="ico">âœï¸</span> ìˆ˜ë™ ê±°ë˜ ì…ë ¥</div>
      <div class="g2">
        <label class="f"><span>ì¦ê¶Œì‚¬</span><select id="mBk"><option value="ì‚¼ì„±">ì‚¼ì„± (0.03%)</option><option value="í‚¤ì›€">í‚¤ì›€ (0.07%)</option></select></label>
        <label class="f"><span>ë‚ ì§œ (YYMMDD)</span><input type="text" id="mDt" placeholder="260212" maxlength="6"/></label>
      </div>
      <div class="g4">
        <label class="f"><span>ì¢…ëª©</span><input type="text" id="mTk" placeholder="AAPL" style="text-transform:uppercase"/></label>
        <label class="f"><span>ë§¤ë§¤</span><select id="mSd"><option value="buy">ë§¤ìˆ˜</option><option value="sell">ë§¤ë„</option></select></label>
        <label class="f"><span>ìˆ˜ëŸ‰</span><input type="number" id="mQt" placeholder="1" min="1"/></label>
        <label class="f"><span>ì²´ê²°ë‹¨ê°€</span><input type="number" id="mPr" placeholder="150.00" step="0.0001"/></label>
      </div>
      <button class="btn btn-p btn-full" onclick="addManual()">â• ì¶”ê°€ â†’ Google Sheets ì €ì¥</button>
    </div>
  </div>

  <!-- ==================== DATA ==================== -->
  <div id="p-data" class="panel">
    <div class="btn-row" style="margin-bottom:12px">
      <button class="btn btn-s btn-sm" onclick="loadFromSheet()">ğŸ”„ ì‹œíŠ¸ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button class="btn btn-s btn-sm" onclick="downloadXlsx()">ğŸ“¥ xlsx ë‹¤ìš´ë¡œë“œ</button>
    </div>
    <div id="dataView"><p style="color:var(--text2);text-align:center;padding:32px">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ "ì‹œíŠ¸ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°"ë¥¼ í´ë¦­í•˜ì„¸ìš”</p></div>
  </div>

  <!-- ==================== SETUP ==================== -->
  <div id="p-setup" class="panel">
    <div class="card">
      <div class="card-hdr"><span class="ico">ğŸ“¡</span> ì—°ê²° ìƒíƒœ</div>
      <div class="g2" style="margin-bottom:12px">
        <div>Google Sheets: <span class="status no" id="st-gs">ë¯¸ì—°ê²°</span></div>
        <div>Sheet ID: <span class="status no" id="st-sid">ì—†ìŒ</span></div>
      </div>
    </div>
    <div class="card">
      <div class="card-hdr"><span class="ico">ğŸ“˜</span> Google Sheets ì„¤ì • ê°€ì´ë“œ</div>
      <div class="steps">
        <div class="step"><h3>Google Cloud í”„ë¡œì íŠ¸ ìƒì„±</h3><p><a href="https://console.cloud.google.com/projectcreate" target="_blank" style="color:var(--accent)">console.cloud.google.com</a> â†’ ìƒˆ í”„ë¡œì íŠ¸</p></div>
        <div class="step"><h3>Google Sheets API í™œì„±í™”</h3><p><a href="https://console.cloud.google.com/apis/library/sheets.googleapis.com" target="_blank" style="color:var(--accent)">Sheets API</a> â†’ "ì‚¬ìš©" í´ë¦­</p></div>
        <div class="step"><h3>ì„œë¹„ìŠ¤ ê³„ì • ìƒì„±</h3><p><a href="https://console.cloud.google.com/iam-admin/serviceaccounts/create" target="_blank" style="color:var(--accent)">ì„œë¹„ìŠ¤ ê³„ì •</a> â†’ ìƒì„± â†’ "í‚¤" íƒ­ â†’ JSON ë‹¤ìš´ë¡œë“œ</p></div>
        <div class="step"><h3>Google Sheet ì¤€ë¹„</h3><p>ìƒˆ Sheet â†’ íƒ­: <code>ì‚¼ì„±</code>, <code>í‚¤ì›€</code>, <code>config</code>. config íƒ­: A1=<code>initial_cash_ì‚¼ì„±</code> B1=ê¸ˆì•¡, A2=<code>initial_cash_í‚¤ì›€</code> B2=ê¸ˆì•¡</p></div>
        <div class="step"><h3>ì‹œíŠ¸ ê³µìœ </h3><p>JSONì˜ <code>client_email</code> â†’ Sheet "ê³µìœ " â†’ í¸ì§‘ì ê¶Œí•œ</p></div>
      </div>
    </div>
    <div class="card">
      <div class="card-hdr"><span class="ico">ğŸ”‘</span> ì„œë¹„ìŠ¤ ê³„ì • í‚¤ (JSON)</div>
      <textarea id="saKey" placeholder='JSON ì „ì²´ ë¶™ì—¬ë„£ê¸°...'></textarea>
      <div style="margin-top:8px"><button class="btn btn-p btn-sm" onclick="saveSA()">ì €ì¥</button><span style="font-size:11px;color:var(--text2);margin-left:8px">ë¡œì»¬ ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥</span></div>
    </div>
    <div class="card">
      <div class="card-hdr"><span class="ico">ğŸ“„</span> Google Sheet ID</div>
      <div style="display:flex;gap:8px">
        <input type="text" id="sheetId" placeholder="Sheet ID (URLì˜ /d/.../ ë¶€ë¶„)"/>
        <button class="btn btn-p btn-sm" onclick="saveSheetId()">ì €ì¥</button>
        <button class="btn btn-s btn-sm" onclick="testConnection()">í…ŒìŠ¤íŠ¸</button>
      </div>
    </div>
    <div class="card">
      <div class="card-hdr"><span class="ico">ğŸ’°</span> Initial Cash (ì´ˆê¸° íˆ¬ìê¸ˆ)</div>
      <div class="g2" style="margin-bottom:8px">
        <label class="f"><span>ğŸ”µ ì‚¼ì„±</span><input type="number" id="initCashSS" placeholder="30000" step="100"/></label>
        <label class="f"><span>ğŸ”´ í‚¤ì›€</span><input type="number" id="initCashKW" placeholder="20000" step="100"/></label>
      </div>
      <button class="btn btn-p btn-sm" onclick="saveInitCash()">ì €ì¥ â†’ Sheet</button>
      <p style="font-size:11px;color:var(--text2);margin-top:6px">config íƒ­ í˜•ì‹: A1=initial_cash_ì‚¼ì„±, B1=ê¸ˆì•¡, A2=initial_cash_í‚¤ì›€, B2=ê¸ˆì•¡</p>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ================ CONFIG ================
const TAX={ì‚¼ì„±:0.0003,í‚¤ì›€:0.0007};
const SCOPES='https://www.googleapis.com/auth/spreadsheets';
let SA_KEY=null,SHEET_ID='',gToken=null,gTokenExp=0;
let allTransactions=[];
let initialCashSS=0,initialCashKW=0;
let cachedPrices={};
let cachedFundamentals={};
const CACHE_KEY_TX='cache_transactions';
const CACHE_KEY_PRICES='cache_prices';
const CACHE_KEY_FUND='cache_fundamentals';
const CACHE_KEY_CASH='cache_initialCash2';
const CACHE_KEY_DATA_TS='cache_dataTimestamp';

// ================ INIT ================
document.addEventListener('DOMContentLoaded',()=>{
  document.querySelectorAll('nav button').forEach(b=>b.addEventListener('click',()=>switchTab(b.dataset.p)));
  updateVerInfo();
  loadConfig();
  restoreCache();
  updateDataInfo();
  updatePriceInfo();
  updateFundInfo();
});

function updateVerInfo(){
  // Try to get last-modified from GitHub
  fetch(window.location.href,{method:'HEAD',cache:'no-cache'}).then(r=>{
    const lm=r.headers.get('last-modified');
    if(lm){
      const d=new Date(lm);
      const kst=new Date(d.getTime()+9*60*60*1000);
      const mm=String(kst.getUTCMonth()+1).padStart(2,'0');
      const dd=String(kst.getUTCDate()).padStart(2,'0');
      const hh=String(kst.getUTCHours()).padStart(2,'0');
      const mi=String(kst.getUTCMinutes()).padStart(2,'0');
      const ss=String(kst.getUTCSeconds()).padStart(2,'0');
      document.getElementById('verInfo').textContent=`html-${mm}-${dd}-${hh}:${mi}:${ss}`;
    }else{
      document.getElementById('verInfo').textContent='html-unknown';
    }
  }).catch(()=>{document.getElementById('verInfo').textContent='html-local'});
}

function updatePriceInfo(){
  const ts=localStorage.getItem('cache_priceTimestamp');
  document.getElementById('priceInfo').textContent=ts||'ì—†ìŒ';
}
function updateFundInfo(){
  const ts=localStorage.getItem('cache_fundTimestamp');
  document.getElementById('fundInfo').textContent=ts||'ì—†ìŒ';
}
function savePriceTimestamp(){
  const now=new Date();
  const kst=new Date(now.getTime()+9*60*60*1000);
  const mm=String(kst.getUTCMonth()+1).padStart(2,'0');
  const dd=String(kst.getUTCDate()).padStart(2,'0');
  const hh=String(kst.getUTCHours()).padStart(2,'0');
  const mi=String(kst.getUTCMinutes()).padStart(2,'0');
  localStorage.setItem('cache_priceTimestamp',`${mm}-${dd} ${hh}:${mi}`);
  updatePriceInfo();
}

function switchTab(p){
  document.querySelectorAll('nav button').forEach(x=>x.classList.toggle('on',x.dataset.p===p));
  document.querySelectorAll('.panel').forEach(x=>x.classList.remove('on'));
  document.getElementById('p-'+p).classList.add('on');
  if(p==='history')document.getElementById('navHistory').style.display='';
}

// ================ CONFIG ================
function loadConfig(){
  try{
    const sa=localStorage.getItem('sa_key');
    if(sa){SA_KEY=JSON.parse(sa);document.getElementById('saKey').value=sa;updateSt('st-gs','ok','í‚¤ ì €ì¥ë¨')}
    const sid=localStorage.getItem('sheet_id');
    if(sid){SHEET_ID=sid;document.getElementById('sheetId').value=sid;updateSt('st-sid','ok',sid.slice(0,8)+'...')}
  }catch(e){}
}
function saveSA(){try{const r=document.getElementById('saKey').value.trim();SA_KEY=JSON.parse(r);localStorage.setItem('sa_key',r);updateSt('st-gs','ok','í‚¤ ì €ì¥ë¨');toast('ì €ì¥ ì™„ë£Œ','ok')}catch(e){toast('JSON í˜•ì‹ ì˜¤ë¥˜','err')}}
function saveSheetId(){SHEET_ID=document.getElementById('sheetId').value.trim();localStorage.setItem('sheet_id',SHEET_ID);updateSt('st-sid','ok',SHEET_ID.slice(0,8)+'...');toast('ì €ì¥ ì™„ë£Œ','ok')}
function updateSt(id,cls,txt){const el=document.getElementById(id);el.className='status '+cls;el.textContent=txt}
async function saveInitCash(){
  const ss=parseFloat(document.getElementById('initCashSS').value);
  const kw=parseFloat(document.getElementById('initCashKW').value);
  if((!ss&&!kw)||!SHEET_ID||!SA_KEY){toast('ê¸ˆì•¡ê³¼ Sheet ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”','err');return}
  try{
    const token=await getAccessToken();
    const url=`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/config!A1:B2?valueInputOption=USER_ENTERED`;
    await fetch(url,{method:'PUT',headers:{Authorization:`Bearer ${token}`,'Content-Type':'application/json'},
      body:JSON.stringify({range:'config!A1:B2',values:[['initial_cash_ì‚¼ì„±',ss||0],['initial_cash_í‚¤ì›€',kw||0]]})});
    initialCashSS=ss||0;initialCashKW=kw||0;
    toast('Initial cash ì €ì¥ ì™„ë£Œ','ok');
  }catch(e){toast('ì €ì¥ ì‹¤íŒ¨: '+e.message,'err')}
}

// ================ GOOGLE AUTH ================
async function getAccessToken(){
  if(gToken&&Date.now()/1000<gTokenExp-60)return gToken;
  if(!SA_KEY)throw new Error('ì„œë¹„ìŠ¤ ê³„ì • í‚¤ ì—†ìŒ');
  const now=Math.floor(Date.now()/1000),exp=now+3600;
  const sJWT=KJUR.jws.JWS.sign('RS256',JSON.stringify({alg:'RS256',typ:'JWT'}),
    JSON.stringify({iss:SA_KEY.client_email,scope:SCOPES,aud:'https://oauth2.googleapis.com/token',iat:now,exp}),SA_KEY.private_key);
  const resp=await fetch('https://oauth2.googleapis.com/token',{method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body:`grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=${sJWT}`});
  if(!resp.ok){const e=await resp.json().catch(()=>({}));throw new Error('Auth ì‹¤íŒ¨: '+(e.error_description||resp.status))}
  const d=await resp.json();gToken=d.access_token;gTokenExp=exp;return gToken;
}

// ================ SHEETS API ================
async function sheetsGet(range){
  const token=await getAccessToken();
  const r=await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(range)}`,{headers:{Authorization:`Bearer ${token}`}});
  if(!r.ok)throw new Error('ì‹œíŠ¸ ì½ê¸° ì‹¤íŒ¨: '+r.status);return r.json();
}
async function sheetsInsertAtTop(sheet,values){
  const token=await getAccessToken();const range=`${sheet}!A:H`;
  let existing=[];try{const d=await sheetsGet(`${sheet}!A:H`);existing=d.values||[]}catch(e){}
  const header=existing.length>0?existing[0]:['','','','','tax','total','split','seq'];
  const newAll=[header,...values,...existing.slice(1)];
  await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(range)}:clear`,{method:'POST',headers:{Authorization:`Bearer ${token}`}});
  const r=await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(range)}?valueInputOption=USER_ENTERED`,{
    method:'PUT',headers:{Authorization:`Bearer ${token}`,'Content-Type':'application/json'},
    body:JSON.stringify({range,majorDimension:'ROWS',values:newAll})});
  if(!r.ok)throw new Error('ì‹œíŠ¸ ì“°ê¸° ì‹¤íŒ¨: '+r.status);return r.json();
}
async function testConnection(){
  try{updateSt('st-gs','wait','í…ŒìŠ¤íŠ¸...');await sheetsGet('ì‚¼ì„±!A1:H1');updateSt('st-gs','ok','ì—°ê²° ì„±ê³µ âœ“');toast('ì—°ê²° ì„±ê³µ!','ok')}
  catch(e){updateSt('st-gs','no','ì‹¤íŒ¨');toast(e.message,'err')}
}

// ================ CACHE ================
function saveCache(){
  try{
    localStorage.setItem(CACHE_KEY_TX,JSON.stringify(allTransactions));
    localStorage.setItem(CACHE_KEY_PRICES,JSON.stringify(cachedPrices));
    localStorage.setItem(CACHE_KEY_FUND,JSON.stringify(cachedFundamentals));
    localStorage.setItem(CACHE_KEY_CASH,JSON.stringify({ss:initialCashSS,kw:initialCashKW}));
  }catch(e){}
}
function saveDataTimestamp(){
  let latest='';
  for(const tx of allTransactions){if(tx.date>latest)latest=tx.date}
  if(latest&&latest.length===6){
    const ts=`${latest.slice(2,4)}-${latest.slice(4,6)}`;
    localStorage.setItem(CACHE_KEY_DATA_TS,ts);
  }
  updateDataInfo();
}
function updateDataInfo(){
  const ts=localStorage.getItem(CACHE_KEY_DATA_TS);
  document.getElementById('dataInfo').textContent=ts?`data-${ts}`:'data-ì—†ìŒ';
}
function restoreCache(){
  try{
    const tx=localStorage.getItem(CACHE_KEY_TX);
    if(tx){allTransactions=JSON.parse(tx)}
    const pr=localStorage.getItem(CACHE_KEY_PRICES);
    if(pr){cachedPrices=JSON.parse(pr)}
    const fd=localStorage.getItem(CACHE_KEY_FUND);
    if(fd){cachedFundamentals=JSON.parse(fd)}
    const ic=localStorage.getItem(CACHE_KEY_CASH);
    if(ic){const c=JSON.parse(ic);initialCashSS=c.ss||0;initialCashKW=c.kw||0}
    populateInitCashFields();
    if(allTransactions.length>0){
      computeOverview();
      renderOverview();
    }
  }catch(e){}
  // Refresh version displays after restore
  updatePriceInfo();
  updateFundInfo();
}
function populateInitCashFields(){
  if(initialCashSS)document.getElementById('initCashSS').value=initialCashSS;
  if(initialCashKW)document.getElementById('initCashKW').value=initialCashKW;
}

// Three separate refresh functions
async function refreshData(){
  if(!SHEET_ID||!SA_KEY){toast('Google Sheets ì„¤ì •ì„ ì™„ë£Œí•˜ì„¸ìš”','err');return}
  toast('ğŸ“¡ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...','ok');
  await loadAllTransactions();
  saveCache();
  saveDataTimestamp();
  populateInitCashFields();
  computeOverview();
  renderOverview();
  toast('âœ… ë°ì´í„° ê°±ì‹  ì™„ë£Œ','ok');
}

async function refreshPrices(){
  const tickers=getHeldTickers();
  if(!tickers.length){toast('ë³´ìœ  ì¢…ëª© ì—†ìŒ','err');return}
  toast('ğŸ’² ê°€ê²© ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...','ok');
  cachedPrices=await fetchPrices(tickers);
  saveCache();
  savePriceTimestamp();
  computeOverview();
  renderOverview();
  toast('âœ… ê°€ê²© ê°±ì‹  ì™„ë£Œ','ok');
}

async function refreshFundamentals(){
  // Placeholder for FMP integration
  toast('ğŸ“ FundamentalsëŠ” FMP API ì—°ê²° í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤','err');
}

function getHeldTickers(){
  // Use computeOverview's holdMap if available
  if(cachedOverviewData){
    const tickers=new Set();
    for(const h of cachedOverviewData.allHoldings)tickers.add(h.ticker);
    return[...tickers];
  }
  const qtyMap={};
  for(const tx of allTransactions){
    if(!tx.ticker)continue;
    qtyMap[tx.ticker]=(qtyMap[tx.ticker]||0)+tx.qty;
  }
  return Object.entries(qtyMap).filter(([,q])=>q>0).map(([t])=>t);
}

// ================ LOAD ALL TRANSACTIONS ================
async function loadAllTransactions(){
  allTransactions=[];
  for(const broker of['ì‚¼ì„±','í‚¤ì›€']){
    try{
      const d=await sheetsGet(`${broker}!A:H`);
      const rows=d.values||[];let curDate='';
      for(let i=1;i<rows.length;i++){
        const r=rows[i];
        if(r[0]&&r[0]!=='')curDate=String(r[0]);
        allTransactions.push({
          broker,date:curDate,ticker:r[1]||'',qty:parseFloat(r[2])||0,
          price:parseFloat(r[3])||0,tax:parseFloat(r[4])||0,total:parseFloat(r[5])||0,
          split:r[6]||'',seq:r[7]||''
        });
      }
    }catch(e){}
  }
  // Load initial cash per broker from config tab
  try{
    const d=await sheetsGet('config!A1:B2');
    if(d.values){
      for(const row of d.values){
        if(row[0]==='initial_cash_ì‚¼ì„±')initialCashSS=parseFloat(row[1])||0;
        if(row[0]==='initial_cash_í‚¤ì›€')initialCashKW=parseFloat(row[1])||0;
        // Legacy: single initial_cash
        if(row[0]==='initial_cash'){initialCashSS=parseFloat(row[1])||0;initialCashKW=0}
      }
    }
  }catch(e){}

  // Normalize splits: only adjust rows that have a split marker
  // split=1/2 on a row means THAT row's qty and price are pre-split
  // -> qty *= 2, price /= 2 to convert to post-split terms
  for(const tx of allTransactions){
    // Store original qty/price for cash calculation before split adjustment
    tx.origQty=tx.qty;
    tx.origPrice=tx.price;
    if(tx.split&&tx.split!==''){
      const parts=tx.split.split('/');
      if(parts.length===2){
        const num=parseFloat(parts[0]),den=parseFloat(parts[1]);
        if(num&&den){
          const factor=den/num; // 1/2 -> 2
          tx.qty*=factor;
          tx.price/=factor;
        }
      }
    }
  }
}

// ================ PRICE FETCH ================
async function fetchPrices(tickers){
  const prices={};
  const proxies=[
    u=>`https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
    u=>`https://corsproxy.io/?${encodeURIComponent(u)}`,
  ];
  await Promise.all(tickers.map(async tk=>{
    const yahooUrl=`https://query1.finance.yahoo.com/v8/finance/chart/${tk}?interval=1d&range=5d`;
    for(const mkProxy of proxies){
      try{
        const r=await fetch(mkProxy(yahooUrl),{signal:AbortSignal.timeout(8000)});
        if(!r.ok)continue;
        const d=await r.json();
        const meta=d.chart?.result?.[0]?.meta;
        if(meta){
          const prevClose=meta.chartPreviousClose||meta.previousClose||0;
          const curPrice=meta.regularMarketPrice||0;
          const chg=prevClose?((curPrice-prevClose)/prevClose*100):0;
          prices[tk]={current:curPrice,prevClose,chg};
          break;
        }
      }catch(e){continue}
    }
  }));
  return prices;
}

// ================ OVERVIEW ================
let cachedOverviewData=null; // {holdMap, allHoldings, cashByBroker}
let currentFilter='ì‚¼ì„±';

function setFilter(f,btn){
  currentFilter=f;
  document.querySelectorAll('.fbtn').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  if(cachedOverviewData)renderOverview();
}

function computeOverview(){
  // Sort chronologically: oldest date first, then by seq within same date
  const chronoTx=[...allTransactions].sort((a,b)=>{
    const dc=a.date.localeCompare(b.date);
    if(dc!==0)return dc;
    return (parseInt(a.seq)||0)-(parseInt(b.seq)||0);
  });

  const holdMap={};

  for(const tx of chronoTx){
    if(!tx.ticker)continue;
    const key=`${tx.broker}|${tx.ticker}`;
    if(!holdMap[key])holdMap[key]={broker:tx.broker,ticker:tx.ticker,totalQty:0,avgCost:0,realizedPL:0,realizedPLThisYear:0};
    const h=holdMap[key];

    if(tx.qty>0){
      // Buy: update moving average cost (no tax)
      const newCost=h.avgCost*h.totalQty+tx.qty*tx.price;
      h.totalQty+=tx.qty;
      h.avgCost=h.totalQty>0?newCost/h.totalQty:0;
    }else if(tx.qty<0){
      // Sell: realized P/L using moving avg cost basis
      const sellQty=Math.abs(tx.qty);
      const pl=sellQty*(tx.price-h.avgCost)-tx.tax;
      h.realizedPL+=pl;
      if(tx.date.startsWith('26'))h.realizedPLThisYear+=pl;
      h.totalQty-=sellQty;
      if(h.totalQty<=0){h.avgCost=0;h.totalQty=0}
    }
  }

  const allHoldings=Object.values(holdMap).filter(h=>h.totalQty>0).map(h=>({
    broker:h.broker,ticker:h.ticker,qty:h.totalQty,
    avgPrice:h.avgCost,
    purchasedAmt:h.avgCost*h.totalQty
  }));

  // Apply cached prices
  for(const h of allHoldings){
    const p=cachedPrices[h.ticker];
    h.currentPrice=p?p.current:0;
    h.chg=p?p.chg:0;
    h.marketValue=h.qty*h.currentPrice;
    h.unrealizedPL=h.marketValue-h.purchasedAmt;
  }

  const cashByBroker={ì‚¼ì„±:0,í‚¤ì›€:0};
  for(const tx of allTransactions){
    const q=tx.origQty!==undefined?tx.origQty:tx.qty;
    const p=tx.origPrice!==undefined?tx.origPrice:tx.price;
    if(q>0)cashByBroker[tx.broker]-=(Math.abs(q)*p+tx.tax);  // buy: cash out
    else if(q<0)cashByBroker[tx.broker]+=(Math.abs(q)*p-tx.tax); // sell: cash in
  }

  cachedOverviewData={holdMap,allHoldings,cashByBroker};
}

async function loadOverview(){
  // Legacy: full refresh (data + prices)
  if(!SHEET_ID||!SA_KEY){toast('Google Sheets ì„¤ì •ì„ ì™„ë£Œí•˜ì„¸ìš”','err');return}
  const el=document.getElementById('overviewContent');
  el.innerHTML='<p style="color:var(--text2);text-align:center;padding:32px"><span class="spinner"></span> ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
  await loadAllTransactions();
  const tickers=getHeldTickers();
  if(tickers.length)cachedPrices=await fetchPrices(tickers);
  saveCache();
  computeOverview();
  renderOverview();
}

function renderOverview(){
  if(!cachedOverviewData)return;
  const{holdMap,allHoldings,cashByBroker}=cachedOverviewData;
  const el=document.getElementById('overviewContent');
  const f=currentFilter;

  // Filter holdings
  const holdings=f==='all'?allHoldings:allHoldings.filter(h=>h.broker===f);
  holdings.sort((a,b)=>b.marketValue-a.marketValue);

  // Filter holdMap for realized P/L
  let totalRealizedPL=0,totalRealizedPLThisYear=0;
  for(const h of Object.values(holdMap)){
    if(f!=='all'&&h.broker!==f)continue;
    totalRealizedPL+=h.realizedPL;
    totalRealizedPLThisYear+=h.realizedPLThisYear;
  }

  let totalMarketValue=0,totalPurchased=0;
  for(const h of holdings){
    totalMarketValue+=h.marketValue;
    totalPurchased+=h.purchasedAmt;
  }

  // Cash
  let cash=0,initCash=0;
  if(f==='all'){
    initCash=initialCashSS+initialCashKW;
    cash=initCash+cashByBroker['ì‚¼ì„±']+cashByBroker['í‚¤ì›€'];
  }else if(f==='ì‚¼ì„±'){
    initCash=initialCashSS;
    cash=initialCashSS+cashByBroker['ì‚¼ì„±'];
  }else{
    initCash=initialCashKW;
    cash=initialCashKW+cashByBroker['í‚¤ì›€'];
  }
  const totalEarning=cash+totalMarketValue-initCash;

  let html='';

  // Summary cards
  const valueDiff=totalMarketValue-totalPurchased;
  const valueDiffPct=totalPurchased>0?((valueDiff/totalPurchased)*100):0;
  const vdCls=valueDiff>=0?'up':'dn';
  const totalAsset=cash+totalMarketValue;
  const cashPct=totalAsset>0?((cash/totalAsset)*100):0;
  const earnPct=initCash>0?((totalEarning/initCash)*100):0;
  const earnCls=totalEarning>=0?'up':'dn';
  const realCls=totalRealizedPL>=0?'up':'dn';
  const realYtdCls=totalRealizedPLThisYear>=0?'up':'dn';

  html+=`<div class="summary-grid">`;

  // Top-left: í‰ê°€ì†ìµ
  const vdSign=valueDiff>=0?'+':'';
  html+=`<div class="sum-card">
    <div class="label">ğŸ“ˆ í‰ê°€ì†ìµ</div>
    <div style="display:flex;align-items:center;gap:20px">
      <div class="value ${vdCls}" style="white-space:nowrap">${vdSign}${fmtUSD(valueDiff)} <span style="font-size:13px">(${valueDiffPct>=0?'+':''}${valueDiffPct.toFixed(1)}%)</span></div>
      <div style="font-size:10px;color:var(--text2);line-height:1.6;font-family:'JetBrains Mono',monospace;white-space:nowrap;text-align:right">market <span style="display:inline-block;text-align:right">${fmtUSD(totalMarketValue)}</span><br>purcha <span style="display:inline-block;text-align:right">${fmtUSD(totalPurchased)}</span></div>
    </div>
  </div>`;

  // Top-right: Cash
  html+=`<div class="sum-card">
    <div class="label">ğŸ’µ Cash</div>
    <div style="display:flex;align-items:center;gap:20px">
      <div class="value" style="white-space:nowrap">${fmtUSD(cash)}</div>
      <div style="font-size:10px;color:var(--text2);font-family:'JetBrains Mono',monospace;white-space:nowrap">(${cashPct.toFixed(0)}% of asset)</div>
    </div>
  </div>`;

  // Bottom-left: Total Value
  const earnSign=totalEarning>=0?'+':'';
  html+=`<div class="sum-card">
    <div class="label">ğŸ’° Total Value</div>
    <div style="display:flex;align-items:center;gap:20px">
      <div class="value ${earnCls}" style="white-space:nowrap">${earnSign}${fmtUSD(totalEarning)} <span style="font-size:13px">(${earnPct>=0?'+':''}${earnPct.toFixed(1)}%)</span></div>
      <div style="font-size:10px;color:var(--text2);line-height:1.6;font-family:'JetBrains Mono',monospace;white-space:nowrap;text-align:right">asset&nbsp;&nbsp; <span style="display:inline-block;text-align:right">${fmtUSD(totalAsset)}</span><br>initial <span style="display:inline-block;text-align:right">${fmtUSD(initCash)}</span></div>
    </div>
  </div>`;

  // Bottom-right: Realized P/L (YTD first, then total)
  html+=`<div class="sum-card">
    <div class="label">ğŸ“Š Realized P/L</div>
    <div style="display:flex;align-items:baseline;gap:32px">
      <div><div class="sub">YTD</div><div class="value ${realYtdCls}">${fmtUSD(totalRealizedPLThisYear)}</div></div>
      <div><div class="sub">total</div><div class="value ${realCls}" style="font-size:16px">${fmtUSD(totalRealizedPL)}</div></div>
    </div>
  </div>`;

  html+=`</div>`;

  // Holdings
  if(f==='all'){
    // Merge same ticker across brokers
    const merged={};
    for(const h of allHoldings){
      if(!merged[h.ticker])merged[h.ticker]={ticker:h.ticker,qty:0,purchasedAmt:0,marketValue:0,unrealizedPL:0,currentPrice:h.currentPrice,chg:h.chg,parts:[]};
      const m=merged[h.ticker];
      m.qty+=h.qty;m.purchasedAmt+=h.purchasedAmt;m.marketValue+=h.marketValue;m.unrealizedPL+=h.unrealizedPL;
      m.parts.push({broker:h.broker,qty:h.qty});
    }
    const mergedList=Object.values(merged);mergedList.sort((a,b)=>b.marketValue-a.marketValue);

    if(mergedList.length===0){
      html+='<p style="color:var(--text2);text-align:center;padding:24px">ë³´ìœ  ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤</p>';
    }else{
      html+=`<div style="font-size:13px;font-weight:600;margin-bottom:8px">ë³´ìœ  ì¢…ëª© (${mergedList.length})</div>`;
      html+=holdingsHeader();
      for(const m of mergedList){
        const avgPrice=m.qty>0?m.purchasedAmt/m.qty:0;
        const chgCls=m.chg>0?'c-up':m.chg<0?'c-dn':'c-flat';
        const plCls=m.unrealizedPL>=0?'c-up':'c-dn';
        const chgTri=m.chg>0?'â–²':m.chg<0?'â–¼':'';
        const chgStr=`${chgTri}${m.chg>=0?'+':''}${m.chg.toFixed(2)}%`;
        // Realized P/L for this ticker across all brokers
        let realPL=0,realPLYtd=0;
        for(const hv of Object.values(holdMap)){if(hv.ticker===m.ticker){realPL+=hv.realizedPL;realPLYtd+=hv.realizedPLThisYear}}
        const realCls=realPL>=0?'c-up':'c-dn';const realYtdCls=realPLYtd>=0?'c-up':'c-dn';
        // Qty display
        let qtyStr;
        if(m.parts.length>1){
          const ps=m.parts.map(p=>`${p.qty}(${p.broker})`).join('+');
          qtyStr=`${m.qty}ì£¼ = ${ps}`;
        }else{
          qtyStr=`${m.qty}ì£¼ Â· ${m.parts[0].broker==='ì‚¼ì„±'?'ğŸ”µ':'ğŸ”´'} ${m.parts[0].broker}`;
        }
        html+=renderHoldCard(m.ticker,qtyStr,avgPrice,m.currentPrice,chgStr,chgCls,m.unrealizedPL,plCls,m.marketValue,m.purchasedAmt,realPL,realCls,realPLYtd,realYtdCls);
      }
    }
  }else{
    // Single broker view
    if(holdings.length===0){
      html+='<p style="color:var(--text2);text-align:center;padding:24px">ë³´ìœ  ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤</p>';
    }else{
      html+=`<div style="font-size:13px;font-weight:600;margin-bottom:8px">ë³´ìœ  ì¢…ëª© (${holdings.length})</div>`;
      html+=holdingsHeader();
      for(const h of holdings){
        const chgCls=h.chg>0?'c-up':h.chg<0?'c-dn':'c-flat';
        const plCls=h.unrealizedPL>=0?'c-up':'c-dn';
        const key=`${h.broker}|${h.ticker}`;
        const hm=holdMap[key];
        const realPL=hm?hm.realizedPL:0;
        const realPLYtd=hm?hm.realizedPLThisYear:0;
        const realCls=realPL>=0?'c-up':'c-dn';
        const realYtdCls=realPLYtd>=0?'c-up':'c-dn';
        const chgTri=h.chg>0?'â–²':h.chg<0?'â–¼':'';
        const chgStr=`${chgTri}${h.chg>=0?'+':''}${h.chg.toFixed(2)}%`;
        const qtyStr=`${h.qty}ì£¼ Â· ${h.broker==='ì‚¼ì„±'?'ğŸ”µ':'ğŸ”´'} ${h.broker}`;
        html+=renderHoldCard(h.ticker,qtyStr,h.avgPrice,h.currentPrice,chgStr,chgCls,h.unrealizedPL,plCls,h.marketValue,h.purchasedAmt,realPL,realCls,realPLYtd,realYtdCls);
      }
    }
  }

  el.innerHTML=html;
}

function holdingsHeader(){
  return`<div class="hold-hdr">
    <div><span>í‰ê·  / í˜„ì¬ê°€ (ì „ì¼ëŒ€ë¹„)</span><span>í‰ê°€ì†ìµ</span></div>
    <div><span>í‰ê°€ê¸ˆì•¡</span><span>ë§¤ì…ê¸ˆì•¡</span></div>
    <div><span>ì‹¤í˜„ì†ìµ (YTD)</span><span>ì‹¤í˜„ì†ìµ (total)</span></div>
    <div><span>P/E (12m fwd)</span><span>EPS est Î”1w</span></div>
  </div>`;
}

function renderHoldCard(ticker,qtyStr,avgPrice,currentPrice,chgStr,chgCls,unrealizedPL,plCls,marketValue,purchasedAmt,realPL,realCls,realPLYtd,realYtdCls){
  const plPct=purchasedAmt>0?((unrealizedPL/purchasedAmt)*100):0;
  const plPctStr=`(${plPct>=0?'+':''}${plPct.toFixed(1)}%)`;
  return`<div class="hold-row" onclick="showHistory('${ticker}')">
    <div class="hold-top">
      <span class="hold-ticker" style="color:var(--text2)">${ticker}</span>
      <span class="hold-qty">${qtyStr}</span>
    </div>
    <div class="hold-grid">
      <div>
        <div class="val">${avgPrice.toFixed(2)} / ${currentPrice.toFixed(2)} <span class="${chgCls}">(${chgStr})</span></div>
        <div class="val ${plCls}">${fmtUSD(unrealizedPL)} <span style="font-size:10px">${plPctStr}</span></div>
      </div>
      <div>
        <div class="val">${fmtUSD(marketValue)}</div>
        <div class="val">${fmtUSD(purchasedAmt)}</div>
      </div>
      <div>
        <div class="val ${realYtdCls}">${fmtUSD(realPLYtd)}</div>
        <div class="val ${realCls}">${fmtUSD(realPL)}</div>
      </div>
      <div>
        <div class="val" style="color:var(--text3)">â€”</div>
        <div class="val" style="color:var(--text3)">â€”</div>
      </div>
    </div>
  </div>`;
}

function sumCard(label,value,sub,cls=''){
  return`<div class="sum-card"><div class="label">${label}</div><div class="value ${cls}">${value}</div>${sub?`<div class="sub">${sub}</div>`:''}</div>`;
}
function sumCard2(label,value,right,cls=''){
  return`<div class="sum-card"><div class="label">${label}</div><div style="display:flex;align-items:baseline;gap:6px"><div class="value ${cls}">${value}</div><div class="sub" style="margin-top:0">${right}</div></div></div>`;
}

// ================ TICKER HISTORY ================
function showHistory(ticker){
  const el=document.getElementById('historyContent');
  const titleEl=document.getElementById('historyTitle');

  if(allTransactions.length===0&&SHEET_ID&&SA_KEY){
    loadAllTransactions().then(()=>showHistory(ticker));
    el.innerHTML='<p style="color:var(--text2);text-align:center;padding:32px"><span class="spinner"></span> ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
    return;
  }

  const txs=ticker?allTransactions.filter(t=>t.ticker===ticker):[...allTransactions];

  if(ticker){
    let totalBought=0,totalSold=0;
    for(const tx of txs){if(tx.qty>0)totalBought+=tx.qty;else totalSold+=Math.abs(tx.qty)}
    titleEl.innerHTML=`<span style="cursor:pointer" onclick="showHistory(null)">â† </span><span style="font-family:'JetBrains Mono',monospace;color:var(--accent)">${ticker}</span> <span style="font-size:12px;color:var(--text2);font-weight:400">ë§¤ìˆ˜ ${totalBought} / ë§¤ë„ ${totalSold} / ë³´ìœ  ${totalBought-totalSold}ì£¼</span>`;
  }else{
    titleEl.textContent='ì „ì²´ ê±°ë˜ ë‚´ì—­';
  }

  // Compute running average and per-tx realized P/L for each ticker
  // Need to do this per-ticker even in all-transactions view
  let runningAvgs={};  // key -> avg at that point
  let txRealizedPL={}; // key -> realized P/L for that sell tx

  // Get unique tickers in txs
  const tickersInView=[...new Set(txs.map(t=>t.ticker).filter(Boolean))];
  for(const tk of tickersInView){
    const tkTxs=allTransactions.filter(t=>t.ticker===tk).sort((a,b)=>{
      const dc=a.date.localeCompare(b.date);if(dc!==0)return dc;
      return(parseInt(a.seq)||0)-(parseInt(b.seq)||0);
    });
    let qty=0,cost=0;
    for(const tx of tkTxs){
      const k=`${tx.date}|${tx.seq}|${tx.broker}`;
      if(tx.qty>0){
        cost+=tx.qty*tx.price;qty+=tx.qty;
      }else if(tx.qty<0){
        const sellQty=Math.abs(tx.qty);
        const avgAtSale=qty>0?cost/qty:0;
        const pl=sellQty*(tx.price-avgAtSale)-tx.tax;
        txRealizedPL[k]=pl;
        if(qty>0)cost-=cost/qty*sellQty;
        qty-=sellQty;
      }
      runningAvgs[k]=qty>0?cost/qty:0;
    }
  }

  // Group by date, sort dates newest first
  const dateGroups={};
  for(const tx of txs){
    if(!dateGroups[tx.date])dateGroups[tx.date]=[];
    dateGroups[tx.date].push(tx);
  }
  const dates=Object.keys(dateGroups).sort((a,b)=>b.localeCompare(a));

  // Sort within each date by seq
  for(const date of dates){
    dateGroups[date].sort((a,b)=>(parseInt(a.seq)||0)-(parseInt(b.seq)||0));
  }

  let html=`<div class="tbl-wrap"><table class="t"><tr><th>ë‚ ì§œ</th><th>ì¦ê¶Œì‚¬</th><th>ì¢…ëª©</th><th>ë§¤ë§¤</th><th>ìˆ˜ëŸ‰</th><th>ë‹¨ê°€</th><th>ê¸ˆì•¡</th><th>ì‹¤í˜„</th></tr>`;

  for(const date of dates){
    const dTxs=dateGroups[date];
    html+=`<tr style="background:var(--surface2)"><td colspan="8" style="padding:8px;font-weight:600;color:var(--text)">${fmtDate(date)} <span style="font-weight:400;color:var(--text2);font-size:11px">(${dTxs.length}ê±´)</span></td></tr>`;

    for(const tx of dTxs){
      const cls=tx.qty>0?'c-buy':'c-sell';
      const side=tx.qty>0?'ë§¤ìˆ˜':'ë§¤ë„';
      const bk=tx.broker==='ì‚¼ì„±'?'ğŸ”µì‚¼ì„±':'ğŸ”´í‚¤ì›€';
      const amt=Math.abs(tx.qty)*tx.price;

      // Price with % from avg
      let priceStr=tx.price.toFixed(2);
      const k=`${tx.date}|${tx.seq}|${tx.broker}`;
      const avg=runningAvgs[k];
      if(ticker&&avg&&avg>0){
        const pctFromAvg=((tx.price-avg)/avg*100);
        const pctCls=pctFromAvg>=0?'c-buy':'c-sell';
        priceStr+=` <span class="${pctCls}" style="font-size:10px">(${pctFromAvg>=0?'+':''}${pctFromAvg.toFixed(1)}%)</span>`;
      }

      // Per-tx realized P/L (sells only)
      let plStr='';
      if(tx.qty<0&&txRealizedPL[k]!==undefined){
        const pl=txRealizedPL[k];
        const plC=pl>=0?'c-buy':'c-sell';
        plStr=`<span class="${plC}">${fmtUSD(pl)}</span>`;
      }

      html+=`<tr><td></td><td>${bk}</td><td><b style="cursor:pointer;color:#d0d4dc" onclick="event.stopPropagation();showHistory('${tx.ticker}')">${tx.ticker}</b></td><td class="${cls}">${side}</td><td class="${cls}">${tx.qty>0?'+':''}${tx.qty}</td><td>${priceStr}</td><td>${fmtUSD(amt)}</td><td>${plStr}</td></tr>`;
    }

    // Daily summary - indented to align with ë§¤ë§¤ column
    const buys=dTxs.filter(t=>t.qty>0);
    const sells=dTxs.filter(t=>t.qty<0);
    const buyQty=buys.reduce((s,t)=>s+t.qty,0);
    const sellQty=sells.reduce((s,t)=>s+Math.abs(t.qty),0);
    const buyAmt=buys.reduce((s,t)=>s+t.qty*t.price,0);
    const sellAmt=sells.reduce((s,t)=>s+Math.abs(t.qty)*t.price,0);
    const buyAvg=buyQty>0?(buyAmt/buyQty):0;
    const sellAvg=sellQty>0?(sellAmt/sellQty):0;
    // Sum realized P/L for the day
    let dayPL=0;
    for(const tx of dTxs){if(tx.qty<0){const k=`${tx.date}|${tx.seq}|${tx.broker}`;if(txRealizedPL[k]!==undefined)dayPL+=txRealizedPL[k]}}
    const dayPLStr=sells.length>0?`<span class="${dayPL>=0?'c-buy':'c-sell'}">${fmtUSD(dayPL)}</span>`:'';

    let sumParts=[];
    if(buyQty>0)sumParts.push(`<span class="c-buy">ë§¤ìˆ˜ ${buyQty}ì£¼ avg ${buyAvg.toFixed(2)} = ${fmtUSD(buyAmt)}</span>`);
    if(sellQty>0)sumParts.push(`<span class="c-sell">ë§¤ë„ ${sellQty}ì£¼ avg ${sellAvg.toFixed(2)} = ${fmtUSD(sellAmt)}</span>`);
    html+=`<tr style="background:var(--surface)"><td></td><td></td><td></td><td colspan="4" style="padding:6px 8px;font-size:11px;color:var(--text2)">${sumParts.join(' Â· ')}</td><td style="font-size:11px">${dayPLStr}</td></tr>`;
  }

  html+=`</table></div>`;
  el.innerHTML=html;
  switchTab('history');
}

// ================ IMPORT ================
function parseImportText(text){
  const lines=text.trim().split('\n');const groups=[];let cur=null;
  for(let line of lines){
    line=line.trim();if(!line)continue;
    if(line.startsWith('#')){const m=line.match(/^#\s*(ì‚¼ì„±|í‚¤ì›€)\s+(\d{6})/);if(m){cur={broker:m[1],date:m[2],rows:[]};groups.push(cur)}continue}
    if(!cur)continue;
    const p=line.split(',').map(s=>s.trim());
    if(p.length>=3){const tk=p[0].toUpperCase(),qty=parseInt(p[1]),pr=parseFloat(p[2]),seq=p[3]?parseInt(p[3]):cur.rows.length+1;
      if(tk&&!isNaN(qty)&&!isNaN(pr))cur.rows.push({ticker:tk,qty,price:pr,seq})}
  }
  return groups;
}
function previewImport(){
  const groups=parseImportText(document.getElementById('impText').value);
  const el=document.getElementById('impPreview');
  if(!groups.length){el.innerHTML='<p style="color:var(--sell);font-size:12px">íŒŒì‹± ì‹¤íŒ¨. í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.</p>';return}
  let html='';
  for(const g of groups){
    const rate=TAX[g.broker];
    html+=`<div class="dg"><span class="l" style="color:var(--${g.broker==='ì‚¼ì„±'?'samsung':'kiwoom'})">${g.broker} ${fmtDate(g.date)}</span><span class="r">${g.rows.length}ê±´</span></div>`;
    html+=`<div class="tbl-wrap"><table class="t"><tr><th>seq</th><th>ì¢…ëª©</th><th>ìˆ˜ëŸ‰</th><th>ë‹¨ê°€</th><th>tax</th><th>total</th></tr>`;
    for(const r of g.rows){
      const tax=rd(Math.abs(r.qty)*r.price*rate),total=rd(Math.abs(r.qty)*r.price+tax),cls=r.qty>0?'c-buy':'c-sell';
      html+=`<tr><td>${r.seq}</td><td><b>${r.ticker}</b></td><td class="${cls}">${r.qty>0?'+':''}${r.qty}</td><td>${r.price.toFixed(4)}</td><td>${tax.toFixed(2)}</td><td>${total.toFixed(2)}</td></tr>`;
    }
    html+='</table></div>';
  }
  el.innerHTML=html;
}
async function doImport(){
  const groups=parseImportText(document.getElementById('impText').value);
  if(!groups.length){toast('íŒŒì‹±ëœ ë°ì´í„° ì—†ìŒ','err');return}
  if(!SHEET_ID||!SA_KEY){toast('Sheets ì„¤ì • í•„ìš”','err');return}
  const logEl=document.getElementById('impLog');logEl.innerHTML='';
  for(const g of groups){
    const rate=TAX[g.broker];
    const rows=g.rows.map((r,i)=>{const tax=rd(Math.abs(r.qty)*r.price*rate),total=rd(Math.abs(r.qty)*r.price+tax);
      return[i===0?parseInt(g.date):'',r.ticker,r.qty,r.price,tax,total,'',r.seq]});
    try{await sheetsInsertAtTop(g.broker,rows);addLog(logEl,`âœ… ${g.broker} ${fmtDate(g.date)}: ${rows.length}ê±´ ì €ì¥`,'ok')}
    catch(e){addLog(logEl,`âŒ ${g.broker} ì‹¤íŒ¨: ${e.message}`,'err')}
  }
  toast('ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ! Dataë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.','ok');
}

// ================ MANUAL ================
async function addManual(){
  const broker=document.getElementById('mBk').value,date=document.getElementById('mDt').value.trim(),
    ticker=document.getElementById('mTk').value.trim().toUpperCase(),side=document.getElementById('mSd').value,
    qtyRaw=parseInt(document.getElementById('mQt').value),price=parseFloat(document.getElementById('mPr').value);
  if(!date||!ticker||!qtyRaw||!price){toast('ëª¨ë“  í•­ëª© ì…ë ¥ í•„ìš”','err');return}
  if(!SHEET_ID||!SA_KEY){toast('Sheets ì„¤ì • í•„ìš”','err');return}
  const qty=side==='sell'?-Math.abs(qtyRaw):Math.abs(qtyRaw);
  const rate=TAX[broker],tax=rd(Math.abs(qty)*price*rate),total=rd(Math.abs(qty)*price+tax);
  try{
    await sheetsInsertAtTop(broker,[[parseInt(date),ticker,qty,price,tax,total,'',1]]);
    toast(`${ticker} ${side==='buy'?'ë§¤ìˆ˜':'ë§¤ë„'} ì €ì¥ ì™„ë£Œ`,'ok');
    document.getElementById('mTk').value='';document.getElementById('mQt').value='';document.getElementById('mPr').value='';
  }catch(e){toast('ì €ì¥ ì‹¤íŒ¨: '+e.message,'err')}
}

// ================ DATA VIEW ================
async function loadFromSheet(){
  if(!SHEET_ID||!SA_KEY){toast('Sheets ì„¤ì • í•„ìš”','err');return}
  const view=document.getElementById('dataView');
  view.innerHTML='<p style="color:var(--text2);text-align:center;padding:16px"><span class="spinner"></span> ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
  await loadAllTransactions();
  let html='';
  for(const broker of['ì‚¼ì„±','í‚¤ì›€']){
    const txs=allTransactions.filter(t=>t.broker===broker);
    if(!txs.length)continue;
    html+=`<div class="card bk-card ${broker==='ì‚¼ì„±'?'ss':'kw'}">`;
    html+=`<div class="card-hdr"><span class="ico">${broker==='ì‚¼ì„±'?'ğŸ”µ':'ğŸ”´'}</span>${broker} (${txs.length}ê±´)</div>`;
    const dates=[...new Set(txs.map(t=>t.date))];
    for(const date of dates.slice(0,20)){
      const dTxs=txs.filter(t=>t.date===date);
      const buys=dTxs.filter(t=>t.qty>0).length,sells=dTxs.filter(t=>t.qty<0).length;
      html+=`<div class="dg"><span class="l">${fmtDate(date)}</span><span class="r">ë§¤ìˆ˜${buys}/ë§¤ë„${sells}/${dTxs.length}ê±´</span></div>`;
      html+=`<div class="tbl-wrap"><table class="t"><tr><th>seq</th><th>ì¢…ëª©</th><th>ìˆ˜ëŸ‰</th><th>ë‹¨ê°€</th><th>tax</th><th>total</th></tr>`;
      for(const t of dTxs){const cls=t.qty>0?'c-buy':'c-sell';
        html+=`<tr><td>${t.seq}</td><td><b>${t.ticker}</b></td><td class="${cls}">${t.qty>0?'+':''}${t.qty}</td><td>${t.price.toFixed(4)}</td><td>${t.tax.toFixed(2)}</td><td>${t.total.toFixed(2)}</td></tr>`}
      html+='</table></div>';
    }
    if(dates.length>20)html+=`<p style="color:var(--text2);font-size:11px;margin-top:8px">...ì™¸ ${dates.length-20}ì¼</p>`;
    html+='</div>';
  }
  view.innerHTML=html||'<p style="color:var(--text2);text-align:center;padding:32px">ë°ì´í„° ì—†ìŒ</p>';
}
async function downloadXlsx(){
  if(!SHEET_ID||!SA_KEY){toast('Sheets ì„¤ì • í•„ìš”','err');return}
  try{const wb=XLSX.utils.book_new();
    for(const b of['ì‚¼ì„±','í‚¤ì›€']){const d=await sheetsGet(`${b}!A:H`);const ws=XLSX.utils.aoa_to_sheet(d.values||[]);XLSX.utils.book_append_sheet(wb,ws,b)}
    XLSX.writeFile(wb,`ë¯¸êµ­ì£¼ì‹ë‚´ì—­_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.xlsx`);toast('ë‹¤ìš´ë¡œë“œ ì™„ë£Œ','ok');
  }catch(e){toast('ì‹¤íŒ¨: '+e.message,'err')}
}

// ================ HELPERS ================
function rd(n){return Math.round(n*100)/100}
function fmtDate(d){d=String(d);return d.length===6?`20${d.slice(0,2)}-${d.slice(2,4)}-${d.slice(4,6)}`:d}
function fmtUSD(n){return(n>=0?'':'-')+'$'+Math.abs(n).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}
function addLog(el,msg,cls=''){const d=document.createElement('div');d.className=cls;d.textContent=`[${new Date().toLocaleTimeString()}] ${msg}`;el.appendChild(d);el.scrollTop=el.scrollHeight}
function toast(msg,type='ok'){const el=document.getElementById('toast');el.textContent=msg;el.className=`toast ${type} show`;setTimeout(()=>el.classList.remove('show'),2800)}
</script>
</body>
</html>
